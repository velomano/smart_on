name: 영양액 레시피 자동 수집

on:
  schedule:
    - cron: '0 0 * * *'   # Asia/Seoul 오전 9시 = UTC 00시 (GitHub Actions는 UTC 기준)
  workflow_dispatch:
    inputs:
      source:
        description: '수집할 소스 (all, cornell, rda, fao, academic)'
        required: false
        default: 'all'
      batch_size:
        description: '배치 크기'
        required: false
        default: '10'

jobs:
  collect-recipes:
    runs-on: ubuntu-latest

    # 🔑 secrets와 inputs를 모두 env로 정리해서, 이후엔 $VAR 형태로만 사용
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_FN_URL: ${{ secrets.SUPABASE_FN_URL }}
      WORKER_URL: ${{ secrets.WORKER_URL }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SOURCE: ${{ github.event.inputs.source || 'all' }}
      BATCH_SIZE: ${{ github.event.inputs.batch_size || '10' }}

    steps:
      - name: 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            apps/web-admin/package-lock.json

      - name: 의존성 설치
        working-directory: apps/web-admin
        run: npm ci

      - name: 환경변수 파일(.env.local) 생성
        run: |
          mkdir -p apps/web-admin
          # 비어있을 수 있으니 안전한 기본값 제공
          echo "SUPABASE_URL=${SUPABASE_URL:-https://kkrcwdybrsppbsufrrdg.supabase.co}" >> apps/web-admin/.env.local
          echo "SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-test-key}" >> apps/web-admin/.env.local
          echo "SUPABASE_FN_URL=${SUPABASE_FN_URL:-https://kkrcwdybrsppbsufrrdg.supabase.co/functions/v1}" >> apps/web-admin/.env.local
          echo "WORKER_URL=${WORKER_URL:-http://localhost:3003}" >> apps/web-admin/.env.local

      - name: 영양액 레시피 수집 실행 (배치 처리)
        working-directory: apps/web-admin
        shell: bash
        run: |
          set -euo pipefail

          SUPA_URL="${SUPABASE_URL:-https://kkrcwdybrsppbsufrrdg.supabase.co}"
          SUPA_KEY="${SUPABASE_SERVICE_ROLE_KEY:-test-key}"
          WORKER="${WORKER_URL:-http://localhost:3003}"
          SRC="${SOURCE:-all}"
          BATCH="${BATCH_SIZE:-10}"

          echo "🚀 영양액 레시피 수집 시작 (소스: ${SRC}, 배치: ${BATCH})"

          # Node 20은 fetch 전역 지원
          node - << 'EOF'
          const { env } = process;

          const SUPA_URL = env.SUPABASE_URL || 'https://kkrcwdybrsppbsufrrdg.supabase.co';
          const SUPA_KEY = env.SUPABASE_SERVICE_ROLE_KEY || 'test-key';
          const WORKER   = env.WORKER_URL || 'http://localhost:3003';
          const SRC      = env.SOURCE || 'all';
          const BATCH    = parseInt(env.BATCH_SIZE || '10', 10);

          function parseCountFromContentRange(header) {
            // e.g. "0-0/123"
            if (!header) return 0;
            const m = header.match(/\/(\d+)$/);
            return m ? parseInt(m[1], 10) : 0;
          }

          async function getRecipeCount() {
            // 최소 데이터만 요청 + 정확한 카운트 요청
            const url = `${SUPA_URL}/rest/v1/crop_profiles?select=id`;
            const res = await fetch(url, {
              headers: {
                'apikey': SUPA_KEY,
                'Authorization': `Bearer ${SUPA_KEY}`,
                'Prefer': 'count=exact',
                'Range': '0-0'
              }
            });
            if (!res.ok) throw new Error(`Supabase count query failed: ${res.status}`);
            const contentRange = res.headers.get('Content-Range');
            return parseCountFromContentRange(contentRange);
          }

          // 간단한 양액 데이터 생성 (실제 구현에서는 외부 API 호출)
          async function collectNutrientData() {
            console.log(`📊 ${SRC} 소스에서 양액 데이터 수집 중...`);
            
            // 임시 데이터 생성 (실제로는 Cornell, FAO 등에서 수집)
            const sampleData = [
              {
                crop_key: 'lettuce',
                crop_name: '상추',
                stage: 'vegetative',
                target_ppm: 150,
                target_ec: 1.2,
                target_ph: 6.0,
                source: SRC,
                created_at: new Date().toISOString()
              },
              {
                crop_key: 'tomato',
                crop_name: '토마토',
                stage: 'fruiting',
                target_ppm: 250,
                target_ec: 2.0,
                target_ph: 6.5,
                source: SRC,
                created_at: new Date().toISOString()
              }
            ];
            
            console.log(`📊 생성된 샘플 데이터: ${sampleData.length}건`);
            return sampleData.slice(0, BATCH);
          }

          async function saveToSupabase(data) {
            if (!data || data.length === 0) return 0;
            
            console.log(`💾 ${data.length}건의 데이터를 Supabase에 저장 중...`);
            
            // crop_profiles 테이블에 저장
            const response = await fetch(`${SUPA_URL}/rest/v1/crop_profiles`, {
              method: 'POST',
              headers: {
                'apikey': SUPA_KEY,
                'Authorization': `Bearer ${SUPA_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'resolution=merge-duplicates'
              },
              body: JSON.stringify(data)
            });
            
            if (!response.ok) {
              throw new Error(`Supabase 저장 실패: ${response.status}`);
            }
            
            return data.length;
          }

          async function main() {
            try {
              const before = await getRecipeCount();
              console.log(`📊 기존 레시피 수: ${before}건`);

              const collectedData = await collectNutrientData();
              console.log(`📊 수집된 데이터: ${collectedData.length}건`);

              const savedCount = await saveToSupabase(collectedData);
              console.log(`✅ Supabase 저장 완료: ${savedCount}건`);

              const after = await getRecipeCount();
              console.log(`📊 최종 레시피 수: ${after}건`);
              console.log(`💾 추가된 레시피: ${Math.max(after - before, 0)}건`);
              console.log('🎉 영양액 레시피 수집 작업 완료');
            } catch (err) {
              console.error('❌ 수집 작업 실패:', err?.message || err);
              process.exit(1);
            }
          }

          main();
          EOF

      - name: 수집 결과 알림 (선택사항)
        # secrets를 if에서 직접 쓰지 말고, env 값을 기준으로 체크
        if: ${{ always() && env.SLACK_WEBHOOK_URL != '' }}
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            영양액 레시피 수집 작업 완료
            상태: ${{ job.status }}
            소스: ${{ env.SOURCE }}
            트리거: ${{ github.event_name }}
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK_URL }}
