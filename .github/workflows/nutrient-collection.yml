name: ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìë™ ìˆ˜ì§‘

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 3ì‹œ (KST) ì‹¤í–‰ - ì†ŒëŸ‰ì”© ìˆ˜ì§‘
    - cron: '0 18 * * *'  # UTC ê¸°ì¤€ (KST -9ì‹œê°„)
  
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      source:
        description: 'ìˆ˜ì§‘í•  ì†ŒìŠ¤ ì„ íƒ'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - cornell
          - rda
          - fao
          - academic
      batch_size:
        description: 'ë°°ì¹˜ í¬ê¸° (ê¸°ë³¸ 10ê°œ)'
        required: false
        default: '10'
        type: string

jobs:
  collect-nutrient-recipes:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd apps/web-admin
        npm ci
        
    - name: í™˜ê²½ë³€ìˆ˜ ì„¤ì •
      run: |
        echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> apps/web-admin/.env.local
        echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> apps/web-admin/.env.local
        echo "SUPABASE_FN_URL=${{ secrets.SUPABASE_FN_URL }}" >> apps/web-admin/.env.local
        echo "WORKER_URL=${{ secrets.WORKER_URL }}" >> apps/web-admin/.env.local
        
    - name: ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìˆ˜ì§‘ ì‹¤í–‰ (ë°°ì¹˜ ì²˜ë¦¬)
      run: |
        cd apps/web-admin
        node -e "
        const fetch = require('node-fetch');
        
        async function collectRecipesBatch() {
          try {
            const batchSize = parseInt('${{ github.event.inputs.batch_size || '10' }}');
            const source = '${{ github.event.inputs.source || 'all' }}';
            
            console.log(\`ğŸš€ ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ë°°ì¹˜ ìˆ˜ì§‘ ì‹œì‘ (ì†ŒìŠ¤: \${source}, ë°°ì¹˜í¬ê¸°: \${batchSize})\`);
            
            // 1. ê¸°ì¡´ ë ˆì‹œí”¼ ìˆ˜ í™•ì¸
            const existingResponse = await fetch('${{ secrets.SUPABASE_URL }}/rest/v1/crop_profiles?select=count', {
              headers: {
                'apikey': '${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}',
                'Authorization': \`Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}\`
              }
            });
            
            const existingCount = await existingResponse.json();
            console.log(\`ğŸ“Š ê¸°ì¡´ ë ˆì‹œí”¼ ìˆ˜: \${existingCount.length}ê±´\`);
            
            // 2. ì›Œì»¤ì—ì„œ ë ˆì‹œí”¼ ìˆ˜ì§‘ (ì›Œì»¤ê°€ ì§ì ‘ Supabaseì— ì €ì¥)
            const response = await fetch(\`${{ secrets.WORKER_URL }}/sources/\${source}\`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ batch_size: batchSize })
            });
            
            if (!response.ok) {
              throw new Error(\`ì›Œì»¤ ì‘ë‹µ ì‹¤íŒ¨: \${response.status}\`);
            }
            
            const data = await response.json();
            console.log(\`âœ… ìˆ˜ì§‘ ì™„ë£Œ: \${data.count || 0}ê±´\`);
            
            // 3. ìµœì¢… ë ˆì‹œí”¼ ìˆ˜ í™•ì¸
            const finalResponse = await fetch('${{ secrets.SUPABASE_URL }}/rest/v1/crop_profiles?select=count', {
              headers: {
                'apikey': '${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}',
                'Authorization': \`Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}\`
              }
            });
            
            const finalCount = await finalResponse.json();
            const addedCount = finalCount.length - existingCount.length;
            console.log(\`ğŸ’¾ ì¶”ê°€ëœ ë ˆì‹œí”¼: \${addedCount}ê±´\`);
            
            console.log('ğŸ‰ ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ë°°ì¹˜ ìˆ˜ì§‘ ì™„ë£Œ!');
            
          } catch (error) {
            console.error('âŒ ìˆ˜ì§‘ ì‹¤íŒ¨:', error.message);
            process.exit(1);
          }
        }
        
        collectRecipesBatch();
        "
        
    - name: ìˆ˜ì§‘ ê²°ê³¼ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      if: always() && secrets.SLACK_WEBHOOK_URL != ''
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: |
          ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìˆ˜ì§‘ ì‘ì—… ì™„ë£Œ
          ìƒíƒœ: ${{ job.status }}
          ì†ŒìŠ¤: ${{ github.event.inputs.source || 'all' }}
          ì‹œê°„: ${{ github.event.schedule || 'ìˆ˜ë™ ì‹¤í–‰' }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
