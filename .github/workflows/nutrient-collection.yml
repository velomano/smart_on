name: ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìë™ ìˆ˜ì§‘

on:
  schedule:
    - cron: '0 0 * * *'   # Asia/Seoul ì˜¤ì „ 9ì‹œ = UTC 00ì‹œ (GitHub ActionsëŠ” UTC ê¸°ì¤€)
  workflow_dispatch:
    inputs:
      source:
        description: 'ìˆ˜ì§‘í•  ì†ŒìŠ¤ (all, cornell, rda, fao, academic)'
        required: false
        default: 'all'
      batch_size:
        description: 'ë°°ì¹˜ í¬ê¸°'
        required: false
        default: '10'

jobs:
  collect-recipes:
    runs-on: ubuntu-latest

    # ğŸ”‘ secretsì™€ inputsë¥¼ ëª¨ë‘ envë¡œ ì •ë¦¬í•´ì„œ, ì´í›„ì—” $VAR í˜•íƒœë¡œë§Œ ì‚¬ìš©
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_FN_URL: ${{ secrets.SUPABASE_FN_URL }}
      WORKER_URL: ${{ secrets.WORKER_URL }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SOURCE: ${{ github.event.inputs.source || 'all' }}
      BATCH_SIZE: ${{ github.event.inputs.batch_size || '10' }}

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            apps/web-admin/package-lock.json

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: apps/web-admin
        run: npm ci

      - name: í™˜ê²½ë³€ìˆ˜ íŒŒì¼(.env.local) ìƒì„±
        run: |
          mkdir -p apps/web-admin
          # ë¹„ì–´ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì•ˆì „í•œ ê¸°ë³¸ê°’ ì œê³µ
          echo "SUPABASE_URL=${SUPABASE_URL:-https://kkrcwdybrsppbsufrrdg.supabase.co}" >> apps/web-admin/.env.local
          echo "SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-test-key}" >> apps/web-admin/.env.local
          echo "SUPABASE_FN_URL=${SUPABASE_FN_URL:-https://kkrcwdybrsppbsufrrdg.supabase.co/functions/v1}" >> apps/web-admin/.env.local
          echo "WORKER_URL=${WORKER_URL:-http://localhost:3003}" >> apps/web-admin/.env.local

      - name: ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìˆ˜ì§‘ ì‹¤í–‰ (ë°°ì¹˜ ì²˜ë¦¬)
        working-directory: apps/web-admin
        shell: bash
        run: |
          set -euo pipefail

          SUPA_URL="${SUPABASE_URL:-https://kkrcwdybrsppbsufrrdg.supabase.co}"
          SUPA_KEY="${SUPABASE_SERVICE_ROLE_KEY:-test-key}"
          WORKER="${WORKER_URL:-http://localhost:3003}"
          SRC="${SOURCE:-all}"
          BATCH="${BATCH_SIZE:-10}"

          echo "ğŸš€ ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìˆ˜ì§‘ ì‹œì‘ (ì†ŒìŠ¤: ${SRC}, ë°°ì¹˜: ${BATCH})"

          # Node 20ì€ fetch ì „ì—­ ì§€ì›
          node - << 'EOF'
          const { env } = process;

          const SUPA_URL = env.SUPABASE_URL || 'https://kkrcwdybrsppbsufrrdg.supabase.co';
          const SUPA_KEY = env.SUPABASE_SERVICE_ROLE_KEY || 'test-key';
          const WORKER   = env.WORKER_URL || 'http://localhost:3003';
          const SRC      = env.SOURCE || 'all';
          const BATCH    = parseInt(env.BATCH_SIZE || '10', 10);

          function parseCountFromContentRange(header) {
            // e.g. "0-0/123"
            if (!header) return 0;
            const m = header.match(/\/(\d+)$/);
            return m ? parseInt(m[1], 10) : 0;
          }

          async function getRecipeCount() {
            // ìµœì†Œ ë°ì´í„°ë§Œ ìš”ì²­ + ì •í™•í•œ ì¹´ìš´íŠ¸ ìš”ì²­
            const url = `${SUPA_URL}/rest/v1/crop_profiles?select=id`;
            const res = await fetch(url, {
              headers: {
                'apikey': SUPA_KEY,
                'Authorization': `Bearer ${SUPA_KEY}`,
                'Prefer': 'count=exact',
                'Range': '0-0'
              }
            });
            if (!res.ok) throw new Error(`Supabase count query failed: ${res.status}`);
            const contentRange = res.headers.get('Content-Range');
            return parseCountFromContentRange(contentRange);
          }

          // ê°„ë‹¨í•œ ì–‘ì•¡ ë°ì´í„° ìƒì„± (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì™¸ë¶€ API í˜¸ì¶œ)
          async function collectNutrientData() {
            console.log(`ğŸ“Š ${SRC} ì†ŒìŠ¤ì—ì„œ ì–‘ì•¡ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...`);
            
            // ì„ì‹œ ë°ì´í„° ìƒì„± (ì‹¤ì œë¡œëŠ” Cornell, FAO ë“±ì—ì„œ ìˆ˜ì§‘)
            const sampleData = [
              {
                crop_key: 'lettuce',
                crop_name: 'ìƒì¶”',
                stage: 'vegetative',
                target_ppm: 150,
                target_ec: 1.2,
                target_ph: 6.0
              },
              {
                crop_key: 'tomato',
                crop_name: 'í† ë§ˆí† ',
                stage: 'fruiting',
                target_ppm: 250,
                target_ec: 2.0,
                target_ph: 6.5
              }
            ];
            
            console.log(`ğŸ“Š ìƒì„±ëœ ìƒ˜í”Œ ë°ì´í„°: ${sampleData.length}ê±´`);
            return sampleData.slice(0, BATCH);
          }

          async function saveToSupabase(data) {
            if (!data || data.length === 0) return 0;
            
            console.log(`ğŸ’¾ ${data.length}ê±´ì˜ ë°ì´í„°ë¥¼ Supabaseì— ì €ì¥ ì¤‘...`);
            
            // crop_profiles í…Œì´ë¸”ì— ì €ì¥
            const response = await fetch(`${SUPA_URL}/rest/v1/crop_profiles`, {
              method: 'POST',
              headers: {
                'apikey': SUPA_KEY,
                'Authorization': `Bearer ${SUPA_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'resolution=merge-duplicates'
              },
              body: JSON.stringify(data)
            });
            
            if (!response.ok) {
              throw new Error(`Supabase ì €ì¥ ì‹¤íŒ¨: ${response.status}`);
            }
            
            return data.length;
          }

          async function main() {
            try {
              const before = await getRecipeCount();
              console.log(`ğŸ“Š ê¸°ì¡´ ë ˆì‹œí”¼ ìˆ˜: ${before}ê±´`);

              const collectedData = await collectNutrientData();
              console.log(`ğŸ“Š ìˆ˜ì§‘ëœ ë°ì´í„°: ${collectedData.length}ê±´`);

              const savedCount = await saveToSupabase(collectedData);
              console.log(`âœ… Supabase ì €ì¥ ì™„ë£Œ: ${savedCount}ê±´`);

              const after = await getRecipeCount();
              console.log(`ğŸ“Š ìµœì¢… ë ˆì‹œí”¼ ìˆ˜: ${after}ê±´`);
              console.log(`ğŸ’¾ ì¶”ê°€ëœ ë ˆì‹œí”¼: ${Math.max(after - before, 0)}ê±´`);
              console.log('ğŸ‰ ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìˆ˜ì§‘ ì‘ì—… ì™„ë£Œ');
          
          // í…”ë ˆê·¸ë¨ ì•Œë¦¼ì„ ìœ„í•œ ìˆ˜ì§‘ ì •ë³´ íŒŒì¼ ì €ì¥
          const collectionInfo = {
            before_count: before,
            collected_count: collectedData.length,
            saved_count: savedCount,
            after_count: after,
            added_count: Math.max(after - before, 0),
            source: SRC,
            batch_size: BATCH,
            timestamp: new Date().toISOString()
          };
          
          require('fs').writeFileSync('/tmp/collection_info.json', JSON.stringify(collectionInfo, null, 2));
        } catch (err) {
          console.error('âŒ ìˆ˜ì§‘ ì‘ì—… ì‹¤íŒ¨:', err?.message || err);
          
          // ì‹¤íŒ¨ ì •ë³´ë„ íŒŒì¼ë¡œ ì €ì¥
          const errorInfo = {
            error: err?.message || 'Unknown error',
            source: SRC,
            batch_size: BATCH,
            timestamp: new Date().toISOString()
          };
          
          require('fs').writeFileSync('/tmp/collection_info.json', JSON.stringify(errorInfo, null, 2));
          process.exit(1);
        }
      }

      main();
      EOF

      - name: ìˆ˜ì§‘ ê²°ê³¼ í…”ë ˆê·¸ë¨ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
        # í…”ë ˆê·¸ë¨ ë´‡ í† í°ì´ ì„¤ì •ë˜ì–´ ìˆì„ ë•Œë§Œ ì•Œë¦¼ ì „ì†¡
        if: ${{ always() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != '' }}
        run: |
          set -euo pipefail
          
          STATUS="${{ job.status }}"
          SOURCE="${{ env.SOURCE }}"
          TRIGGER="${{ github.event_name }}"
          
          # ì´ì „ ë‹¨ê³„ì—ì„œ ìˆ˜ì§‘ëœ ë°ì´í„° ì •ë³´ ì¶”ì¶œ
          if [ -f "/tmp/collection_info.json" ]; then
            COLLECTED_COUNT=$(jq -r '.collected_count // 0' /tmp/collection_info.json)
            SAVED_COUNT=$(jq -r '.saved_count // 0' /tmp/collection_info.json)
            BEFORE_COUNT=$(jq -r '.before_count // 0' /tmp/collection_info.json)
            AFTER_COUNT=$(jq -r '.after_count // 0' /tmp/collection_info.json)
            ADDED_COUNT=$(jq -r '.added_count // 0' /tmp/collection_info.json)
          else
            COLLECTED_COUNT="0"
            SAVED_COUNT="0"
            BEFORE_COUNT="0"
            AFTER_COUNT="0"
            ADDED_COUNT="0"
          fi
          
          if [ "$STATUS" = "success" ]; then
            ICON="âœ…"
            MESSAGE="ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìˆ˜ì§‘ ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          else
            ICON="âŒ"
            MESSAGE="ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìˆ˜ì§‘ ì‘ì—…ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          fi
          
          FULL_MESSAGE="$ICON <b>TeraHub ì–‘ì•¡ ìˆ˜ì§‘ ì•Œë¦¼</b>

          ğŸ“Š <b>ì‘ì—… ìƒíƒœ</b>: $STATUS
          ğŸŒ± <b>ìˆ˜ì§‘ ì†ŒìŠ¤</b>: $SOURCE
          â° <b>ì‹¤í–‰ ì‹œê°„</b>: $(date '+%Y-%m-%d %H:%M:%S')
          ğŸ”„ <b>íŠ¸ë¦¬ê±°</b>: $TRIGGER
          
          ğŸ“ˆ <b>ìˆ˜ì§‘ ìƒì„¸ ì •ë³´</b>:
          â€¢ ê¸°ì¡´ ë ˆì‹œí”¼: ${BEFORE_COUNT}ê±´
          â€¢ ìƒˆë¡œ ìˆ˜ì§‘: ${COLLECTED_COUNT}ê±´
          â€¢ ì €ì¥ ì™„ë£Œ: ${SAVED_COUNT}ê±´
          â€¢ ìµœì¢… ë ˆì‹œí”¼: ${AFTER_COUNT}ê±´
          â€¢ ìˆœì¦ê°€: ${ADDED_COUNT}ê±´
          
          $MESSAGE"
          
          curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ env.TELEGRAM_CHAT_ID }}\",
              \"text\": \"$FULL_MESSAGE\",
              \"parse_mode\": \"HTML\"
            }"
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
