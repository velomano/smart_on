name: ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìë™ ìˆ˜ì§‘ (ì„¸ë¶€)

on:
  schedule:
    - cron: '0 0 * * *'   # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST)
  workflow_dispatch:
    inputs:
      source:
        description: 'ìˆ˜ì§‘í•  ì†ŒìŠ¤ (all, cornell, rda, fao, academic)'
        required: false
        default: 'all'
        type: string
      batch_size:
        description: 'ë°°ì¹˜ í¬ê¸°'
        required: false
        default: '10'
        type: string

jobs:
  collect-recipes:
    runs-on: ubuntu-latest

    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      SOURCE: ${{ inputs.source || 'all' }}
      BATCH_SIZE: ${{ inputs.batch_size || '10' }}

    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìˆ˜ì§‘ ì‹¤í–‰ (ë°°ì¹˜ ì²˜ë¦¬)
      run: |
        set -euo pipefail
        
        SUPA_URL="${SUPABASE_URL:-***}"
        SUPA_KEY="${SUPABASE_SERVICE_ROLE_KEY:-test-key}"
        SRC="${SOURCE:-all}"
        BATCH="${BATCH_SIZE:-10}"
        
        echo "ğŸš€ ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìˆ˜ì§‘ ì‹œì‘ (ì†ŒìŠ¤: ${SRC}, ë°°ì¹˜: ${BATCH})"
        
        node - << 'EOF'
        const { env } = process;
        
        const SUPA_URL = env.SUPABASE_URL || '***';
        const SUPA_KEY = env.SUPABASE_SERVICE_ROLE_KEY || 'test-key';
        const SRC      = env.SOURCE || 'all';
        const BATCH    = parseInt(env.BATCH_SIZE || '10', 10);
        
        function parseCountFromContentRange(header) {
          if (!header) return 0;
          const m = header.match(/\/(\d+)$/);
          return m ? parseInt(m[1], 10) : 0;
        }
        
        async function getRecipeCount() {
          const url = `${SUPA_URL}/rest/v1/crop_profiles?select=id`;
          const res = await fetch(url, {
            headers: {
              'apikey': SUPA_KEY,
              'Authorization': `Bearer ${SUPA_KEY}`,
              'Prefer': 'count=exact',
              'Range': '0-0'
            }
          });
          if (!res.ok) throw new Error(`Supabase count query failed: ${res.status}`);
          const contentRange = res.headers.get('Content-Range');
          return parseCountFromContentRange(contentRange);
        }
        
        async function collectNutrientData() {
          console.log(`ğŸ“Š ${SRC} ì†ŒìŠ¤ì—ì„œ ì–‘ì•¡ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...`);
          
          const sampleData = [
            {
              crop_key: 'lettuce',
              crop_name: 'ìƒì¶”',
              stage: 'vegetative',
              target_ppm: 150,
              target_ec: 1.2,
              target_ph: 6.0
            },
            {
              crop_key: 'tomato',
              crop_name: 'í† ë§ˆí† ',
              stage: 'fruiting',
              target_ppm: 250,
              target_ec: 2.0,
              target_ph: 6.5
            },
            {
              crop_key: 'cucumber',
              crop_name: 'ì˜¤ì´',
              stage: 'flowering',
              target_ppm: 200,
              target_ec: 1.8,
              target_ph: 6.2
            }
          ];
          
          console.log(`ğŸ“Š ìƒì„±ëœ ìƒ˜í”Œ ë°ì´í„°: ${sampleData.length}ê±´`);
          return sampleData.slice(0, BATCH);
        }
        
        async function saveToSupabase(data) {
          if (!data || data.length === 0) return 0;
          
          console.log(`ğŸ’¾ ${data.length}ê±´ì˜ ë°ì´í„°ë¥¼ Supabaseì— ì €ì¥ ì¤‘...`);
          
          const response = await fetch(`${SUPA_URL}/rest/v1/crop_profiles`, {
            method: 'POST',
            headers: {
              'apikey': SUPA_KEY,
              'Authorization': `Bearer ${SUPA_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'resolution=merge-duplicates'
            },
            body: JSON.stringify(data)
          });
          
          if (!response.ok) {
            throw new Error(`Supabase ì €ì¥ ì‹¤íŒ¨: ${response.status}`);
          }
          
          return data.length;
        }
        
        async function main() {
          try {
            const before = await getRecipeCount();
            console.log(`ğŸ“Š ê¸°ì¡´ ë ˆì‹œí”¼ ìˆ˜: ${before}ê±´`);
        
            const collectedData = await collectNutrientData();
            console.log(`ğŸ“Š ìˆ˜ì§‘ëœ ë°ì´í„°: ${collectedData.length}ê±´`);
        
            const savedCount = await saveToSupabase(collectedData);
            console.log(`âœ… Supabase ì €ì¥ ì™„ë£Œ: ${savedCount}ê±´`);
        
            const after = await getRecipeCount();
            console.log(`ğŸ“Š ìµœì¢… ë ˆì‹œí”¼ ìˆ˜: ${after}ê±´`);
            console.log(`ğŸ’¾ ì¶”ê°€ëœ ë ˆì‹œí”¼: ${Math.max(after - before, 0)}ê±´`);
            console.log('ğŸ‰ ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìˆ˜ì§‘ ì‘ì—… ì™„ë£Œ');
            
            // í…”ë ˆê·¸ë¨ ì•Œë¦¼ì„ ìœ„í•œ ìˆ˜ì§‘ ì •ë³´ íŒŒì¼ ì €ì¥
            const collectionInfo = {
              before_count: before,
              collected_count: collectedData.length,
              saved_count: savedCount,
              after_count: after,
              added_count: Math.max(after - before, 0),
              source: SRC,
              batch_size: BATCH,
              timestamp: new Date().toISOString()
            };
            
            require('fs').writeFileSync('/tmp/collection_info.json', JSON.stringify(collectionInfo, null, 2));
          } catch (err) {
            console.error('âŒ ìˆ˜ì§‘ ì‘ì—… ì‹¤íŒ¨:', err?.message || err);
            
            // ì‹¤íŒ¨ ì •ë³´ë„ íŒŒì¼ë¡œ ì €ì¥
            const errorInfo = {
              error: err?.message || 'Unknown error',
              source: SRC,
              batch_size: BATCH,
              timestamp: new Date().toISOString()
            };
            
            require('fs').writeFileSync('/tmp/collection_info.json', JSON.stringify(errorInfo, null, 2));
            process.exit(1);
          }
        }
        
        main();
        EOF

    - name: ìˆ˜ì§‘ ê²°ê³¼ í…”ë ˆê·¸ë¨ ì•Œë¦¼ (ì„¸ë¶€ ì •ë³´)
      if: always() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
      run: |
        STATUS="${{ job.status }}"
        SOURCE="${{ env.SOURCE }}"
        TRIGGER="${{ github.event_name }}"
        
        # ì´ì „ ë‹¨ê³„ì—ì„œ ìˆ˜ì§‘ëœ ë°ì´í„° ì •ë³´ ì¶”ì¶œ
        if [ -f "/tmp/collection_info.json" ]; then
          COLLECTED_COUNT=$(jq -r '.collected_count // 0' /tmp/collection_info.json)
          SAVED_COUNT=$(jq -r '.saved_count // 0' /tmp/collection_info.json)
          BEFORE_COUNT=$(jq -r '.before_count // 0' /tmp/collection_info.json)
          AFTER_COUNT=$(jq -r '.after_count // 0' /tmp/collection_info.json)
          ADDED_COUNT=$(jq -r '.added_count // 0' /tmp/collection_info.json)
        else
          COLLECTED_COUNT="0"
          SAVED_COUNT="0"
          BEFORE_COUNT="0"
          AFTER_COUNT="0"
          ADDED_COUNT="0"
        fi
        
        if [ "$STATUS" = "success" ]; then
          ICON="âœ…"
          MESSAGE="ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìˆ˜ì§‘ ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        else
          ICON="âŒ"
          MESSAGE="ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìˆ˜ì§‘ ì‘ì—…ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        fi
        
        FULL_MESSAGE="$ICON <b>TeraHub ì–‘ì•¡ ìˆ˜ì§‘ ì•Œë¦¼ (ì„¸ë¶€)</b>

        ğŸ“Š <b>ì‘ì—… ìƒíƒœ</b>: $STATUS
        ğŸŒ± <b>ìˆ˜ì§‘ ì†ŒìŠ¤</b>: $SOURCE
        â° <b>ì‹¤í–‰ ì‹œê°„</b>: $(date '+%Y-%m-%d %H:%M:%S')
        ğŸ”„ <b>íŠ¸ë¦¬ê±°</b>: $TRIGGER
        
        ğŸ“ˆ <b>ìˆ˜ì§‘ ìƒì„¸ ì •ë³´</b>:
        â€¢ ê¸°ì¡´ ë ˆì‹œí”¼: ${BEFORE_COUNT}ê±´
        â€¢ ìƒˆë¡œ ìˆ˜ì§‘: ${COLLECTED_COUNT}ê±´
        â€¢ ì €ì¥ ì™„ë£Œ: ${SAVED_COUNT}ê±´
        â€¢ ìµœì¢… ë ˆì‹œí”¼: ${AFTER_COUNT}ê±´
        â€¢ ìˆœì¦ê°€: ${ADDED_COUNT}ê±´
        
        $MESSAGE"
        
        curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ env.TELEGRAM_CHAT_ID }}\",
            \"text\": \"$FULL_MESSAGE\",
            \"parse_mode\": \"HTML\"
          }"
