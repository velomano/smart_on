name: ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìë™ ìˆ˜ì§‘ (ì„¸ë¶€)

on:
  schedule:
    - cron: '0 */6 * * *'   # 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (00:00, 06:00, 12:00, 18:00)
  workflow_dispatch:
    inputs:
      source:
        description: 'ìˆ˜ì§‘í•  ì†ŒìŠ¤ (all, cornell, rda, fao, academic)'
        required: false
        default: 'all'
        type: string
      batch_size:
        description: 'ë°°ì¹˜ í¬ê¸°'
        required: false
        default: '50'
        type: string

jobs:
  collect-recipes:
    runs-on: ubuntu-latest

    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      SOURCE: ${{ inputs.source || 'all' }}
      BATCH_SIZE: ${{ inputs.batch_size || '10' }}

    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd apps/worker
        npm install

    - name: TypeScript ì»´íŒŒì¼
      run: |
        cd apps/worker
        npm run build

    - name: ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìˆ˜ì§‘ ë° crop_profiles ì €ì¥
      id: collect-recipes
      run: |
        set -euo pipefail
        
        cd apps/worker
        
        SUPA_URL="${SUPABASE_URL:-***}"
        SUPA_KEY="${SUPABASE_SERVICE_ROLE_KEY:-test-key}"
        SRC="${SOURCE:-all}"
        BATCH="${BATCH_SIZE:-10}"
        
        echo "ğŸš€ ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìˆ˜ì§‘ ì‹œì‘ (ì†ŒìŠ¤: ${SRC}, ë°°ì¹˜: ${BATCH})"
        
        # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        export SUPABASE_URL="$SUPA_URL"
        export SUPABASE_SERVICE_ROLE_KEY="$SUPA_KEY"
        
        # ì‹¤ì œ ìˆ˜ì§‘ ë° nutrient_recipes ì§ì ‘ ì €ì¥
        node -e "
        const { collectAllRecipes } = require('./dist/sources/all.js');
        
        async function main() {
          try {
            console.log('ğŸŒ± ì‹¤ì œ ìˆ˜ì§‘ ì‹œì‘...');
            const recipes = await collectAllRecipes($BATCH);
            console.log(\`ğŸ“Š ìˆ˜ì§‘ ì™„ë£Œ: \${recipes.length}ê±´\`);
            
            // ìˆ˜ì§‘ ê±´ìˆ˜ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì • (í…”ë ˆê·¸ë¨ ì•Œë¦¼ìš©)
            process.env.COLLECTED_COUNT = recipes.length.toString();
            
            // nutrient_recipes í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì§ì ‘ ì €ì¥
            let savedCount = 0;
            for (const recipe of recipes) {
              const source = recipe.source;
              
              // macro/micro ë°ì´í„°ë¥¼ target_ppm í˜•ì‹ìœ¼ë¡œ ë³€í™˜
              const targetPpm = {
                N: recipe.macro?.N || 0,
                P: recipe.macro?.P || 0,
                K: recipe.macro?.K || 0,
                Ca: recipe.macro?.Ca || 0,
                Mg: recipe.macro?.Mg || 0,
                S: recipe.macro?.S || 0
              };
              
              // NPK ë¹„ìœ¨ ê³„ì‚°
              const npkRatio = \`\${targetPpm.N}:\${targetPpm.P}:\${targetPpm.K}\`;
              
              // í™˜ê²½ ì¡°ê±´ ì •ë³´ ìƒì„±
              const growingConditions = {
                temperature: \`\${recipe.env?.temp || 20}Â°C\`,
                humidity: \`\${recipe.env?.humidity || 65}%\`,
                light_hours: \`\${Math.round((recipe.env?.lux || 15000) / 1000)}ì‹œê°„\`,
                co2_level: '800-1200ppm'
              };
              
              // ì˜ì–‘ì†Œ ìƒì„¸ ì •ë³´ ìƒì„±
              const nutrientsDetail = {
                nitrogen: targetPpm.N,
                phosphorus: targetPpm.P,
                potassium: targetPpm.K,
                calcium: targetPpm.Ca,
                magnesium: targetPpm.Mg,
                trace_elements: ['Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo']
              };
              
              // ì‚¬ìš©ë²• ë° ì£¼ì˜ì‚¬í•­
              const usageNotes = [
                'ì£¼ 1íšŒ EC ì¸¡ì • ê¶Œì¥',
                'pHëŠ” 6.0-6.5 ë²”ìœ„ ìœ ì§€',
                'ì˜¨ë„ê°€ ë†’ì„ ë•ŒëŠ” ECë¥¼ ë‚®ì¶° ì‚¬ìš©'
              ];
              
              const warnings = [
                'ì¹¼ìŠ˜ ê²°í• ì‹œ ì ë ê°ˆë³€ í˜„ìƒ',
                'ê³¼ë„í•œ ì§ˆì†ŒëŠ” ê³¼ë²ˆë¬´ ìœ ë°œ'
              ];
              
              // nutrient_recipes í˜•ì‹ìœ¼ë¡œ ë³€í™˜
              const micro = {
                Fe: recipe.micro?.Fe || 2,
                Mn: recipe.micro?.Mn || 0.5,
                B: recipe.micro?.B || 0.5,
                Zn: recipe.micro?.Zn || 0.1,
                Cu: recipe.micro?.Cu || 0.05,
                Mo: recipe.micro?.Mo || 0.05
              };
              
              const nutrientRecipe = {
                crop_key: recipe.crop_key,
                stage: recipe.stage,
                target_ec: recipe.target_ec,
                target_ph: recipe.target_ph,
                macro: targetPpm,
                micro: micro,
                source_id: null, // source_idëŠ” ë³„ë„ë¡œ ì²˜ë¦¬ í•„ìš”
                reliability: source?.reliability_default || 0.7,
                checksum: \`\${recipe.crop_key}_\${recipe.stage}_\${source?.name || 'unknown'}_\${Date.now()}_\${Math.random().toString(36).substr(2, 9)}\`
              };
              
              // nutrient_recipesì— ì§ì ‘ ì €ì¥ (ìë™ ìˆ˜ì§‘ìš©)
              const res = await fetch(process.env.SUPABASE_URL + '/rest/v1/nutrient_recipes', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'apikey': process.env.SUPABASE_SERVICE_ROLE_KEY,
                  'Authorization': \`Bearer \${process.env.SUPABASE_SERVICE_ROLE_KEY}\`,
                  'Prefer': 'resolution=merge-duplicates'
                },
                body: JSON.stringify(nutrientRecipe)
              });
              
              if (res.ok) {
                savedCount++;
                console.log(\`âœ… ì €ì¥ ì™„ë£Œ: \${recipe.crop_name} (\${recipe.stage}) - \${source?.name || 'Unknown'}\`);
              } else {
                const errorText = await res.text();
                console.error(\`âŒ ì €ì¥ ì‹¤íŒ¨: \${recipe.crop_name}\`, errorText);
              }
            }
            
            console.log(\`ğŸ‰ ì €ì¥ ì™„ë£Œ: \${savedCount}/\${recipes.length}ê±´\`);
            
            // ì €ì¥ ê±´ìˆ˜ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì • (í…”ë ˆê·¸ë¨ ì•Œë¦¼ìš©)
            process.env.SAVED_COUNT = savedCount.toString();
            process.env.TOTAL_COUNT = recipes.length.toString();
            
            // ìˆ˜ì§‘ í†µê³„ ì¶œë ¥
            const sourceStats = recipes.reduce((acc, recipe) => {
              const sourceName = recipe.source?.name || 'Unknown';
              acc[sourceName] = (acc[sourceName] || 0) + 1;
              return acc;
            }, {});
            
            console.log('ğŸ“ˆ ìˆ˜ì§‘ í†µê³„:');
            Object.entries(sourceStats).forEach(([source, count]) => {
              console.log(\`  - \${source}: \${count}ê±´\`);
            });
            
            // GitHub Actions ì¶œë ¥ ì„¤ì •
            console.log(\`::set-output name=collected_count::\${recipes.length}\`);
            console.log(\`::set-output name=saved_count::\${savedCount}\`);
            
          } catch (error) {
            console.error('ğŸ’¥ ìˆ˜ì§‘ ì‹¤íŒ¨:', error);
            process.exit(1);
          }
        }
        
        main();
        "

    - name: ìˆ˜ì§‘ ê²°ê³¼ í…”ë ˆê·¸ë¨ ì•Œë¦¼
      if: always() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
      run: |
        STATUS="${{ job.status }}"
        SOURCE="${{ env.SOURCE }}"
        TRIGGER="${{ github.event_name }}"
        
        # ìˆ˜ì§‘ ê²°ê³¼ ì •ë³´ ì„¤ì •
        if [ "$STATUS" = "success" ]; then
          ICON="âœ…"
          MESSAGE="ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìˆ˜ì§‘ ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          
          # ì‹¤ì œ ìˆ˜ì§‘ ê²°ê³¼ íŒŒì‹± (ì›Œí¬í”Œë¡œìš° ë¡œê·¸ì—ì„œ)
          COLLECTED_COUNT=$(echo "${{ steps.collect-recipes.outputs.collected_count }}" | grep -o '[0-9]\+' | head -1 || echo "10")
          SAVED_COUNT=$(echo "${{ steps.collect-recipes.outputs.saved_count }}" | grep -o '[0-9]\+' | head -1 || echo "10")
          
          COLLECTED_INFO="ğŸ“Š <b>ìˆ˜ì§‘ ê²°ê³¼</b>: ${COLLECTED_COUNT}ê±´ ìˆ˜ì§‘, ${SAVED_COUNT}ê±´ ì €ì¥"
          SAVED_INFO="ğŸ’¾ <b>ìƒíƒœ</b>: ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë¨"
        else
          ICON="âŒ"
          MESSAGE="ì˜ì–‘ì•¡ ë ˆì‹œí”¼ ìˆ˜ì§‘ ì‘ì—…ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          COLLECTED_INFO="ğŸ“Š <b>ìˆ˜ì§‘ ê²°ê³¼</b>: ì‹¤íŒ¨"
          SAVED_INFO="ğŸ’¾ <b>ìƒíƒœ</b>: ì €ì¥ë˜ì§€ ì•ŠìŒ"
        fi
        
        FULL_MESSAGE="$ICON <b>ìŠ¤ë§ˆíŠ¸íŒœ ì˜ì–‘ì•¡ ìˆ˜ì§‘ ì•Œë¦¼</b>

        ğŸ“Š <b>ì‘ì—… ìƒíƒœ</b>: $STATUS
        ğŸŒ± <b>ìˆ˜ì§‘ ì†ŒìŠ¤</b>: $SOURCE
        â° <b>ì‹¤í–‰ ì‹œê°„</b>: $(date '+%Y-%m-%d %H:%M:%S')
        ğŸ”„ <b>íŠ¸ë¦¬ê±°</b>: $TRIGGER
        $COLLECTED_INFO
        $SAVED_INFO
        
        $MESSAGE"
        
        curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ env.TELEGRAM_CHAT_ID }}\",
            \"text\": \"$FULL_MESSAGE\",
            \"parse_mode\": \"HTML\"
          }"
