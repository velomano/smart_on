name: μμ–‘μ•΅ λ μ‹ν”Ό μλ™ μμ§‘ (μ„Έλ¶€)

on:
  schedule:
    - cron: '0 */6 * * *'   # 6μ‹κ°„λ§λ‹¤ μ‹¤ν–‰ (00:00, 06:00, 12:00, 18:00)
  workflow_dispatch:
    inputs:
      source:
        description: 'μμ§‘ν•  μ†μ¤ (all, cornell, rda, fao, academic)'
        required: false
        default: 'all'
        type: string
      batch_size:
        description: 'λ°°μΉ ν¬κΈ°'
        required: false
        default: '50'
        type: string

jobs:
  collect-recipes:
    runs-on: ubuntu-latest

    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      SOURCE: ${{ inputs.source || 'all' }}
      BATCH_SIZE: ${{ inputs.batch_size || '10' }}

    steps:
    - name: μ²΄ν¬μ•„μ›ƒ
      uses: actions/checkout@v4

    - name: Node.js μ„¤μ •
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: μμ΅΄μ„± μ„¤μΉ
      run: |
        cd apps/worker
        npm install

    - name: TypeScript μ»΄νμΌ
      run: |
        cd apps/worker
        npm run build

    - name: μμ–‘μ•΅ λ μ‹ν”Ό μμ§‘ λ° crop_profiles μ €μ¥
      run: |
        set -euo pipefail
        
        cd apps/worker
        
        SUPA_URL="${SUPABASE_URL:-***}"
        SUPA_KEY="${SUPABASE_SERVICE_ROLE_KEY:-test-key}"
        SRC="${SOURCE:-all}"
        BATCH="${BATCH_SIZE:-10}"
        
        echo "π€ μμ–‘μ•΅ λ μ‹ν”Ό μμ§‘ μ‹μ‘ (μ†μ¤: ${SRC}, λ°°μΉ: ${BATCH})"
        
        # ν™κ²½λ³€μ μ„¤μ •
        export SUPABASE_URL="$SUPA_URL"
        export SUPABASE_SERVICE_ROLE_KEY="$SUPA_KEY"
        
        # μ‹¤μ  μμ§‘ λ° crop_profiles μ§μ ‘ μ €μ¥
        node -e "
        const { collectAllRecipes } = require('./dist/sources/all.js');
        
        async function main() {
          try {
            console.log('π± μ‹¤μ  μμ§‘ μ‹μ‘...');
            const recipes = await collectAllRecipes($BATCH);
            console.log(\`π“ μμ§‘ μ™„λ£: \${recipes.length}κ±΄\`);
            
            // crop_profiles ν•μ‹μΌλ΅ λ³€ν™ν•μ—¬ μ§μ ‘ μ €μ¥
            let savedCount = 0;
            for (const recipe of recipes) {
              const source = recipe.source;
              
              // macro/micro λ°μ΄ν„°λ¥Ό target_ppm ν•μ‹μΌλ΅ λ³€ν™
              const targetPpm = {
                N: recipe.macro?.N || 0,
                P: recipe.macro?.P || 0,
                K: recipe.macro?.K || 0,
                Ca: recipe.macro?.Ca || 0,
                Mg: recipe.macro?.Mg || 0,
                S: recipe.macro?.S || 0
              };
              
              // NPK λΉ„μ¨ κ³„μ‚°
              const npkRatio = \`\${targetPpm.N}:\${targetPpm.P}:\${targetPpm.K}\`;
              
              // ν™κ²½ μ΅°κ±΄ μ •λ³΄ μƒμ„±
              const growingConditions = {
                temperature: \`\${recipe.env?.temp || 20}Β°C\`,
                humidity: \`\${recipe.env?.humidity || 65}%\`,
                light_hours: \`\${Math.round((recipe.env?.lux || 15000) / 1000)}μ‹κ°„\`,
                co2_level: '800-1200ppm'
              };
              
              // μμ–‘μ† μƒμ„Έ μ •λ³΄ μƒμ„±
              const nutrientsDetail = {
                nitrogen: targetPpm.N,
                phosphorus: targetPpm.P,
                potassium: targetPpm.K,
                calcium: targetPpm.Ca,
                magnesium: targetPpm.Mg,
                trace_elements: ['Fe', 'Mn', 'B', 'Zn', 'Cu', 'Mo']
              };
              
              // μ‚¬μ©λ²• λ° μ£Όμμ‚¬ν•­
              const usageNotes = [
                'μ£Ό 1ν EC μΈ΅μ • κ¶μ¥',
                'pHλ” 6.0-6.5 λ²”μ„ μ μ§€',
                'μ¨λ„κ°€ λ†’μ„ λ•λ” ECλ¥Ό λ‚®μ¶° μ‚¬μ©'
              ];
              
              const warnings = [
                'μΉΌμ κ²°ν• μ‹ μ λ κ°λ³€ ν„μƒ',
                'κ³Όλ„ν• μ§μ†λ” κ³Όλ²λ¬΄ μ λ°'
              ];
              
              // crop_profiles ν•μ‹μΌλ΅ λ³€ν™
              const cropProfile = {
                crop_key: recipe.crop_key,
                crop_name: recipe.crop_name,
                stage: recipe.stage,
                target_ppm: targetPpm,
                target_ec: recipe.target_ec,
                target_ph: recipe.target_ph,
                author: 'μλ™ μμ§‘ μ‹μ¤ν…',
                source_title: source?.name || 'μ¤λ§νΈν λ°μ΄ν„°λ² μ΄μ¤',
                source_year: new Date(recipe.collected_at).getFullYear(),
                license: source?.license || 'CC BY 4.0',
                description: \`\${recipe.crop_name} \${recipe.stage}μ— μµμ ν™”λ λ°°μ–‘μ•΅ λ μ‹ν”Όμ…λ‹λ‹¤. (μ¶μ²: \${source?.name || 'Unknown'})\`,
                growing_conditions: growingConditions,
                nutrients_detail: nutrientsDetail,
                usage_notes: usageNotes,
                warnings: warnings,
                last_updated: new Date(recipe.collected_at).toISOString().split('T')[0],
                volume_l: 100,
                ec_target: recipe.target_ec,
                ph_target: recipe.target_ph,
                npk_ratio: npkRatio
              };
              
              // crop_profilesμ— μ§μ ‘ μ €μ¥
              const res = await fetch(process.env.SUPABASE_URL + '/rest/v1/crop_profiles', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'apikey': process.env.SUPABASE_SERVICE_ROLE_KEY,
                  'Authorization': \`Bearer \${process.env.SUPABASE_SERVICE_ROLE_KEY}\`,
                  'Prefer': 'resolution=merge-duplicates'
                },
                body: JSON.stringify(cropProfile)
              });
              
              if (res.ok) {
                savedCount++;
                console.log(\`β… μ €μ¥ μ™„λ£: \${recipe.crop_name} (\${recipe.stage}) - \${source?.name || 'Unknown'}\`);
              } else {
                const errorText = await res.text();
                console.error(\`β μ €μ¥ μ‹¤ν¨: \${recipe.crop_name}\`, errorText);
              }
            }
            
            console.log(\`π‰ μ €μ¥ μ™„λ£: \${savedCount}/\${recipes.length}κ±΄\`);
            
            // μμ§‘ ν†µκ³„ μ¶λ ¥
            const sourceStats = recipes.reduce((acc, recipe) => {
              const sourceName = recipe.source?.name || 'Unknown';
              acc[sourceName] = (acc[sourceName] || 0) + 1;
              return acc;
            }, {});
            
            console.log('π“ μμ§‘ ν†µκ³„:');
            Object.entries(sourceStats).forEach(([source, count]) => {
              console.log(\`  - \${source}: \${count}κ±΄\`);
            });
            
          } catch (error) {
            console.error('π’¥ μμ§‘ μ‹¤ν¨:', error);
            process.exit(1);
          }
        }
        
        main();
        "

    - name: μμ§‘ κ²°κ³Ό ν…”λ κ·Έλ¨ μ•λ¦Ό
      if: always() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
      run: |
        STATUS="${{ job.status }}"
        SOURCE="${{ env.SOURCE }}"
        TRIGGER="${{ github.event_name }}"
        
        if [ "$STATUS" = "success" ]; then
          ICON="β…"
          MESSAGE="μμ–‘μ•΅ λ μ‹ν”Ό μμ§‘ μ‘μ—…μ΄ μ„±κ³µμ μΌλ΅ μ™„λ£λμ—μµλ‹λ‹¤!"
        else
          ICON="β"
          MESSAGE="μμ–‘μ•΅ λ μ‹ν”Ό μμ§‘ μ‘μ—…μ΄ μ‹¤ν¨ν–μµλ‹λ‹¤."
        fi
        
        FULL_MESSAGE="$ICON <b>μ¤λ§νΈν μμ–‘μ•΅ μμ§‘ μ•λ¦Ό</b>

        π“ <b>μ‘μ—… μƒνƒ</b>: $STATUS
        π± <b>μμ§‘ μ†μ¤</b>: $SOURCE
        β° <b>μ‹¤ν–‰ μ‹κ°„</b>: $(date '+%Y-%m-%d %H:%M:%S')
        π”„ <b>νΈλ¦¬κ±°</b>: $TRIGGER
        
        $MESSAGE"
        
        curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{
            \"chat_id\": \"${{ env.TELEGRAM_CHAT_ID }}\",
            \"text\": \"$FULL_MESSAGE\",
            \"parse_mode\": \"HTML\"
          }"
