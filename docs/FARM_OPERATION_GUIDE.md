# 🌱 스마트팜 베드 운영 가이드

## 📋 목차
1. [시스템 개요](#시스템-개요)
2. [MQTT 브리지 아키텍처](#mqtt-브리지-아키텍처)
3. [베드 구조 이해](#베드-구조-이해)
4. [센서 데이터 관리](#센서-데이터-관리)
5. [원격 제어 시스템](#원격-제어-시스템)
6. [실제 운영 시나리오](#실제-운영-시나리오)
7. [문제 해결 가이드](#문제-해결-가이드)

---

## 🎯 시스템 개요

### **스마트팜 베드 시스템이란?**
- **다단 베드 운영**: 1개 베드에 최대 5단까지 수직 재배 가능
- **실시간 모니터링**: 센서를 통한 온도, 습도, EC, pH 등 실시간 측정
- **원격 제어**: 웹앱을 통한 펌프, LED, 팬 등 장비 원격 제어
- **자동화**: MQTT 통신을 통한 농장 장비 자동 관리

### **하드웨어 구성**
```
농장 1개 모듈
├── 아두이노 (센서 데이터 수집)
│   ├── 온도 센서 (각 단별)
│   ├── 습도 센서 (각 단별)
│   ├── EC 센서 (각 단별)
│   └── pH 센서 (각 단별)
├── 라즈베리파이 (장비 제어)
│   ├── 펌프 제어
│   ├── LED 조명 제어
│   ├── 팬 제어
│   └── 기타 액추에이터
└── MQTT 서버 (통신 허브)
    ├── 센서 데이터 수집
    ├── 제어 명령 전달
    └── 웹앱과 실시간 통신
```

---

## 🌉 MQTT 브리지 아키텍처

### **브리지 기반 통신 구조**
```
웹앱 (브라우저)
    ↓ (HTTP/API)
Supabase Database
    ↓ (실시간)
MQTT Bridge Service
    ↓ (MQTT)
농장별 MQTT 브로커
    ↓ (MQTT)
하드웨어 (아두이노/라즈베리파이)
```

### **핵심 설계 원칙**
- **브라우저는 MQTT에 직접 접속하지 않음** (보안 강화)
- **Supabase DB만 읽고 쓰기** (운영 단순화)
- **서버측 MQTT 브리지**를 통한 통신
- **농장별 독립적인 MQTT 브로커** 설정

### **MQTT 토픽 구조**
```
farms/{farmId}/devices/{deviceId}/registry   (retained, QoS1)
farms/{farmId}/devices/{deviceId}/state      (retained, QoS1)
farms/{farmId}/devices/{deviceId}/telemetry  (QoS1, batch)
farms/{farmId}/devices/{deviceId}/command    (QoS1)
farms/{farmId}/devices/{deviceId}/command/ack(QoS1)
```

### **데이터 흐름**
1. **센서 데이터**: 아두이노 → 라즈베리파이 → 농장 MQTT → 브리지 → Supabase → 웹앱
2. **제어 명령**: 웹앱 → Supabase → 브리지 → 농장 MQTT → 라즈베리파이 → 액추에이터
3. **상태 응답**: 액추에이터 → 라즈베리파이 → 농장 MQTT → 브리지 → Supabase → 웹앱
4. **실시간 통신**: Supabase Realtime을 통한 실시간 업데이트

---

## 🏗️ 베드 구조 이해

### **베드 단 구조**
- **1베드 = 1-5단 운영 가능**
- **각 단별 독립적인 환경 관리**
- **단별 센서 설치 가능**
- **전체 베드 공통 제어 장비**

### **베드 카드 정보**
```
┌─────────────────────────────────────┐
│ 🏗️ 베드-1                    ✏️ 편집 │
│ 🏗️ 3/5단  📊 센서 6개  🔘 스위치 4개 │
├─────────────────────────────────────┤
│ 📊 단별 센서 데이터                  │
│ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐               │
│ │5│ │4│ │3│ │2│ │1│ ← 활성 단      │
│ └─┘ └─┘ └─┘ └─┘ └─┘               │
│                                     │
│ 🔘 원격 제어 스위치                  │
│ [💧펌프] [💡LED] [🌀팬] [🔥히터]     │
└─────────────────────────────────────┘
```

### **단별 센서 표시**
- **🌡️ 온도**: 각 단별 온도 측정
- **💧 습도**: 각 단별 습도 측정  
- **⚡ EC**: 각 단별 전기전도도 측정
- **🧪 pH**: 각 단별 산성도 측정
- **☀️ 조도**: 각 단별 빛 강도 측정
- **🌊 수온**: 각 단별 물 온도 측정

---

## 📊 센서 데이터 관리

### **센서 추가 방법**
1. **베드 카드에서 "+ 센서 추가" 클릭**
2. **단 번호 선택** (1-5단)
3. **센서 유형 선택** (온도, 습도, EC, pH, 조도, 수온)
4. **센서 ID 입력** (예: temp_001, hum_001)
5. **저장**

### **센서 데이터 확인**
- **실시간 값 표시**: 최신 측정값 자동 업데이트
- **단별 구분**: 각 단의 센서 데이터 독립 표시
- **품질 표시**: 데이터 신뢰성 (좋음/주의/오류)
- **시간 정보**: 마지막 측정 시간 표시

### **센서 데이터 예시**
```json
{
  "farm_id": "farm_a",
  "bed_id": "bed_1",
  "tier_number": 1,
  "sensor_type": "temperature",
  "value": 25.5,
  "unit": "°C",
  "quality": "good",
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

---

## 🔘 원격 제어 시스템

### **제어 스위치 추가**
1. **베드 카드에서 "+ 스위치 추가" 클릭**
2. **스위치 ID 입력** (예: pump_001, led_001)
3. **스위치 이름 입력** (예: 양액 펌프, LED 조명)
4. **액추에이터 유형 선택** (펌프, LED, 팬, 히터, 양액기)
5. **저장**

### **제어 스위치 유형**
- **💧 펌프**: 양액 공급, 물 공급
- **💡 LED**: 조명 제어, 광량 조절
- **🌀 팬**: 환기 제어, 온도 조절
- **🔥 히터**: 온도 상승, 난방
- **🧪 양액기**: 양액 공급, 비료 주입

### **원격 제어 방법**
1. **스위치 토글 클릭**: ON/OFF 즉시 제어
2. **실시간 상태 확인**: 현재 상태 실시간 표시
3. **명령 실행 시간**: 실제 가동 시간 표시
4. **오류 알림**: 제어 실패 시 오류 메시지

### **제어 명령 예시**
```json
{
  "farm_id": "farm_a",
  "bed_id": "bed_1",
  "switch_id": "pump_1",
  "command": "on",
  "duration": 300,
  "user_id": "user_123",
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

---

## 📡 MQTT 통신 방식

### **MQTT란?**
- **Message Queuing Telemetry Transport**
- **농장 장비와 웹앱 간 실시간 통신**
- **JSON 형식 데이터 교환**
- **농장별 독립적인 MQTT 서버**

### **통신 흐름**
```
센서 데이터: 아두이노 → 라즈베리파이 → MQTT 서버 → 웹앱
제어 명령: 웹앱 → MQTT 서버 → 라즈베리파이 → 액추에이터
```

### **토픽 구조**
```
센서 데이터: farm/farm_a/bed/bed_1/tier/tier_1/sensor/temperature
제어 명령: farm/farm_a/bed/bed_1/control/pump_1
상태 응답: farm/farm_a/bed/bed_1/status/pump_1
시스템 상태: farm/farm_a/system/arduino
```

### **농장별 MQTT 설정**
1. **농장 관리 → MQTT 설정**
2. **서버 URL 입력** (예: mqtt://farm-a.example.com)
3. **포트 설정** (일반: 1883, SSL: 8883)
4. **인증 정보** (사용자명/비밀번호)
5. **연결 테스트** → **저장**

---

## 🌱 실제 운영 시나리오

### **시나리오 1: 새 베드 설정**
1. **베드 생성**: "베드-1" 생성, 3단 구조 설정
2. **센서 설치**: 1단(온도, 습도), 2단(온도, EC), 3단(온도, pH)
3. **제어 장비**: 펌프 1개, LED 1개, 팬 1개 추가
4. **MQTT 연결**: 농장 MQTT 서버 설정 및 연결
5. **실시간 모니터링**: 센서 데이터 확인 및 장비 제어

### **시나리오 2: 일일 관리**
1. **아침**: 센서 데이터 확인, 필요시 펌프 가동
2. **점심**: 온도 상승 시 팬 가동, 조도 부족 시 LED 가동
3. **저녁**: 양액 공급, EC/pH 값 확인
4. **야간**: LED 조명 제어, 온도 유지

### **시나리오 3: 문제 상황 대응**
1. **센서 오류**: 데이터 품질 "오류" 표시 → 센서 점검
2. **제어 실패**: 스위치 상태 "오류" 표시 → 장비 점검
3. **MQTT 연결 끊김**: 연결 상태 "끊어짐" 표시 → 네트워크 점검
4. **알림 수신**: 텔레그램을 통한 이상 상황 알림

---

## 🛠️ 문제 해결 가이드

### **센서 데이터 문제**
| 문제 | 원인 | 해결 방법 |
|------|------|-----------|
| 데이터 없음 | 센서 미설치 | 센서 추가 및 MQTT 구독 확인 |
| 값이 이상함 | 센서 오류 | 센서 점검 및 교체 |
| 업데이트 안됨 | MQTT 연결 끊김 | 네트워크 및 MQTT 서버 확인 |

### **제어 스위치 문제**
| 문제 | 원인 | 해결 방법 |
|------|------|-----------|
| 토글 안됨 | MQTT 연결 끊김 | 연결 상태 확인 |
| 명령 무시됨 | 라즈베리파이 오류 | 하드웨어 점검 |
| 상태 업데이트 안됨 | 상태 응답 토픽 오류 | 토픽 구독 확인 |

### **MQTT 연결 문제**
| 문제 | 원인 | 해결 방법 |
|------|------|-----------|
| 연결 실패 | 서버 URL 오류 | URL 및 포트 확인 |
| 인증 실패 | 사용자명/비밀번호 오류 | 인증 정보 확인 |
| 구독 실패 | 토픽 권한 없음 | MQTT 서버 권한 확인 |

### **하드웨어 상태 모니터링**
- **🟢 정상**: 모든 장비 정상 작동
- **🟡 주의**: 일부 장비 오류 발생
- **🔴 오류**: 주요 장비 오류 발생

---

## 📞 지원 및 문의

### **기술 지원**
- **시스템 관리자**: velomano@naver.com
- **문서 업데이트**: 최신 버전 확인
- **문제 신고**: 상세한 오류 메시지와 함께 문의

### **추가 기능**
- **텔레그램 알림**: 이상 상황 자동 알림
- **데이터 백업**: 센서 데이터 자동 저장
- **사용자 관리**: 권한별 접근 제어

---

## 📝 부록

### **용어 정리**
- **베드**: 식물 재배 공간
- **단**: 베드 내 수직 층
- **센서**: 환경 측정 장비
- **액추에이터**: 제어 장비 (펌프, LED 등)
- **MQTT**: 실시간 통신 프로토콜
- **토픽**: MQTT 메시지 주소

### **JSON 데이터 형식**
모든 센서 데이터와 제어 명령은 JSON 형식으로 교환됩니다.
- **ISO 8601 타임스탬프**: "2024-01-01T12:00:00.000Z"
- **유니코드 인코딩**: UTF-8
- **숫자 형식**: 소수점 지원 (25.5, 12.3 등)

### **보안 고려사항**
- **MQTT 인증**: 사용자명/비밀번호 필수
- **SSL 연결**: 프로덕션 환경에서는 8883 포트 사용 권장
- **방화벽 설정**: 필요한 포트만 개방
- **정기 업데이트**: 시스템 및 보안 패치 적용

---

*이 문서는 스마트팜 베드 시스템 운영을 위한 가이드입니다. 추가 질문이나 개선 사항이 있으시면 관리자에게 문의해주세요.*
