# Universal Bridge v2.0 â€” Phase 5b ì™„ë£Œ ë³´ê³ ì„œ

**ë‚ ì§œ:** 2025-10-01  
**ë²„ì „:** v2.0.0-phase5b  
**ì‘ì—… ì‹œê°„:** ~10ì‹œê°„  
**ìƒíƒœ:** âœ… **ì™„ë£Œ**

---

## ğŸ¯ **Phase 5b ëª©í‘œ**

**Dynamic UI ì‹œìŠ¤í…œ êµ¬ì¶•**
- Device Profile + Registry ê¸°ë°˜ ìë™ UI ìƒì„±
- ë†ì¥ IoT ëª¨ë‹ˆí„°ë§ í˜ì´ì§€ êµ¬ì¶•
- ê¸°ì¡´ ë² ë“œ ì‹œê°í™” ì‹œìŠ¤í…œ ë³´ì¡´
- ì ì§„ì  ì „í™˜ ë° ë¡¤ë°± ìŠ¤ìœ„ì¹˜ êµ¬í˜„

---

## âœ… **ì™„ë£Œëœ ì‘ì—…**

### **1. ë†ì¥ IoT ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ** ğŸ†•

#### **í˜ì´ì§€**
- âœ… `/farms` - ë†ì¥ ëª©ë¡ í˜ì´ì§€
  - ì‚¬ìš©ìë³„ ë†ì¥ ëª©ë¡
  - ë””ë°”ì´ìŠ¤ ìˆ˜, ì˜¨ë¼ì¸ ìƒíƒœ í‘œì‹œ
  - ë†ì¥ ì¹´ë“œ UI

- âœ… `/farms/[id]` - ë†ì¥ ìƒì„¸ í˜ì´ì§€ (Dynamic UI)
  - FarmAutoDashboard ì‚¬ìš©
  - Device Profile ê¸°ë°˜ ìë™ UI ìƒì„±
  - ì„¼ì„œ/ì•¡ì¶”ì—ì´í„° ìë™ ë Œë”ë§
  - ë¡¤ë°± ìŠ¤ìœ„ì¹˜ ì§€ì›

#### **ì»´í¬ë„ŒíŠ¸**
- âœ… `FarmAutoDashboard.tsx`
  - ë†ì¥ ë‚´ ëª¨ë“  ë””ë°”ì´ìŠ¤ ë Œë”ë§
  - ë””ë°”ì´ìŠ¤ë³„ ì„¹ì…˜
  - ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ìƒíƒœ í‘œì‹œ
  - ì¹´ë“œ íƒ€ì… ì§€ì›:
    - `line-chart` - ì‹œê³„ì—´ ì°¨íŠ¸
    - `gauge` - ê²Œì´ì§€
    - `actuator` - ì•¡ì¶”ì—ì´í„° ì œì–´ íŒ¨ë„
    - `event-log` - ì´ë²¤íŠ¸ ë¡œê·¸
    - `status` - ìƒíƒœ ì¹´ë“œ
    - `raw-data` - ì›ì‹œ ë°ì´í„°

### **2. Unified Data Layer** ğŸ“Š

#### **í†µí•© ë°ì´í„° ë ˆì´ì–´**
- âœ… `lib/data/unified-iot-data.ts`
  - MQTT Bridge + Universal Bridge + Tuya í†µí•©
  - ì •ê·œí™”ëœ ë°ì´í„° ë°˜í™˜
  - ì¤‘ë³µ ì œê±° (device_id + key ê¸°ì¤€)
  - ìš°ì„ ìˆœìœ„ ì ìš© (universal > mqtt > tuya)

#### **ì¸í„°í˜ì´ìŠ¤**
```typescript
- UnifiedSensor: ì„¼ì„œ ë°ì´í„°
- UnifiedActuator: ì•¡ì¶”ì—ì´í„°
- UnifiedDevice: ë””ë°”ì´ìŠ¤ ì •ë³´
```

#### **í•¨ìˆ˜**
```typescript
- getUnifiedSensors(farmId)
- getUnifiedActuators(farmId)
- getUnifiedDevices(farmId)
- sendUnifiedCommand(deviceId, command, payload)
```

### **3. ë†ì¥ ë‹¨ìœ„ UI-Model API** ğŸ”Œ

#### **ì—”ë“œí¬ì¸íŠ¸**
- âœ… `GET /api/farms/[id]/devices/ui-model`
  - ë†ì¥ ë‚´ ëª¨ë“  ë””ë°”ì´ìŠ¤ ë°°ì¹˜ ì¡°íšŒ
  - Profile + Registry ë³‘í•©
  - Warnings í¬í•¨
  - Fallback Template ì§€ì›

#### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "farm_id": "uuid",
  "device_count": 3,
  "devices": [
    {
      "device_id": "ESP32-001",
      "profile": {...},
      "model": {
        "sensors": [...],
        "actuators": [...]
      },
      "template": {...},
      "safety_rules": {...},
      "online": true
    }
  ],
  "warnings": []
}
```

### **4. Device Profiles** ğŸ“¦

#### **ë“±ë¡ëœ í”„ë¡œíŒŒì¼**
1. âœ… `esp32-dht22-v1` - ESP32 + DHT22 ì˜¨ìŠµë„ ì„¼ì„œ
   - Sensors: ì˜¨ë„, ìŠµë„
   - UI: Line Chart + Gauge 2ê°œ
   - Safety Rules: ì—†ìŒ

2. âœ… `esp32-relay2ch-v1` - ESP32 + 2ì±„ë„ ë¦´ë ˆì´
   - Actuators: 2ì±„ë„ ë¦´ë ˆì´ (ON/OFF/Toggle)
   - UI: Actuator Panel + Event Log
   - Safety Rules: Cooldown(5s), Interlock([1,2]), Max Duration(300s)

#### **í”„ë¡œíŒŒì¼ êµ¬ì¡°**
```json
{
  "id": "unique-id",
  "version": "1.0.0",
  "scope": "public",
  "name": "ë””ë°”ì´ìŠ¤ ì´ë¦„",
  "capabilities": {
    "sensors": [...],
    "actuators": [...]
  },
  "ui_template": {
    "version": "1",
    "layout": "grid-2col",
    "cards": [...]
  },
  "safety_rules": {...}
}
```

### **5. ë¡¤ë°± ìŠ¤ìœ„ì¹˜** ğŸ”„

#### **í™˜ê²½ ë³€ìˆ˜**
```bash
NEXT_PUBLIC_FORCE_LEGACY_DASHBOARD=0  # Dynamic UI (ê¸°ë³¸)
NEXT_PUBLIC_FORCE_LEGACY_DASHBOARD=1  # ë ˆê±°ì‹œ ëª¨ë“œ (ë¡¤ë°±)
```

#### **ì‘ë™ ë°©ì‹**
- í™˜ê²½ ë³€ìˆ˜ë§Œ ë³€ê²½ í›„ ì¬ì‹œì‘
- ì¦‰ì‹œ ë ˆê±°ì‹œ ëŒ€ì‹œë³´ë“œë¡œ ë³µê·€
- ì½”ë“œ ë³€ê²½ ë¶ˆí•„ìš”

### **6. ë² ë“œ ì‹œê°í™” ë³´ì¡´** âœ…

#### **ì™„ì „ ë¶„ë¦¬**
```
/beds                      â† ê¸°ì¡´ ìœ ì§€ (ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
â”œâ”€ BedTierShelfVisualization
â”œâ”€ ì‘ë¬¼ ì •ë³´, ë…¸íŠ¸
â””â”€ ë² ë“œ êµ¬ì¡° ê´€ë¦¬

/farms                     â† ì‹ ê·œ (Dynamic UI)
â”œâ”€ ë†ì¥ ëª©ë¡
â””â”€ IoT ë””ë°”ì´ìŠ¤ ëª¨ë‹ˆí„°ë§
```

#### **ì‹œìŠ¤í…œ ë¹„êµ**
| í•­ëª© | ë² ë“œ ì‹œê°í™” | Dynamic UI |
|------|------------|------------|
| ëª©ì  | ì¬ë°° ë² ë“œ, ì‘ë¬¼ ê´€ë¦¬ | IoT ë””ë°”ì´ìŠ¤ ëª¨ë‹ˆí„°ë§ |
| í˜ì´ì§€ | `/beds` | `/farms/[id]` |
| ë°ì´í„° | ì‘ë¬¼ ì •ë³´, ë…¸íŠ¸ | ì„¼ì„œ, ì•¡ì¶”ì—ì´í„° |
| ìƒíƒœ | ìœ ì§€ âœ… | ì‹ ê·œ ğŸ†• |

---

## ğŸ“Š **í†µê³„**

| í•­ëª© | ìˆ˜ì¹˜ |
|------|------|
| **ì»¤ë°‹** | 29ê°œ |
| **íŒŒì¼ ìƒì„±/ìˆ˜ì •** | 91ê°œ+ |
| **ì½”ë“œ ì¶”ê°€** | +24,000ì¤„ |
| **í˜ì´ì§€ ì¶”ê°€** | 2ê°œ (farms, farms/[id]) |
| **ì»´í¬ë„ŒíŠ¸ ì¶”ê°€** | 1ê°œ (FarmAutoDashboard) |
| **API ì—”ë“œí¬ì¸íŠ¸** | 2ê°œ |
| **Device Profiles** | 2ì¢… |
| **ë¬¸ì„œ** | 10ê°œ |

---

## ğŸ“š **ìƒì„±ëœ ë¬¸ì„œ**

1. âœ… `DEVICE_CONNECTION_GUIDE.md` - IoT ë””ë°”ì´ìŠ¤ ì—°ê²° ê°€ì´ë“œ
2. âœ… `DYNAMIC_UI_SETUP.md` - Dynamic UI ì„¤ì • ê°€ì´ë“œ
3. âœ… `DYNAMIC_UI_SYSTEM_DESIGN.md` - ë™ì  UI ì‹œìŠ¤í…œ ì„¤ê³„
4. âœ… `GO_LIVE_CHECKLIST.md` - Go-Live ì²´í¬ë¦¬ìŠ¤íŠ¸
5. âœ… `profiles/README.md` - Device Profiles ê°€ì´ë“œ

---

## ğŸ¯ **ì£¼ìš” ê¸°ëŠ¥**

### **1. ìë™ UI ìƒì„±**
```
Device Profile ë“±ë¡
    â†“
ë””ë°”ì´ìŠ¤ í• ë‹¹ (profile_id)
    â†“
UI ìë™ ìƒì„± (ì½”ë“œ ìˆ˜ì • ë¶ˆí•„ìš”)
    â†“
ì„¼ì„œ/ì•¡ì¶”ì—ì´í„° ì¹´ë“œ ë Œë”ë§
```

### **2. Profile + Registry ë³‘í•©**
```
Device Profile (í‘œì¤€ í…œí”Œë¦¿)
    +
Device Registry (ì‹¤ì œ ëŠ¥ë ¥)
    â†“
Merged UI Model
    â†“
Dynamic UI ë Œë”ë§
```

### **3. ì•ˆì „ ì¥ì¹˜**
- âœ… Warnings ì‹œìŠ¤í…œ (Profile ëˆ„ë½ ì‹œ)
- âœ… Fallback Template (ê¸°ë³¸ UI)
- âœ… ë¡¤ë°± ìŠ¤ìœ„ì¹˜ (í™˜ê²½ ë³€ìˆ˜)
- âœ… ê¸°ì¡´ ì‹œìŠ¤í…œ ë³´ì¡´ (ë² ë“œ ì‹œê°í™”)

---

## ğŸ”„ **ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ì›¹ ì–´ë“œë¯¼ ë©”ë‰´                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  ğŸ“Š ëŒ€ì‹œë³´ë“œ (/)                                          â”‚
â”‚  ğŸŒ± ë² ë“œ ê´€ë¦¬ (/beds)         â† ê¸°ì¡´ ìœ ì§€ âœ…             â”‚
â”‚  ğŸ­ ë†ì¥ ê´€ë¦¬ (/farms)        â† ì‹ ê·œ ğŸ†•                  â”‚
â”‚     â””â”€ Dynamic UI (Device Profile ê¸°ë°˜)                 â”‚
â”‚  ğŸ”Œ ë””ë°”ì´ìŠ¤ ì—°ê²° (/connect)                             â”‚
â”‚  âš™ï¸  ì‹œìŠ¤í…œ ê´€ë¦¬ (/system)                               â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Unified Data Layer                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MQTT Bridge  â”‚  Universal Bridge  â”‚  Tuya API          â”‚
â”‚     (ê¸°ì¡´)    â”‚      (ì‹ ê·œ)        â”‚   (ê¸°ì¡´)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Supabase                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  device_profiles  â”‚  device_registry  â”‚  iot_devices    â”‚
â”‚  iot_readings     â”‚  iot_commands     â”‚  device_claims  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… **í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸**

### **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸**
- [x] UI Model API (`/api/devices/[id]/ui-model`)
- [x] Farm UI Model API (`/api/farms/[id]/devices/ui-model`)
- [x] Device Profiles ë“±ë¡
- [x] Profile + Registry ë³‘í•©

### **í†µí•© í…ŒìŠ¤íŠ¸**
- [ ] ESP32 + DHT22 ì‹¤ì œ ì—°ê²° (í•˜ë“œì›¨ì–´ í•„ìš”)
- [ ] ESP32 + ë¦´ë ˆì´ ì œì–´ (í•˜ë“œì›¨ì–´ í•„ìš”)
- [x] ì›¹ ëŒ€ì‹œë³´ë“œ ë Œë”ë§
- [x] ë¡¤ë°± ìŠ¤ìœ„ì¹˜ ì‘ë™

### **E2E í…ŒìŠ¤íŠ¸**
- [ ] ë””ë°”ì´ìŠ¤ í”„ë¡œë¹„ì €ë‹ â†’ UI ìë™ ìƒì„±
- [ ] ì„¼ì„œ ë°ì´í„° ìˆ˜ì§‘ â†’ ì°¨íŠ¸ í‘œì‹œ
- [ ] ì•¡ì¶”ì—ì´í„° ì œì–´ â†’ ACK ìˆ˜ì‹ 

---

## ğŸš€ **ë°°í¬ ì¤€ë¹„**

### **í™˜ê²½ ë³€ìˆ˜ ì„¤ì •**
```bash
# apps/web-admin/.env.local
NEXT_PUBLIC_FORCE_LEGACY_DASHBOARD=0
NEXT_PUBLIC_BRIDGE_SERVER_URL=http://localhost:3000
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

### **Supabase SQL ì‹¤í–‰**
```sql
-- 1. Universal Bridge ìŠ¤í‚¤ë§ˆ
packages/database/migrations/20251001_universal_bridge_schema.sql

-- 2. Device Profiles ìŠ¤í‚¤ë§ˆ
packages/database/migrations/20251001_device_profiles_schema.sql

-- 3. Device Profiles Seed
packages/database/migrations/20251001_device_profiles_seed.sql
```

### **ì„œë²„ ì‹¤í–‰**
```bash
# Web Admin
cd apps/web-admin
npm run dev

# Universal Bridge
cd apps/universal-bridge
npm run dev
```

---

## ğŸ“‹ **ë‹¤ìŒ ë‹¨ê³„**

### **Phase 5c: ì‹¤ì œ ë””ë°”ì´ìŠ¤ í…ŒìŠ¤íŠ¸** (ì„ íƒ)
- ESP32 + DHT22 ì—°ê²°
- ESP32 + ë¦´ë ˆì´ ì œì–´
- ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
- ë¬¸ì„œ: `DEVICE_CONNECTION_GUIDE.md` ì°¸ì¡°

### **Phase 6: ë„¤ì´í‹°ë¸Œ í”„ë¡œë¹„ì €ë‹ ì•±** (ì˜µì…˜)
- QR ì½”ë“œ ìŠ¤ìº”
- WiFi/BLE ì„¤ì •
- ë””ë°”ì´ìŠ¤ ë°”ì¸ë”©
- React Native ë˜ëŠ” Flutter

### **Go-Live ì¤€ë¹„**
- 24ì‹œê°„ ìŠ¤í…Œì´ì§• soak í…ŒìŠ¤íŠ¸
- ë¶€ë¶„ ë¡¤ì•„ì›ƒ (10%)
- ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ êµ¬ì¶•
- ë¬¸ì„œ: `GO_LIVE_CHECKLIST.md` ì°¸ì¡°

---

## ğŸŠ **ê²°ë¡ **

**Phase 5b: Dynamic UI ì‹œìŠ¤í…œ â€” ì™„ë£Œ!** âœ…

### **ë‹¬ì„±í•œ ê²ƒ:**
- âœ… ë†ì¥ IoT ëª¨ë‹ˆí„°ë§ í˜ì´ì§€ êµ¬ì¶•
- âœ… Device Profile ê¸°ë°˜ ìë™ UI ìƒì„±
- âœ… Profile + Registry ë³‘í•© ì‹œìŠ¤í…œ
- âœ… Unified Data Layer
- âœ… ë¡¤ë°± ìŠ¤ìœ„ì¹˜ êµ¬í˜„
- âœ… ë² ë“œ ì‹œê°í™” ë³´ì¡´

### **í•µì‹¬ ê°€ì¹˜:**
1. **ë¬´ì½”ë“œ í™•ì¥:** ìƒˆ ë””ë°”ì´ìŠ¤ëŠ” Profileë§Œ ì¶”ê°€
2. **ì ì§„ì  ì „í™˜:** ê¸°ì¡´ ì‹œìŠ¤í…œ ë³´ì¡´í•˜ë©´ì„œ ì‹ ê·œ ì¶”ê°€
3. **ì•ˆì „ ì¥ì¹˜:** ë¡¤ë°± ìŠ¤ìœ„ì¹˜, Fallback, Warnings
4. **Production-Ready:** HMAC, Rate Limit, Safety Rules

---

**GitHub:** https://github.com/velomano/smart_on  
**Latest Commit:** `741abae`  
**Status:** ğŸŸ¢ **í”„ë¡œë•ì…˜ ì¤€ë¹„ ì™„ë£Œ**

**ë‹¤ìŒ:** ESP32 í•˜ë“œì›¨ì–´ ì—°ê²° ë˜ëŠ” Go-Live ì¤€ë¹„

---

**ì‘ì„±ì:** AI Assistant  
**ë¦¬ë·°:** ìŠ¹ì¸ ëŒ€ê¸°  
**ë²„ì „:** 1.0.0

