# ğŸ” ì‚¬ìš©ì ê¶Œí•œ ì‹œìŠ¤í…œ ë¬¸ì„œ

## ğŸ“‹ ê°œìš”

ìŠ¤ë§ˆíŠ¸íŒœ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì™„ì „í•œ ì‚¬ìš©ì ê¶Œí•œ ê´€ë¦¬ ì‹œìŠ¤í…œì…ë‹ˆë‹¤. Supabase Authì™€ ì—°ë™í•˜ì—¬ ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´(RBAC)ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

## ğŸ—ï¸ ì‹œìŠ¤í…œ êµ¬ì¡°

### ê³„ì¸µ êµ¬ì¡°
```
í…Œë„ŒíŠ¸ (Tenant)
â”œâ”€â”€ íŒ€ (Team) - ë†ì¥ ë‹¨ìœ„
â”‚   â”œâ”€â”€ íŒ€ ë¦¬ë” (Team Leader)
â”‚   â””â”€â”€ íŒ€ ë©¤ë²„ (Team Member)
â””â”€â”€ ì‹œìŠ¤í…œ ê´€ë¦¬ì (System Admin) - ëª¨ë“  ê¶Œí•œ
```

### ê¶Œí•œ ë ˆë²¨
1. **ì‹œìŠ¤í…œ ê´€ë¦¬ì (system_admin)**: ì „ì²´ ì‹œìŠ¤í…œ ê´€ë¦¬ ê¶Œí•œ
2. **íŒ€ ë¦¬ë” (team_leader)**: íŠ¹ì • ë†ì¥ ê´€ë¦¬ ê¶Œí•œ
3. **íŒ€ ë©¤ë²„ (team_member)**: ê¸°ë³¸ ì‚¬ìš©ì ê¶Œí•œ

## ğŸ“Š í…Œì´ë¸” êµ¬ì¡°

### 1. tenants (í…Œë„ŒíŠ¸)
- **ëª©ì **: ë©€í‹° í…Œë„ŒíŠ¸ ì§€ì›
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `id`: UUID (Primary Key)
  - `name`: í…Œë„ŒíŠ¸ ì´ë¦„
  - `description`: í…Œë„ŒíŠ¸ ì„¤ëª…
  - `is_active`: í™œì„±í™” ìƒíƒœ

### 2. teams (íŒ€)
- **ëª©ì **: ë†ì¥ ë‹¨ìœ„ íŒ€ ê´€ë¦¬
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `id`: UUID (Primary Key)
  - `tenant_id`: í…Œë„ŒíŠ¸ ì°¸ì¡°
  - `name`: íŒ€ ì´ë¦„ (ì˜ˆ: "1ë†ì¥", "2ë†ì¥")
  - `team_code`: íŒ€ ì‹ë³„ ì½”ë“œ (ì˜ˆ: "FARM001")

### 3. users (ì‚¬ìš©ì)
- **ëª©ì **: Supabase Authì™€ ì—°ë™ëœ ì‚¬ìš©ì ì •ë³´
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `id`: UUID (auth.users ì°¸ì¡°)
  - `email`: ì´ë©”ì¼ ì£¼ì†Œ
  - `name`: ì‚¬ìš©ì ì´ë¦„
  - `role`: ì‚¬ìš©ì ì—­í•  (system_admin, team_leader, team_member)
  - `team_id`: ì†Œì† íŒ€
  - `team_name`: íŒ€ ì´ë¦„
  - `is_approved`: ìŠ¹ì¸ ìƒíƒœ
  - `is_active`: í™œì„±í™” ìƒíƒœ

### 4. memberships (ë©¤ë²„ì‹­)
- **ëª©ì **: ì‚¬ìš©ì-íŒ€ ê´€ê³„ ê´€ë¦¬
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `user_id`: ì‚¬ìš©ì ì°¸ì¡°
  - `team_id`: íŒ€ ì°¸ì¡°
  - `role`: íŒ€ ë‚´ ì—­í•  (leader, member)

### 5. user_settings (ì‚¬ìš©ì ì„¤ì •)
- **ëª©ì **: ê°œì¸í™”ëœ ì‚¬ìš©ì ì„¤ì • ê´€ë¦¬
- **ì£¼ìš” ì„¤ì • ì¹´í…Œê³ ë¦¬**:
  - `notification_preferences`: ì•Œë¦¼ ì„¤ì •
  - `ui_preferences`: UI ì„¤ì •
  - `dashboard_preferences`: ëŒ€ì‹œë³´ë“œ ì„¤ì •
  - `sensor_thresholds`: ì„¼ì„œ ì„ê³„ê°’ ì„¤ì •
  - `telegram_chat_id`: í…”ë ˆê·¸ë¨ ì—°ë™

### 6. user_activity_logs (í™œë™ ë¡œê·¸)
- **ëª©ì **: ì‚¬ìš©ì í™œë™ ì¶”ì  ë° ê°ì‚¬
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `user_id`: ì‚¬ìš©ì ì°¸ì¡°
  - `action`: ìˆ˜í–‰í•œ ì‘ì—…
  - `resource_type`: ì‘ì—… ëŒ€ìƒ íƒ€ì…
  - `details`: ìƒì„¸ ì •ë³´ (JSONB)

## ğŸ”’ ë³´ì•ˆ ì •ì±… (RLS)

### ì‚¬ìš©ì ì •ì±…
- **ìì‹ ì˜ í”„ë¡œí•„ ì¡°íšŒ/ìˆ˜ì •**: ëª¨ë“  ì‚¬ìš©ì
- **ì „ì²´ ì‚¬ìš©ì ì¡°íšŒ**: ì‹œìŠ¤í…œ ê´€ë¦¬ìë§Œ
- **ì „ì²´ ì‚¬ìš©ì ìˆ˜ì •**: ì‹œìŠ¤í…œ ê´€ë¦¬ìë§Œ
- **íŒ€ ë©¤ë²„ ì¡°íšŒ**: íŒ€ ë¦¬ë”ë§Œ

### ì„¤ì • ì •ì±…
- **ìì‹ ì˜ ì„¤ì • ì¡°íšŒ/ìˆ˜ì •**: ëª¨ë“  ì‚¬ìš©ì
- **ì „ì²´ ì„¤ì • ê´€ë¦¬**: ì‹œìŠ¤í…œ ê´€ë¦¬ìë§Œ

### í™œë™ ë¡œê·¸ ì •ì±…
- **ìì‹ ì˜ í™œë™ ë¡œê·¸ ì¡°íšŒ**: ëª¨ë“  ì‚¬ìš©ì
- **ì „ì²´ í™œë™ ë¡œê·¸ ì¡°íšŒ**: ì‹œìŠ¤í…œ ê´€ë¦¬ìë§Œ

## ğŸ› ï¸ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜

### ê¶Œí•œ í™•ì¸ í•¨ìˆ˜
```sql
-- ì‚¬ìš©ì ì—­í•  í™•ì¸
SELECT get_user_role('user-uuid');

-- ì‹œìŠ¤í…œ ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸
SELECT is_system_admin('user-uuid');

-- íŒ€ ë¦¬ë” ì—¬ë¶€ í™•ì¸
SELECT is_team_leader('user-uuid');
```

### ì„¤ì • ê´€ë¦¬ í•¨ìˆ˜
```sql
-- ì‚¬ìš©ì ì„¤ì • ì—…ë°ì´íŠ¸
SELECT update_user_setting(
    'user-uuid',
    'notification',
    'telegram',
    'true'
);

-- ì‚¬ìš©ì ì„¤ì • ì¡°íšŒ
SELECT get_user_setting('user-uuid', 'dashboard');
```

### í™œë™ ë¡œê·¸ í•¨ìˆ˜
```sql
-- ì‚¬ìš©ì í™œë™ ê¸°ë¡
SELECT log_user_activity(
    'user-uuid',
    'login',
    'user',
    'user-uuid',
    '{"ip": "192.168.1.1"}'
);
```

## ğŸ‘¥ í…ŒìŠ¤íŠ¸ ê³„ì • ê¶Œí•œ

### ì‹œìŠ¤í…œ ê´€ë¦¬ì
- `test1@test.com` - í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì
- `admin@smartfarm.com` - ì‹œìŠ¤í…œ ê´€ë¦¬ì
- `velomano@naver.com` - ë²¨ë¡œë§ˆë…¸ (í…Œë¼ í—ˆë¸Œ)
- `sky3rain7@gmail.com` - ì„œì²œìš°

### 1ë†ì¥ íŒ€
- **íŒ€ ë¦¬ë”**: `test2@test.com` - í…ŒìŠ¤íŠ¸ ë†ì¥ì¥
- **íŒ€ ë©¤ë²„**: 
  - `test3@test.com` - í…ŒìŠ¤íŠ¸ íŒ€ì›
  - `user@smartfarm.com` - 1ë†ì¥ íŒ€ì›

### 2ë†ì¥ íŒ€
- **íŒ€ ë¦¬ë”**: `test4@test.com` - 2ë†ì¥ ë†ì¥ì¥
- **íŒ€ ë©¤ë²„**: `test5@test.com` - 2ë†ì¥ íŒ€ì›

### 3ë†ì¥ íŒ€
- **íŒ€ ë¦¬ë”**: `test6@test.com` - 3ë†ì¥ ë†ì¥ì¥
- **íŒ€ ë©¤ë²„**: `test7@test.com` - 3ë†ì¥ íŒ€ì›

## ğŸ”§ ì„¤ì • ì˜ˆì‹œ

### ê¸°ë³¸ ì•Œë¦¼ ì„¤ì •
```json
{
  "email": true,
  "telegram": false,
  "dashboard": true,
  "sensor_alerts": true,
  "system_alerts": true,
  "low_humidity": true,
  "high_temperature": true,
  "water_level": true,
  "ph_alerts": true
}
```

### ê¸°ë³¸ ì„¼ì„œ ì„ê³„ê°’
```json
{
  "temperature": {"min": 15, "max": 35},
  "humidity": {"min": 40, "max": 80},
  "soil_moisture": {"min": 30, "max": 70},
  "ph": {"min": 6.0, "max": 7.5},
  "light": {"min": 200, "max": 1000}
}
```

## ğŸ“ˆ ì„±ëŠ¥ ìµœì í™”

### ì¸ë±ìŠ¤
- `idx_users_role`: ì—­í• ë³„ ì‚¬ìš©ì ì¡°íšŒ ìµœì í™”
- `idx_users_team_id`: íŒ€ë³„ ì‚¬ìš©ì ì¡°íšŒ ìµœì í™”
- `idx_users_is_active`: í™œì„± ì‚¬ìš©ì ì¡°íšŒ ìµœì í™”
- `idx_user_activity_logs_created_at`: í™œë™ ë¡œê·¸ ì‹œê°„ìˆœ ì¡°íšŒ ìµœì í™”

### ìºì‹± ì „ëµ
- ì‚¬ìš©ì ê¶Œí•œ ì •ë³´ëŠ” ì„¸ì…˜ ë™ì•ˆ ìºì‹œ
- íŒ€ ì •ë³´ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ìºì‹œ
- ì„¤ì • ì •ë³´ëŠ” ì‚¬ìš©ìë³„ë¡œ ìºì‹œ

## ğŸš€ í™•ì¥ ê³„íš

### í–¥í›„ ì¶”ê°€ ì˜ˆì •
1. **ì—­í•  ê¸°ë°˜ ê¶Œí•œ ì„¸ë¶„í™”**: ì„¸ë¶€ ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤
2. **API í‚¤ ê¸°ë°˜ ì¸ì¦**: IoT ë””ë°”ì´ìŠ¤ìš©
3. **ê°ì‚¬ ë¡œê·¸ ê°•í™”**: ìƒì„¸í•œ í™œë™ ì¶”ì 
4. **ë©€í‹° í…Œë„ŒíŠ¸ í™•ì¥**: ì—¬ëŸ¬ ì¡°ì§ ì§€ì›
5. **SSO ì—°ë™**: ê¸°ì—…ìš© ë‹¨ì¼ ë¡œê·¸ì¸

## ğŸ” ë¬¸ì œ í•´ê²°

### ì¼ë°˜ì ì¸ ë¬¸ì œ
1. **ê¶Œí•œ ë¶€ì¡± ì˜¤ë¥˜**: ì‚¬ìš©ì ì—­í•  í™•ì¸
2. **ì„¤ì • ì €ì¥ ì‹¤íŒ¨**: RLS ì •ì±… í™•ì¸
3. **í™œë™ ë¡œê·¸ ëˆ„ë½**: í•¨ìˆ˜ ê¶Œí•œ í™•ì¸

### ë””ë²„ê¹… ì¿¼ë¦¬
```sql
-- ì‚¬ìš©ì ê¶Œí•œ í™•ì¸
SELECT u.name, u.role, u.team_name, u.is_active
FROM users u
WHERE u.email = 'user@example.com';

-- íŒ€ ë©¤ë²„ì‹­ í™•ì¸
SELECT t.name as team_name, m.role as membership_role
FROM memberships m
JOIN teams t ON m.team_id = t.id
WHERE m.user_id = 'user-uuid';

-- ìµœê·¼ í™œë™ í™•ì¸
SELECT action, resource_type, created_at
FROM user_activity_logs
WHERE user_id = 'user-uuid'
ORDER BY created_at DESC
LIMIT 10;
```

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025.01.24  
**ë²„ì „**: v1.0  
**ë‹´ë‹¹ì**: ìŠ¤ë§ˆíŠ¸íŒœ ê°œë°œíŒ€

