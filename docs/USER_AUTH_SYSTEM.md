# ğŸ” ì‚¬ìš©ì ê¶Œí•œ ì‹œìŠ¤í…œ ë¬¸ì„œ

## ğŸ“‹ ê°œìš”

ìŠ¤ë§ˆíŠ¸íŒœ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì™„ì „í•œ ì‚¬ìš©ì ê¶Œí•œ ê´€ë¦¬ ì‹œìŠ¤í…œì…ë‹ˆë‹¤. Supabase Authì™€ ì—°ë™í•˜ì—¬ ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´(RBAC)ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

## ğŸ—ï¸ ì‹œìŠ¤í…œ êµ¬ì¡°

### ê³„ì¸µ êµ¬ì¡°
```
í…Œë„ŒíŠ¸ (Tenant)
â”œâ”€â”€ ì†Œì† (Company/Organization)
â”‚   â”œâ”€â”€ ë†ì¥(íŒ€) (Farm/Team) - ê¸°ë³¸ ìš´ì˜ ë‹¨ìœ„
â”‚   â”‚   â”œâ”€â”€ ë†ì¥ì¥ (Team Leader) - ë†ì¥ ì „ì²´ ê´€ë¦¬
â”‚   â”‚   â””â”€â”€ íŒ€ì› (Team Member) - ë†ì¥ ìš´ì˜ ê¶Œí•œ
â”‚   â””â”€â”€ ì‹œìŠ¤í…œê´€ë¦¬ì (System Admin) - ì „ì²´ ì‹œìŠ¤í…œ ê´€ë¦¬
â””â”€â”€ ìµœê³ ê´€ë¦¬ì (Super Admin) - ì „ì²´ ì‹œìŠ¤í…œ ìµœê³  ê´€ë¦¬ì
```

### ê¶Œí•œ ë ˆë²¨ (4ë‹¨ê³„)
1. **super_admin**: ìµœê³ ê´€ë¦¬ì (ì „ì²´ ì‹œìŠ¤í…œ ìµœê³  ê´€ë¦¬ì)
2. **system_admin**: ì‹œìŠ¤í…œê´€ë¦¬ì (ë†ì¥ ìƒì„±/ì‚­ì œ ê¶Œí•œ)
3. **team_leader**: ë†ì¥ì¥ (íŠ¹ì • ë†ì¥ì˜ ëª¨ë“  ê¶Œí•œ)
4. **team_member**: íŒ€ì› (ë†ì¥ ìš´ì˜ ê¶Œí•œ)

## ğŸ“Š í…Œì´ë¸” êµ¬ì¡°

### 1. tenants (í…Œë„ŒíŠ¸)
- **ëª©ì **: ë©€í‹° í…Œë„ŒíŠ¸ ì§€ì›
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `id`: UUID (Primary Key)
  - `name`: í…Œë„ŒíŠ¸ ì´ë¦„
  - `description`: í…Œë„ŒíŠ¸ ì„¤ëª…
  - `is_active`: í™œì„±í™” ìƒíƒœ

### 2. farms (ë†ì¥)
- **ëª©ì **: ë†ì¥ ë‹¨ìœ„ ê´€ë¦¬ (ê¸°ë³¸ ìš´ì˜ ë‹¨ìœ„)
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `id`: UUID (Primary Key)
  - `tenant_id`: í…Œë„ŒíŠ¸ ì°¸ì¡°
  - `name`: ë†ì¥ ì´ë¦„ (ì˜ˆ: "1ë†ì¥", "2ë†ì¥", "3ë†ì¥")
  - `farm_code`: ë†ì¥ ì‹ë³„ ì½”ë“œ (ì˜ˆ: "FARM001", "FARM002", "FARM003")
  - `location`: ë†ì¥ ìœ„ì¹˜
  - `is_active`: í™œì„±í™” ìƒíƒœ

### 3. users (ì‚¬ìš©ì)
- **ëª©ì **: Supabase Authì™€ ì—°ë™ëœ ì‚¬ìš©ì ì •ë³´
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `id`: UUID (auth.users ì°¸ì¡°)
  - `email`: ì´ë©”ì¼ ì£¼ì†Œ
  - `name`: ì‚¬ìš©ì ì´ë¦„
  - `role`: 4ë‹¨ê³„ ê¶Œí•œ ì²´ê³„ (super_admin, system_admin, team_leader, team_member)
  - `team_id`: ì†Œì† íŒ€ ID
  - `team_name`: íŒ€ëª… (ë†ì¥ëª…)
  - `is_approved`: ìŠ¹ì¸ ìƒíƒœ
  - `is_active`: í™œì„±í™” ìƒíƒœ

### 4. teams (íŒ€)
- **ëª©ì **: ë†ì¥ ë‹¨ìœ„ íŒ€ ê´€ë¦¬
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `id`: UUID (Primary Key)
  - `tenant_id`: í…Œë„ŒíŠ¸ ì°¸ì¡°
  - `name`: íŒ€ ì´ë¦„ (ì˜ˆ: "1ë†ì¥", "2ë†ì¥", "3ë†ì¥")
  - `team_code`: íŒ€ ì‹ë³„ ì½”ë“œ (ì˜ˆ: "FARM001", "FARM002", "FARM003")

### 5. memberships (ë©¤ë²„ì‹­)
- **ëª©ì **: ì‚¬ìš©ì-íŒ€ ê´€ê³„ ê´€ë¦¬
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `user_id`: ì‚¬ìš©ì ì°¸ì¡°
  - `team_id`: íŒ€ ì°¸ì¡°
  - `role`: íŒ€ ë‚´ ì—­í•  (owner, operator, viewer)

### 6. user_settings (ì‚¬ìš©ì ì„¤ì •)
- **ëª©ì **: ê°œì¸í™”ëœ ì‚¬ìš©ì ì„¤ì • ê´€ë¦¬
- **ì£¼ìš” ì„¤ì • ì¹´í…Œê³ ë¦¬**:
  - `notification_preferences`: ì•Œë¦¼ ì„¤ì •
  - `ui_preferences`: UI ì„¤ì •
  - `dashboard_preferences`: ëŒ€ì‹œë³´ë“œ ì„¤ì •
  - `sensor_thresholds`: ì„¼ì„œ ì„ê³„ê°’ ì„¤ì •
  - `telegram_chat_id`: í…”ë ˆê·¸ë¨ ì—°ë™

### 6. user_activity_logs (í™œë™ ë¡œê·¸)
- **ëª©ì **: ì‚¬ìš©ì í™œë™ ì¶”ì  ë° ê°ì‚¬
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `user_id`: ì‚¬ìš©ì ì°¸ì¡°
  - `action`: ìˆ˜í–‰í•œ ì‘ì—…
  - `resource_type`: ì‘ì—… ëŒ€ìƒ íƒ€ì…
  - `details`: ìƒì„¸ ì •ë³´ (JSONB)

## ğŸ”’ ë³´ì•ˆ ì •ì±… (RLS)

### ì‚¬ìš©ì ì •ì±…
- **ìì‹ ì˜ í”„ë¡œí•„ ì¡°íšŒ/ìˆ˜ì •**: ëª¨ë“  ì‚¬ìš©ì
- **ì „ì²´ ì‚¬ìš©ì ì¡°íšŒ**: ì‹œìŠ¤í…œ ê´€ë¦¬ìë§Œ
- **ì „ì²´ ì‚¬ìš©ì ìˆ˜ì •**: ì‹œìŠ¤í…œ ê´€ë¦¬ìë§Œ
- **íŒ€ ë©¤ë²„ ì¡°íšŒ**: íŒ€ ë¦¬ë”ë§Œ

### ì„¤ì • ì •ì±…
- **ìì‹ ì˜ ì„¤ì • ì¡°íšŒ/ìˆ˜ì •**: ëª¨ë“  ì‚¬ìš©ì
- **ì „ì²´ ì„¤ì • ê´€ë¦¬**: ì‹œìŠ¤í…œ ê´€ë¦¬ìë§Œ

### í™œë™ ë¡œê·¸ ì •ì±…
- **ìì‹ ì˜ í™œë™ ë¡œê·¸ ì¡°íšŒ**: ëª¨ë“  ì‚¬ìš©ì
- **ì „ì²´ í™œë™ ë¡œê·¸ ì¡°íšŒ**: ì‹œìŠ¤í…œ ê´€ë¦¬ìë§Œ

## ğŸ› ï¸ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜

### ê¶Œí•œ í™•ì¸ í•¨ìˆ˜
```sql
-- ì‚¬ìš©ì ì—­í•  í™•ì¸
SELECT get_user_role('user-uuid');

-- ì‹œìŠ¤í…œ ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸
SELECT is_system_admin('user-uuid');

-- íŒ€ ë¦¬ë” ì—¬ë¶€ í™•ì¸
SELECT is_team_leader('user-uuid');
```

### ì„¤ì • ê´€ë¦¬ í•¨ìˆ˜
```sql
-- ì‚¬ìš©ì ì„¤ì • ì—…ë°ì´íŠ¸
SELECT update_user_setting(
    'user-uuid',
    'notification',
    'telegram',
    'true'
);

-- ì‚¬ìš©ì ì„¤ì • ì¡°íšŒ
SELECT get_user_setting('user-uuid', 'dashboard');
```

### í™œë™ ë¡œê·¸ í•¨ìˆ˜
```sql
-- ì‚¬ìš©ì í™œë™ ê¸°ë¡
SELECT log_user_activity(
    'user-uuid',
    'login',
    'user',
    'user-uuid',
    '{"ip": "192.168.1.1"}'
);
```

## ğŸ‘¥ í…ŒìŠ¤íŠ¸ ê³„ì • ê¶Œí•œ

### ì‹œìŠ¤í…œ ê´€ë¦¬ì
- `test1@test.com` - í…ŒìŠ¤íŠ¸ ê´€ë¦¬ì
- `admin@smartfarm.com` - ì‹œìŠ¤í…œ ê´€ë¦¬ì
- `velomano@naver.com` - ë²¨ë¡œë§ˆë…¸ (í…Œë¼ í—ˆë¸Œ)
- `sky3rain7@gmail.com` - ì„œì²œìš°

### 1ë†ì¥
- **ë†ì¥ì¥**: `test1@test.com` - 1ë†ì¥ ë†ì¥ì¥ (team_leader)
- **íŒ€ì›**: `test2@test.com` - 1ë†ì¥ íŒ€ì› (team_member)

### 2ë†ì¥
- **ë†ì¥ì¥**: `test3@test.com` - 2ë†ì¥ ë†ì¥ì¥ (team_leader)
- **íŒ€ì›**: `test4@test.com` - 2ë†ì¥ íŒ€ì› (team_member)

### 3ë†ì¥
- **ë†ì¥ì¥**: `test5@test.com` - 3ë†ì¥ ë†ì¥ì¥ (team_leader)
- **íŒ€ì›**: `test6@test.com` - 3ë†ì¥ íŒ€ì› (team_member)

## ğŸ”§ ì„¤ì • ì˜ˆì‹œ

### ê¸°ë³¸ ì•Œë¦¼ ì„¤ì •
```json
{
  "email": true,
  "telegram": false,
  "dashboard": true,
  "sensor_alerts": true,
  "system_alerts": true,
  "low_humidity": true,
  "high_temperature": true,
  "water_level": true,
  "ph_alerts": true
}
```

### ê¸°ë³¸ ì„¼ì„œ ì„ê³„ê°’
```json
{
  "temperature": {"min": 15, "max": 35},
  "humidity": {"min": 40, "max": 80},
  "soil_moisture": {"min": 30, "max": 70},
  "ph": {"min": 6.0, "max": 7.5},
  "light": {"min": 200, "max": 1000}
}
```

## ğŸ“ˆ ì„±ëŠ¥ ìµœì í™”

### ì¸ë±ìŠ¤
- `idx_users_role`: ì—­í• ë³„ ì‚¬ìš©ì ì¡°íšŒ ìµœì í™”
- `idx_users_team_id`: íŒ€ë³„ ì‚¬ìš©ì ì¡°íšŒ ìµœì í™”
- `idx_users_is_active`: í™œì„± ì‚¬ìš©ì ì¡°íšŒ ìµœì í™”
- `idx_user_activity_logs_created_at`: í™œë™ ë¡œê·¸ ì‹œê°„ìˆœ ì¡°íšŒ ìµœì í™”

### ìºì‹± ì „ëµ
- ì‚¬ìš©ì ê¶Œí•œ ì •ë³´ëŠ” ì„¸ì…˜ ë™ì•ˆ ìºì‹œ
- íŒ€ ì •ë³´ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ìºì‹œ
- ì„¤ì • ì •ë³´ëŠ” ì‚¬ìš©ìë³„ë¡œ ìºì‹œ

## ğŸš€ í™•ì¥ ê³„íš

### í–¥í›„ ì¶”ê°€ ì˜ˆì •
1. **ì—­í•  ê¸°ë°˜ ê¶Œí•œ ì„¸ë¶„í™”**: ì„¸ë¶€ ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤
2. **API í‚¤ ê¸°ë°˜ ì¸ì¦**: IoT ë””ë°”ì´ìŠ¤ìš©
3. **ê°ì‚¬ ë¡œê·¸ ê°•í™”**: ìƒì„¸í•œ í™œë™ ì¶”ì 
4. **ë©€í‹° í…Œë„ŒíŠ¸ í™•ì¥**: ì—¬ëŸ¬ ì¡°ì§ ì§€ì›
5. **SSO ì—°ë™**: ê¸°ì—…ìš© ë‹¨ì¼ ë¡œê·¸ì¸

## ğŸ” ë¬¸ì œ í•´ê²°

### ì¼ë°˜ì ì¸ ë¬¸ì œ
1. **ê¶Œí•œ ë¶€ì¡± ì˜¤ë¥˜**: ì‚¬ìš©ì ì—­í•  í™•ì¸
2. **ì„¤ì • ì €ì¥ ì‹¤íŒ¨**: RLS ì •ì±… í™•ì¸
3. **í™œë™ ë¡œê·¸ ëˆ„ë½**: í•¨ìˆ˜ ê¶Œí•œ í™•ì¸

### ë””ë²„ê¹… ì¿¼ë¦¬
```sql
-- ì‚¬ìš©ì ê¶Œí•œ í™•ì¸
SELECT u.name, u.role, u.team_name, u.is_active
FROM users u
WHERE u.email = 'user@example.com';

-- íŒ€ ë©¤ë²„ì‹­ í™•ì¸
SELECT t.name as team_name, m.role as membership_role
FROM memberships m
JOIN teams t ON m.team_id = t.id
WHERE m.user_id = 'user-uuid';

-- ìµœê·¼ í™œë™ í™•ì¸
SELECT action, resource_type, created_at
FROM user_activity_logs
WHERE user_id = 'user-uuid'
ORDER BY created_at DESC
LIMIT 10;
```

## ğŸ†• ìµœê·¼ ì—…ë°ì´íŠ¸ (2025.09.28)

### âœ… ìƒˆë¡œ ì¶”ê°€ëœ ê¸°ëŠ¥
- **ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°/ìˆ¨ê¸°ê¸°**: ë¡œê·¸ì¸ ë° ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í˜ì´ì§€ì— ì§ê´€ì ì¸ ëˆˆ ëª¨ì–‘ ì•„ì´ì½˜ ì¶”ê°€
- **ì—ëŸ¬ ë©”ì‹œì§€ í•œê¸€í™”**: Supabase ê¸°ë³¸ ì˜ì–´ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©ì ì¹œí™”ì ì¸ í•œêµ­ì–´ë¡œ ë³€í™˜
- **ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •**: ì´ë©”ì¼ ê¸°ë°˜ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ê¸°ëŠ¥ ì™„ì „ êµ¬í˜„
- **Mock ì¸ì¦ ì‹œìŠ¤í…œ**: ê°œë°œ í™˜ê²½ìš© ëŒ€ì²´ ì¸ì¦ ì‹œìŠ¤í…œ êµ¬ì¶•
- **í™˜ê²½ ë³€ìˆ˜ ì„¤ì •**: Supabase ì—°ê²°ì„ ìœ„í•œ ì™„ì „í•œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
- **RLS ì •ì±… ìµœì í™”**: ì¤‘ë³µ ì •ì±… ì œê±° ë° ë³´ì•ˆ ê°•í™”

### ğŸ”§ ê°œì„ ëœ ê¸°ëŠ¥
- **UserDashboard ì•ˆì •ì„±**: undefined ë°°ì—´ ì˜¤ë¥˜ ìˆ˜ì •ìœ¼ë¡œ ì•ˆì •ì„± ëŒ€í­ í–¥ìƒ
- **ë¡œê·¸ì¸ ì‹œìŠ¤í…œ**: ì™„ì „í•œ Supabase ì¸ì¦ ì‹œìŠ¤í…œ êµ¬ì¶•
- **íšŒì›ê°€ì… í”„ë¡œì„¸ìŠ¤**: ê´€ë¦¬ì ìŠ¹ì¸ ê¸°ë°˜ íšŒì›ê°€ì… ì‹œìŠ¤í…œ

### ğŸ› ìˆ˜ì •ëœ ë²„ê·¸
- **Runtime TypeError**: UserDashboardì—ì„œ undefined ë°°ì—´ì— ëŒ€í•œ filter ì˜¤ë¥˜ í•´ê²°
- **400 Bad Request**: Supabase ì¸ì¦ ì˜¤ë¥˜ í•´ê²°
- **500 Internal Server Error**: RLS ì •ì±… ì¶©ëŒ í•´ê²°

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025.09.28  
**ë²„ì „**: v1.1  
**ë‹´ë‹¹ì**: ìŠ¤ë§ˆíŠ¸íŒœ ê°œë°œíŒ€

