# ğŸŒ‰ MQTT Bridge â†’ Universal Bridge ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš

## ğŸ“‹ ê°œìš”

ê¸°ì¡´ MQTT Bridge(`apps/mqtt-bridge/`)ë¥¼ Universal Bridge(`apps/universal-bridge/`)ë¡œ ì™„ì „ í†µí•©í•˜ëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íšì…ë‹ˆë‹¤.

## ğŸ¯ ëª©í‘œ

- **ë‹¨ì¼ ì‹œìŠ¤í…œ**: í•˜ë‚˜ì˜ Universal Bridgeë¡œ ëª¨ë“  IoT ë””ë°”ì´ìŠ¤ ê´€ë¦¬
- **ë°ì´í„° í†µí•©**: `sensor_readings` â†’ `iot_readings` í†µí•©
- **í† í”½ í‘œì¤€í™”**: `terahub/{tenant}/{deviceId}/...` êµ¬ì¡°ë¡œ í†µì¼
- **ìš´ì˜ ë‹¨ìˆœí™”**: í•˜ë‚˜ì˜ ì„œë¹„ìŠ¤ë§Œ ê´€ë¦¬

---

## ğŸ“Š í˜„ì¬ ìƒí™© ë¶„ì„

### **ê¸°ì¡´ MQTT Bridge**
```
ë””ë°”ì´ìŠ¤ â†’ ì™¸ë¶€ MQTT ë¸Œë¡œì»¤ â†’ MQTT Bridge â†’ Supabase (sensor_readings)
í† í”½: farms/{farmId}/devices/{deviceId}/telemetry
```

### **Universal Bridge**
```
ë””ë°”ì´ìŠ¤ â†’ Universal Bridge (ë‚´ì¥ ë¸Œë¡œì»¤) â†’ Supabase (iot_readings)
í† í”½: terahub/{tenant}/{deviceId}/telemetry
```

---

## ğŸ—ºï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œë“œë§µ

### **Phase 1: ë°ì´í„° í†µí•© (1ì£¼)**
- [ ] `sensor_readings` â†’ `iot_readings` ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
- [ ] ê¸°ì¡´ ë°ì´í„° ë°±ì—… ë° ê²€ì¦
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ (ê°œë°œ í™˜ê²½)
- [ ] í”„ë¡œë•ì…˜ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

### **Phase 2: Universal Bridge MQTT ì§€ì› ê°•í™” (1ì£¼)**
- [ ] ê¸°ì¡´ MQTT Bridge í•¸ë“¤ëŸ¬ë¥¼ Universal Bridgeë¡œ í¬íŒ…
- [ ] `farms/{farmId}/devices/{deviceId}/...` í† í”½ ì§€ì› ì¶”ê°€
- [ ] ê¸°ì¡´ ë””ë°”ì´ìŠ¤ì™€ì˜ í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸
- [ ] MQTT í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ê´€ë¦¬ ê°œì„ 

### **Phase 3: ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜ (2ì£¼)**
- [ ] ê¸°ì¡´ ë””ë°”ì´ìŠ¤ë“¤ì„ Universal Bridgeë¡œ ì—°ê²° ì „í™˜
- [ ] ì´ì¤‘ ìš´ì˜ (ê¸°ì¡´ + ìƒˆ ì‹œìŠ¤í…œ)
- [ ] ëª¨ë‹ˆí„°ë§ ë° ê²€ì¦
- [ ] ë¬¸ì œ ë°œìƒ ì‹œ ë¡¤ë°± ê³„íš

### **Phase 4: ì™„ì „ ì „í™˜ (1ì£¼)**
- [ ] ëª¨ë“  ë””ë°”ì´ìŠ¤ Universal Bridge ì—°ê²° ì™„ë£Œ
- [ ] ê¸°ì¡´ MQTT Bridge ì„œë¹„ìŠ¤ ì¤‘ë‹¨
- [ ] `apps/mqtt-bridge/` í´ë” ì œê±°
- [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸

---

## ğŸ”§ ê¸°ìˆ ì  êµ¬í˜„ ê³„íš

### **1. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜**

```sql
-- sensor_readings â†’ iot_readings ë§ˆì´ê·¸ë ˆì´ì…˜
INSERT INTO iot_readings (device_uuid, key, value, unit, ts, tenant_id)
SELECT 
    d.device_id as device_uuid,
    s.type as key,
    sr.value,
    sr.unit,
    sr.timestamp as ts,
    f.tenant_id
FROM sensor_readings sr
JOIN sensors s ON sr.sensor_id = s.id
JOIN devices d ON s.device_id = d.id
JOIN farms f ON d.farm_id = f.id;
```

### **2. Universal Bridge MQTT í•¸ë“¤ëŸ¬ í™•ì¥**

```typescript
// ê¸°ì¡´ í† í”½ ì§€ì› ì¶”ê°€
const topicMappings = {
  'farms/{farmId}/devices/{deviceId}/telemetry': 'terahub/{tenant}/{deviceId}/telemetry',
  'farms/{farmId}/devices/{deviceId}/registry': 'terahub/{tenant}/{deviceId}/registry',
  'farms/{farmId}/devices/{deviceId}/state': 'terahub/{tenant}/{deviceId}/state'
};
```

### **3. ì´ì¤‘ í† í”½ ì§€ì›**

Universal Bridgeì—ì„œ ë‘ ê°€ì§€ í† í”½ êµ¬ì¡°ë¥¼ ëª¨ë‘ ì§€ì›:

```typescript
// ê¸°ì¡´ í† í”½ (í•˜ìœ„ í˜¸í™˜ì„±)
client.subscribe('farms/+/+/+/+', handler);

// ìƒˆë¡œìš´ í† í”½ (í‘œì¤€)
client.subscribe('terahub/+/+/+/+', handler);
```

---

## ğŸ“ˆ ì„±ê³µ ì§€í‘œ

### **ê¸°ìˆ ì  ì§€í‘œ**
- [ ] ëª¨ë“  ê¸°ì¡´ ì„¼ì„œ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ
- [ ] ê¸°ì¡´ ë””ë°”ì´ìŠ¤ 100% Universal Bridge ì—°ê²°
- [ ] ë°ì´í„° ì†ì‹¤ 0%
- [ ] ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì‹œê°„ < 30ë¶„

### **ìš´ì˜ ì§€í‘œ**
- [ ] ì„œë¹„ìŠ¤ ê´€ë¦¬ ë³µì¡ë„ 50% ê°ì†Œ
- [ ] ë°°í¬ ì‹œê°„ 50% ë‹¨ì¶•
- [ ] ëª¨ë‹ˆí„°ë§ í¬ì¸íŠ¸ 50% ê°ì†Œ
- [ ] ë¬¸ì„œ ìœ ì§€ë³´ìˆ˜ ë¶€ë‹´ ê°ì†Œ

---

## âš ï¸ ìœ„í—˜ ìš”ì†Œ ë° ëŒ€ì‘ ë°©ì•ˆ

### **ë†’ì€ ìœ„í—˜ë„**
1. **ë°ì´í„° ì†ì‹¤**: ë°±ì—… + ë‹¨ê³„ì  ë§ˆì´ê·¸ë ˆì´ì…˜
2. **ì„œë¹„ìŠ¤ ì¤‘ë‹¨**: ì´ì¤‘ ìš´ì˜ + ë¡¤ë°± ê³„íš
3. **ë””ë°”ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨**: í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸ + ì ì§„ì  ì „í™˜

### **ì¤‘ê°„ ìœ„í—˜ë„**
1. **ì„±ëŠ¥ ì €í•˜**: ë¶€í•˜ í…ŒìŠ¤íŠ¸ + ëª¨ë‹ˆí„°ë§
2. **í† í”½ ì¶©ëŒ**: ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¶„ë¦¬
3. **ì¸ì¦ ë¬¸ì œ**: JWT í† í° í˜¸í™˜ì„± í™•ì¸

### **ë‚®ì€ ìœ„í—˜ë„**
1. **ë¬¸ì„œ ì—…ë°ì´íŠ¸**: ë‹¨ê³„ì  ë¬¸ì„œí™”
2. **íŒ€ êµìœ¡**: ê¸°ìˆ  ì „ë‹¬ ì„¸ì…˜

---

## ğŸ“… ì¼ì •í‘œ

| ì£¼ì°¨ | ì‘ì—… ë‚´ìš© | ë‹´ë‹¹ì | ì‚°ì¶œë¬¼ |
|------|-----------|--------|--------|
| 1ì£¼ | ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ | ë°±ì—”ë“œ | ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ |
| 2ì£¼ | Universal Bridge í™•ì¥ | ë°±ì—”ë“œ | MQTT í•¸ë“¤ëŸ¬ |
| 3ì£¼ | ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜ | ì „ì²´ | í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ |
| 4ì£¼ | ì™„ì „ ì „í™˜ | ì „ì²´ | ì™„ë£Œ ë³´ê³ ì„œ |

---

## ğŸ‰ ê¸°ëŒ€ íš¨ê³¼

### **ë‹¨ê¸° íš¨ê³¼**
- ìš´ì˜ ë³µì¡ë„ ê°ì†Œ
- ì‹œìŠ¤í…œ í†µí•©ì„± í–¥ìƒ
- ìœ ì§€ë³´ìˆ˜ ë¶€ë‹´ ê°ì†Œ

### **ì¥ê¸° íš¨ê³¼**
- ìƒˆë¡œìš´ í”„ë¡œí† ì½œ ì¶”ê°€ ìš©ì´ì„±
- í™•ì¥ì„± í–¥ìƒ
- ê°œë°œ ìƒì‚°ì„± ì¦ëŒ€
- ê¸°ìˆ  ë¶€ì±„ ê°ì†Œ

---

**ì‘ì„±ì¼**: 2025-01-15  
**ë²„ì „**: 1.0  
**ìƒíƒœ**: ê³„íš ë‹¨ê³„
