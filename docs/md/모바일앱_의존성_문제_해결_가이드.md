# 📱 모바일앱 의존성 문제 해결 가이드

## 📋 문제 상황

### 발생한 에러들
1. **Metro HMR 클라이언트 에러**
   ```
   Module not found: Can't resolve '@expo/metro/metro-runtime/modules/HMRClient'
   ```

2. **Styleq transform-localize-style 에러**
   ```
   Module not found: Can't resolve 'styleq/transform-localize-style'
   ```

3. **Expo 버전 충돌**
   ```
   peer expo@"^49.0.7 || ^50.0.0-0" from @expo/webpack-config@19.0.1
   Found: expo@54.0.10
   ```

4. **기타 누락된 패키지들**
   - `scheduler`, `webidl-conversions`, `punycode`, `buffer`
   - `base64-js`, `ieee754`, `hyphenate-style-name`
   - `css-in-js-utils`, `styleq`

## 🔧 해결 과정

### 1단계: 문제 패키지 제거
```bash
# @expo/webpack-config 제거 (SDK 54에서는 불필요)
npm uninstall @expo/webpack-config

# 제거 확인
npm ls @expo/webpack-config
```

### 2단계: app.json 확인
- `app.json`에 webpack 설정이 없음을 확인
- 추가 수정 불필요

### 3단계: metro.config.js 생성
```javascript
// metro.config.js (Expo SDK 54)
const { getDefaultConfig } = require('expo/metro-config');

const config = getDefaultConfig(__dirname);

// pnpm / 모노레포에서 심볼릭 링크 해석
config.resolver.unstable_enableSymlinks = true;
config.resolver.unstable_conditionNames = [
  'require',
  'react-native',
  'browser',
  'import',
];

// HMRClient 같은 네이티브 전용 모듈을 웹에서 비우기(스텁)
config.resolver.alias = {
  ...(config.resolver.alias || {}),
  '@expo/metro/metro-runtime/modules/HMRClient': require.resolve(
    'metro-runtime/src/modules/empty-module.js'
  ),
};

module.exports = config;
```

### 4단계: 의존성 정렬 및 패키지 설치
```bash
# Expo SDK에 맞춰 정렬
npx expo install --fix

# Metro 관련 패키지
npm i -D @expo/metro @expo/metro-runtime

# 누락된 패키지들
npm i styleq
npm i -D @types/react@~19.1.10

# react-native-web 설치
npx expo install react-native-web
```

### 5단계: 캐시 클리어 후 재시작
```bash
npx expo start --web --clear
```

## 🎯 핵심 해결 포인트

### 1. Metro 설정 최적화
- **심볼릭 링크 해석** 활성화로 pnpm 모노레포 호환성 확보
- **HMRClient 스텁** 설정으로 웹 환경에서 네이티브 모듈 에러 방지

### 2. 패키지 버전 정렬
- **Expo SDK 54**에 맞춰 모든 의존성 버전 통일
- **@expo/webpack-config** 제거 (SDK 54에서는 Metro 사용)

### 3. 누락 패키지 보완
- **React Native Web** 관련 모든 의존성 설치
- **Buffer, URL 처리** 관련 polyfill 패키지 설치

## 📊 결과

### 해결 전
- ❌ **12개 빌드 에러**
- ❌ **Metro HMR 클라이언트** 모듈 없음
- ❌ **Styleq transform-localize-style** 모듈 없음
- ❌ **Expo 버전 충돌**

### 해결 후
- ✅ **0개 빌드 에러**
- ✅ **정상적인 앱 실행**
- ✅ **Supabase 연결 성공**
- ✅ **Tuya SDK Mock 모드 실행**

## 🚀 실행 결과

```
✅ Supabase URL: https://kkrcwdybrsppbsufrrdg.supabase.co
✅ Supabase Key: 설정됨
✅ Tuya SDK 초기화: {appKey: 'we85jqprtfpm5pkmyr53', ...}
✅ Mock Tuya SDK 초기화 완료
```

## 📝 주의사항

### Windows + pnpm 모노레포 환경
- **심볼릭 링크** 문제가 자주 발생
- **metro.config.js**에서 `unstable_enableSymlinks: true` 설정 필수

### Expo SDK 54 변경사항
- **@expo/webpack-config** 사용 중단
- **Metro**를 웹 빌드에도 사용
- **@expo/metro-runtime** 패키지 필요

### 개발 환경 설정
- **React DevTools** 설치 권장
- **VirtualizedList wheel event** 경고는 성능 최적화용 (무시 가능)

## 🔄 향후 유지보수

### 새로운 의존성 추가 시
1. `npx expo install --fix` 실행
2. `metro.config.js` 설정 확인
3. 캐시 클리어 후 재시작

### 에러 발생 시
1. `node_modules` 삭제 후 재설치
2. `metro.config.js` 설정 확인
3. Expo SDK 버전 호환성 확인

---

**작성일**: 2025-09-24  
**해결자**: AI Assistant  
**환경**: Windows 10, pnpm, Expo SDK 54, React Native Web
