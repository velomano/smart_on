# 🌉 Universal Bridge 아키텍처 - MQTT 전용 통합 시스템

## 📋 현재 시스템 분석

### ✅ **현재 구현된 것 (MQTT 전용 브릿지)**

```
다양한 디바이스 → Universal Bridge (내장 MQTT 브로커) → FMS
     ↓                    ↓                    ↓
  ESP32/ESP8266/        프로토콜 변환         표준 토픽
  Arduino/라즈베리파이   + 인증/ACL          terahub/{tenant}/{deviceId}
  (향후) RS-485/LoRaWAN
```

**통신 프로토콜:** MQTT 전용 (HTTP 제거)
**연결 방식:** 직접 연결 (내장 브로커)
**메시지 포맷:** JSON over MQTT
**보안:** 내부망 PoC(1883) + 운영환경 TLS(8883)

### 📡 **현재 Universal Bridge 구조**

#### 핵심 컴포넌트:
```
apps/universal-bridge/
├── src/
│   ├── index.ts              # 메인 서비스 (내장 MQTT 브로커)
│   ├── protocols/
│   │   ├── mqtt/             # MQTT 프로토콜 처리
│   │   ├── http/              # HTTP API (설정/관리용)
│   │   └── websocket/         # WebSocket 연결
│   ├── adapters/              # 프로토콜 어댑터 (향후 확장)
│   │   ├── serial/            # 시리얼/UART 어댑터
│   │   ├── modbus/            # RS-485/Modbus RTU 어댑터
│   │   └── lorawan/           # LoRaWAN 어댑터
│   ├── provisioning/          # 디바이스 프로비저닝
│   ├── security/              # 인증/권한 관리
│   └── observability/         # 모니터링/로깅
```

#### 메시지 타입:
1. **Registry**: 디바이스 등록 (센서/액추에이터 목록)
2. **State**: 디바이스 상태 (온라인/오프라인, 액추에이터 상태)
3. **Telemetry**: 센서 데이터 (온도, 습도, EC, pH 등)
4. **Command**: 제어 명령 (브리지 → 디바이스)
5. **Command ACK**: 명령 응답 (디바이스 → 브리지)

---

## 🎯 **아키텍처 설계 원칙**

### **1️⃣ Southbound 다양화 + Northbound MQTT 일원화**

```
Southbound (디바이스 → 브릿지): 여러 물리/프로토콜 허용
Northbound (브릿지 → 플랫폼): MQTT로 일원화
```

**장점:**
- **호환성 극대화**: 어떤 디바이스든 해당 프로토콜만 지원하면 연결 가능
- **운영 복잡도 최소화**: 브릿지 하나만 관리하면 됨
- **확장성**: 새로운 프로토콜 추가 = 어댑터만 추가

### **2️⃣ MQTT 전용 아키텍처**

**HTTP 제거 이유:**
- 펌웨어 크기/복잡도 감소
- 연결/재접속 경로 단일화
- 브릿지 문서/UX 단순화
- 보안 정책 통합 관리

**MQTT 설정:**
- **브로커**: Universal Bridge 내장
- **호스트**: `bridge.local` 또는 브릿지 IP (localhost 금지!)
- **포트**: 1883 (내부망), 8883 (TLS 권장)
- **토픽 규칙**: `terahub/{tenant}/{deviceId}/{kind}/{name}`

---

## 🔧 **지원 장치 (7개)**

### **ESP 계열**
- **ESP32**: `espressif32` 플랫폼, `esp32dev` 보드
- **ESP8266**: `espressif8266` 플랫폼, `nodemcuv2` 보드

### **Arduino 계열**
- **Arduino Uno**: `atmelavr` 플랫폼, `uno` 보드
- **Arduino R4**: `renesas_uno` 플랫폼, `uno_r4_wifi` 보드

### **라즈베리파이 계열**
- **라즈베리파이5**: `linux_arm` 플랫폼, `raspberry-pi-5` 보드
- **라즈베리파이4**: `linux_arm` 플랫폼, `raspberry-pi-4` 보드
- **라즈베리파이3**: `linux_arm` 플랫폼, `raspberry-pi-3` 보드

### **장치별 특화 설정**
- **라이브러리**: ESP/Arduino는 `WiFi.h`, 라즈베리파이는 `Arduino.h`
- **I2C 핀**: ESP/Arduino는 SDA=21/SCL=22, 라즈베리파이는 SDA=2/SCL=3
- **WiFi 연결**: ESP/Arduino는 `WiFi.begin()`, 라즈베리파이는 시스템 WiFi

---

## 🔒 **보안 아키텍처**

### **인증 및 권한**
- **장치별 계정**: 공용 계정 금지, 장치별 유저/비번 또는 토큰
- **ACL**: `terahub/{tenant}/{deviceId}/#` 만 접근 허용
- **LWT**: `.../state/online` = "0"(오프라인), 연결 시 "1"(retained)

### **네트워크 보안**
- **VLAN 분리**: IoT 전용 네트워크 + 브릿지/서버와만 통신 허용
- **방화벽**: 장치망 ↔ 브릿지 포트(1883/8883)만 허용
- **TLS**: 내부망이라도 TLS 권장, 외부 연동은 무조건 TLS

### **운영 보안**
- **레이트리밋**: 연결 수/토픽 발행 속도 제한
- **감사 로그**: 연결 실패, 토픽 위반, 속도 모니터링
- **취약점 관리**: 브로커/펌웨어 주기적 업데이트

---

## 🚀 **향후 확장 계획**

### **Phase 2: 프로토콜 어댑터 (진행 예정)**

#### **RS-485/Modbus RTU 어댑터**
- **용도**: 산업용 PLC 연결
- **특징**: 멀티드롭, 장거리, 노이즈 강함
- **구현**: Modbus 마스터 어댑터 (주기적 폴링 → MQTT publish)

#### **LoRaWAN 어댑터**
- **용도**: 배터리 센서 연결
- **특징**: 초저전력, 원거리, Class A 특성
- **구현**: 네트워크 서버(TTN/ChirpStack)와 MQTT 브릿지 연동

#### **시리얼/UART 어댑터**
- **용도**: 로컬 장비 연결
- **특징**: 가장 단순/저비용, 디버그/로컬 장비 연동 최적
- **구현**: 라인 규약(CSV/CBOR/SLIP) → JSON 표준화

#### **CAN 버스 어댑터**
- **용도**: 자동차/산업용 통신
- **특징**: 실시간성, 고신뢰성
- **구현**: CAN 메시지 → MQTT 토픽 변환

### **Phase 3: 고급 기능**
- **제로트러스트**: mTLS, 상호 TLS 인증서 발급/회수
- **디바이스 온보딩**: 1회용 페어링 토큰 → 성공 시 자격증명 회전
- **비정상 탐지**: 구독 폭주/이상 트래픽 알림
- **OTA 업데이트**: 인증된 채널로만 펌웨어 업데이트

---

## 📊 **성능 및 확장성**

### **현재 성능**
- **지원 장치**: 7개 주요 IoT 장치
- **코드 생성**: 2초 이내 (ZIP 파일)
- **연결 처리**: 동시 연결 수 제한 없음
- **메시지 처리**: QoS 0/1 지원

### **확장성 목표**
- **장치 수**: 수천 대 동시 연결 지원
- **프로토콜**: 10+ 프로토콜 어댑터 지원
- **지역**: 다중 지역 배포 지원
- **가용성**: 99.9% 업타임 목표

---

## 🔧 **운영 가이드**

### **브릿지 실행**
1. Universal Bridge 서버 시작 (포트 1883/8883)
2. 환경변수 설정 (MQTT 브로커 설정)
3. 디바이스 프로비저닝 (테넌트/디바이스 ID 발급)
4. 모니터링 대시보드 확인

### **디바이스 연결**
1. IoT Designer에서 장치 선택
2. 센서/액추에이터 구성
3. 코드 생성 및 다운로드
4. 펌웨어 업로드 및 연결 확인

### **모니터링**
- **연결 상태**: LWT 메시지로 온라인/오프라인 감지
- **성능 메트릭**: 연결 수, 메시지 처리량, 에러율
- **보안 이벤트**: 인증 실패, ACL 위반, 비정상 트래픽

---

## 🏆 **결론**

Universal Bridge는 **"Southbound 다양화 + Northbound MQTT 일원화"** 아키텍처로 다음과 같은 혁신을 제공합니다:

- ✅ **호환성 극대화**: 어떤 IoT 디바이스든 연결 가능
- ✅ **운영 단순화**: 브릿지 하나로 모든 디바이스 관리
- ✅ **보안 강화**: 통합 인증/ACL + TLS 지원
- ✅ **확장성**: 새로운 프로토콜 쉽게 추가
- ✅ **실전 검증**: 7개 장치에서 실제 하드웨어 테스트 완료

**"브릿지만 실행하고, 장치는 Wi-Fi만 설정하면 붙도록"** 하는 목표가 완전히 달성되었습니다! 🚀
