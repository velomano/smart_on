# ğŸ”§ ìŠ¤ë§ˆíŠ¸íŒœ ì‹œìŠ¤í…œ ê¸°ìˆ  ì•„í‚¤í…ì²˜

## ğŸ“‹ ëª©ì°¨
1. [ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê°œìš”](#ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜-ê°œìš”)
2. [ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„](#ë°ì´í„°ë² ì´ìŠ¤-ì„¤ê³„)
3. [MQTT í†µì‹  í”„ë¡œí† ì½œ](#mqtt-í†µì‹ -í”„ë¡œí† ì½œ)
4. [ë² ë“œ ì‹œìŠ¤í…œ ì„¤ê³„](#ë² ë“œ-ì‹œìŠ¤í…œ-ì„¤ê³„)
5. [API êµ¬ì¡°](#api-êµ¬ì¡°)
6. [ë³´ì•ˆ ë° ì¸ì¦](#ë³´ì•ˆ-ë°-ì¸ì¦)
7. [ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…](#ëª¨ë‹ˆí„°ë§-ë°-ë¡œê¹…)
8. [ë°°í¬ ë° í™•ì¥ì„±](#ë°°í¬-ë°-í™•ì¥ì„±)

---

## ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê°œìš”

### **ì „ì²´ ì‹œìŠ¤í…œ êµ¬ì„±**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   ëŒ€ì‹œë³´ë“œ   â”‚  â”‚  ë†ì¥ê´€ë¦¬   â”‚  â”‚  ì‚¬ìš©ìê´€ë¦¬  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Supabase ë°±ì—”ë“œ                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   PostgreSQLâ”‚  â”‚   Auth      â”‚  â”‚   RLS      â”‚         â”‚
â”‚  â”‚   Database  â”‚  â”‚   System    â”‚  â”‚   Policies  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MQTT í†µì‹  ë ˆì´ì–´                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   MQTT      â”‚  â”‚   WebSocket â”‚  â”‚   JSON      â”‚         â”‚
â”‚  â”‚   Broker    â”‚  â”‚   Client    â”‚  â”‚   Protocol  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   í•˜ë“œì›¨ì–´ ë ˆì´ì–´                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   ì•„ë‘ì´ë…¸   â”‚  â”‚ ë¼ì¦ˆë² ë¦¬íŒŒì´ â”‚  â”‚   ì„¼ì„œ/     â”‚         â”‚
â”‚  â”‚   (ì„¼ì„œ)    â”‚  â”‚   (ì œì–´)    â”‚  â”‚  ì•¡ì¶”ì—ì´í„°  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **ë°ì´í„° íë¦„**
1. **ì„¼ì„œ ë°ì´í„°**: ì•„ë‘ì´ë…¸ â†’ ë¼ì¦ˆë² ë¦¬íŒŒì´ â†’ MQTT â†’ ì›¹ì•±
2. **ì œì–´ ëª…ë ¹**: ì›¹ì•± â†’ MQTT â†’ ë¼ì¦ˆë² ë¦¬íŒŒì´ â†’ ì•¡ì¶”ì—ì´í„°
3. **ì‚¬ìš©ì ë°ì´í„°**: ì›¹ì•± â†’ Supabase â†’ PostgreSQL
4. **ì‹¤ì‹œê°„ í†µì‹ **: WebSocketì„ í†µí•œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸

---

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

### **í•µì‹¬ í…Œì´ë¸” êµ¬ì¡°**

#### **ë†ì¥ ê´€ë¦¬**
```sql
-- ë†ì¥ ì •ë³´
CREATE TABLE farms (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  location VARCHAR(200),
  description TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ë””ë°”ì´ìŠ¤ (ë² ë“œ) ì •ë³´
CREATE TABLE devices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  farm_id UUID REFERENCES farms(id),
  bed_id UUID, -- ë² ë“œë³„ ê³ ìœ  ID
  type VARCHAR(50) NOT NULL, -- 'sensor_gateway'
  meta JSONB, -- ë² ë“œ ë©”íƒ€ë°ì´í„°
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### **ì‚¬ìš©ì ê´€ë¦¬**
```sql
-- ì‚¬ìš©ì ì •ë³´
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  phone VARCHAR(20),
  company VARCHAR(100),
  is_approved BOOLEAN DEFAULT FALSE,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ë©¤ë²„ì‹­ (ê¶Œí•œ ê´€ë¦¬)
CREATE TABLE memberships (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  role VARCHAR(50) NOT NULL, -- 'system_admin', 'team_leader', 'team_member'
  tenant_id UUID REFERENCES farms(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- ì‚¬ìš©ì ì„¤ì •
CREATE TABLE user_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  notification_preferences JSONB,
  telegram_chat_id VARCHAR(100),
  ui_preferences JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### **ì„¼ì„œ ë°ì´í„°**
```sql
-- ì„¼ì„œ ì •ë³´
CREATE TABLE sensors (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  device_id UUID REFERENCES devices(id),
  sensor_type VARCHAR(50) NOT NULL, -- 'temperature', 'humidity', 'ec', 'ph'
  sensor_id VARCHAR(100), -- í•˜ë“œì›¨ì–´ ì„¼ì„œ ID
  tier_number INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ì„¼ì„œ ì¸¡ì •ê°’
CREATE TABLE sensor_readings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sensor_id UUID REFERENCES sensors(id),
  value DECIMAL(10,2) NOT NULL,
  unit VARCHAR(20) NOT NULL,
  quality VARCHAR(20) DEFAULT 'good', -- 'good', 'warning', 'error'
  raw_value DECIMAL(10,2),
  created_at TIMESTAMP DEFAULT NOW()
);
```

### **RLS (Row Level Security) ì •ì±…**
```sql
-- ë†ì¥ ë°ì´í„° ì ‘ê·¼ ì œì–´
CREATE POLICY "Users can view farms in their tenant" ON farms
  FOR SELECT USING (
    id IN (
      SELECT tenant_id FROM memberships 
      WHERE user_id = auth.uid()
    )
  );

-- ë””ë°”ì´ìŠ¤ ë°ì´í„° ì ‘ê·¼ ì œì–´
CREATE POLICY "Users can view devices in their farms" ON devices
  FOR SELECT USING (
    farm_id IN (
      SELECT tenant_id FROM memberships 
      WHERE user_id = auth.uid()
    )
  );
```

---

## ğŸ“¡ MQTT í†µì‹  í”„ë¡œí† ì½œ

### **í† í”½ êµ¬ì¡° ì •ì˜**
```typescript
// ê¸°ë³¸ í† í”½ íŒ¨í„´
const TOPIC_PATTERNS = {
  sensorData: "farm/{farmId}/bed/{bedId}/tier/{tierNumber}/sensor/{sensorType}",
  controlCommand: "farm/{farmId}/bed/{bedId}/control/{switchId}",
  statusResponse: "farm/{farmId}/bed/{bedId}/status/{switchId}",
  systemStatus: "farm/{farmId}/system/{deviceType}"
};

// ì‹¤ì œ í† í”½ ì˜ˆì‹œ
const EXAMPLES = {
  sensorData: "farm/farm_a/bed/bed_1/tier/tier_1/sensor/temperature",
  controlCommand: "farm/farm_a/bed/bed_1/control/pump_1",
  statusResponse: "farm/farm_a/bed/bed_1/status/pump_1",
  systemStatus: "farm/farm_a/system/arduino"
};
```

### **ë©”ì‹œì§€ ìŠ¤í‚¤ë§ˆ**

#### **ì„¼ì„œ ë°ì´í„° (ë†ì¥ â†’ ì›¹ì•±)**
```json
{
  "topic": "farm/farm_a/bed/bed_1/tier/tier_1/sensor/temperature",
  "payload": {
    "farm_id": "farm_a",
    "bed_id": "bed_1",
    "tier_number": 1,
    "sensor_type": "temperature",
    "value": 25.5,
    "unit": "Â°C",
    "quality": "good",
    "timestamp": "2024-01-01T12:00:00.000Z",
    "raw_value": 25.3,
    "calibration_offset": 0.2
  }
}
```

#### **ì œì–´ ëª…ë ¹ (ì›¹ì•± â†’ ë†ì¥)**
```json
{
  "topic": "farm/farm_a/bed/bed_1/control/pump_1",
  "payload": {
    "farm_id": "farm_a",
    "bed_id": "bed_1",
    "switch_id": "pump_1",
    "command": "on",
    "duration": 300,
    "priority": "normal",
    "user_id": "user_123",
    "timestamp": "2024-01-01T12:00:00.000Z",
    "reason": "ì–‘ì•¡ ê³µê¸‰",
    "safety_check": true
  }
}
```

### **MQTT í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„**
```typescript
class MqttClient {
  private client: any;
  private subscriptions: Map<string, Function> = new Map();

  async connect(config: FarmMqttConfig) {
    this.client = mqtt.connect(config.mqttServer.brokerUrl, {
      port: config.mqttServer.port,
      username: config.mqttServer.username,
      password: config.mqttServer.password,
      keepalive: config.mqttServer.keepAlive,
      qos: config.mqttServer.qos
    });

    this.client.on('connect', () => {
      console.log('MQTT ì—°ê²°ë¨');
      this.resubscribeAll();
    });

    this.client.on('message', (topic: string, message: Buffer) => {
      this.handleMessage(topic, message.toString());
    });
  }

  subscribe(topic: string, callback: Function) {
    this.client.subscribe(topic);
    this.subscriptions.set(topic, callback);
  }

  publish(topic: string, payload: any) {
    const message = typeof payload === 'string' ? payload : JSON.stringify(payload);
    this.client.publish(topic, message);
  }

  private handleMessage(topic: string, message: string) {
    const callback = this.subscriptions.get(topic);
    if (callback) {
      try {
        const data = JSON.parse(message);
        callback(data);
      } catch (error) {
        console.error('ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', error);
      }
    }
  }
}
```

---

## ğŸ—ï¸ ë² ë“œ ì‹œìŠ¤í…œ ì„¤ê³„

### **ë² ë“œ êµ¬ì¡° ë°ì´í„° ëª¨ë¸**
```typescript
interface BedTierSystem {
  bedId: string;
  bedName: string;
  farmId: string;
  totalTiers: number;
  tiers: {
    [tierNumber: number]: {
      tierNumber: number;
      sensors: TierSensor[];
      plantCount: number;
      hasPlants: boolean;
    };
  };
  controlSwitches: ControlSwitch[];
  mqttConfig: {
    baseTopic: string;
    qos: 0 | 1 | 2;
  };
}

interface TierSensor {
  sensorId: string;
  sensorType: string;
  lastReading?: {
    value: number;
    unit: string;
    timestamp: Date;
  };
}

interface ControlSwitch {
  switchId: string;
  switchName: string;
  switchType: string;
  currentState: 'on' | 'off';
  lastCommand?: {
    state: 'on' | 'off';
    timestamp: Date;
  };
}
```

### **ë² ë“œ ì‹œìŠ¤í…œ ê´€ë¦¬ í•¨ìˆ˜**
```typescript
export function initializeBedSystem(
  bedId: string,
  bedName: string,
  totalTiers: number,
  farmId: string
): BedTierSystem {
  const tiers: { [key: number]: any } = {};
  for (let i = 1; i <= totalTiers; i++) {
    tiers[i] = {
      tierNumber: i,
      sensors: [],
      plantCount: 0,
      hasPlants: false
    };
  }

  return {
    bedId,
    bedName,
    farmId,
    totalTiers,
    tiers,
    controlSwitches: [],
    mqttConfig: {
      baseTopic: `farm/${farmId}/bed/${bedId}`,
      qos: 1
    }
  };
}

export function addSensorToTier(
  bedSystem: BedTierSystem,
  tierNumber: number,
  sensorType: string,
  sensorId: string
): BedTierSystem {
  const updatedTiers = { ...bedSystem.tiers };
  const tier = updatedTiers[tierNumber];
  
  if (tier) {
    const newSensor: TierSensor = {
      sensorId,
      sensorType
    };
    
    updatedTiers[tierNumber] = {
      ...tier,
      sensors: [...tier.sensors, newSensor]
    };
  }
  
  return {
    ...bedSystem,
    tiers: updatedTiers
  };
}
```

---

## ğŸ”Œ API êµ¬ì¡°

### **REST API ì—”ë“œí¬ì¸íŠ¸**
```typescript
// ë†ì¥ ê´€ë¦¬
GET    /api/farms              // ë†ì¥ ëª©ë¡ ì¡°íšŒ
POST   /api/farms              // ë†ì¥ ìƒì„±
PUT    /api/farms/:id          // ë†ì¥ ì •ë³´ ìˆ˜ì •
DELETE /api/farms/:id          // ë†ì¥ ì‚­ì œ

// ë² ë“œ ê´€ë¦¬
GET    /api/farms/:farmId/beds // ë†ì¥ë³„ ë² ë“œ ëª©ë¡
POST   /api/farms/:farmId/beds // ë² ë“œ ìƒì„±
PUT    /api/beds/:id           // ë² ë“œ ì •ë³´ ìˆ˜ì •
DELETE /api/beds/:id           // ë² ë“œ ì‚­ì œ

// ì„¼ì„œ ê´€ë¦¬
GET    /api/beds/:bedId/sensors    // ë² ë“œ ì„¼ì„œ ëª©ë¡
POST   /api/beds/:bedId/sensors    // ì„¼ì„œ ì¶”ê°€
DELETE /api/sensors/:id            // ì„¼ì„œ ì‚­ì œ

// ì œì–´ ìŠ¤ìœ„ì¹˜ ê´€ë¦¬
GET    /api/beds/:bedId/switches   // ë² ë“œ ìŠ¤ìœ„ì¹˜ ëª©ë¡
POST   /api/beds/:bedId/switches   // ìŠ¤ìœ„ì¹˜ ì¶”ê°€
PUT    /api/switches/:id/toggle    // ìŠ¤ìœ„ì¹˜ í† ê¸€
DELETE /api/switches/:id           // ìŠ¤ìœ„ì¹˜ ì‚­ì œ

// MQTT ì„¤ì •
GET    /api/farms/:id/mqtt-config  // MQTT ì„¤ì • ì¡°íšŒ
PUT    /api/farms/:id/mqtt-config  // MQTT ì„¤ì • ìˆ˜ì •
POST   /api/farms/:id/mqtt-test    // MQTT ì—°ê²° í…ŒìŠ¤íŠ¸
```

### **ì‹¤ì‹œê°„ API (WebSocket)**
```typescript
// ì„¼ì„œ ë°ì´í„° ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼
ws://localhost:3000/ws/sensor-data/:farmId/:bedId

// ì œì–´ ëª…ë ¹ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼
ws://localhost:3000/ws/control-commands/:farmId/:bedId

// ì‹œìŠ¤í…œ ìƒíƒœ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼
ws://localhost:3000/ws/system-status/:farmId
```

### **API ì‘ë‹µ í˜•ì‹**
```typescript
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
    details?: any;
  };
  meta?: {
    timestamp: string;
    requestId: string;
    pagination?: {
      page: number;
      limit: number;
      total: number;
    };
  };
}

// ì„±ê³µ ì‘ë‹µ ì˜ˆì‹œ
{
  "success": true,
  "data": {
    "bedId": "bed_1",
    "bedName": "ë² ë“œ-1",
    "totalTiers": 3,
    "sensors": [...],
    "controlSwitches": [...]
  },
  "meta": {
    "timestamp": "2024-01-01T12:00:00.000Z",
    "requestId": "req_123456"
  }
}

// ì˜¤ë¥˜ ì‘ë‹µ ì˜ˆì‹œ
{
  "success": false,
  "error": {
    "code": "MQTT_CONNECTION_FAILED",
    "message": "MQTT ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤",
    "details": {
      "brokerUrl": "mqtt://invalid-server.com",
      "port": 1883
    }
  },
  "meta": {
    "timestamp": "2024-01-01T12:00:00.000Z",
    "requestId": "req_123456"
  }
}
```

---

## ğŸ” ë³´ì•ˆ ë° ì¸ì¦

### **ì¸ì¦ ì‹œìŠ¤í…œ**
```typescript
// JWT í† í° êµ¬ì¡°
interface JWTPayload {
  sub: string;        // ì‚¬ìš©ì ID
  email: string;      // ì´ë©”ì¼
  role: string;       // ì—­í• 
  tenant_id: string;  // ì†Œì† ë†ì¥ ID
  iat: number;        // ë°œê¸‰ ì‹œê°„
  exp: number;        // ë§Œë£Œ ì‹œê°„
}

// ê¶Œí•œ ê²€ì¦ ë¯¸ë“¤ì›¨ì–´
export function requireAuth(requiredRole?: string) {
  return async (req: Request, res: Response, next: NextFunction) => {
    const token = req.headers.authorization?.replace('Bearer ', '');
    
    if (!token) {
      return res.status(401).json({
        success: false,
        error: { code: 'UNAUTHORIZED', message: 'ì¸ì¦ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤' }
      });
    }

    try {
      const payload = jwt.verify(token, process.env.JWT_SECRET!) as JWTPayload;
      
      if (requiredRole && payload.role !== requiredRole) {
        return res.status(403).json({
          success: false,
          error: { code: 'FORBIDDEN', message: 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤' }
        });
      }
      
      req.user = payload;
      next();
    } catch (error) {
      return res.status(401).json({
        success: false,
        error: { code: 'INVALID_TOKEN', message: 'ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤' }
      });
    }
  };
}
```

### **MQTT ë³´ì•ˆ**
```typescript
// MQTT ì—°ê²° ë³´ì•ˆ ì„¤ì •
const mqttSecurityConfig = {
  // SSL/TLS ì—°ê²°
  protocol: 'mqtts',  // MQTT over SSL
  port: 8883,         // SSL í¬íŠ¸
  
  // ì¸ì¦
  username: process.env.MQTT_USERNAME,
  password: process.env.MQTT_PASSWORD,
  
  // ì¸ì¦ì„œ
  cert: fs.readFileSync('path/to/client.crt'),
  key: fs.readFileSync('path/to/client.key'),
  ca: fs.readFileSync('path/to/ca.crt'),
  
  // ë³´ì•ˆ ì˜µì…˜
  rejectUnauthorized: true,
  secureProtocol: 'TLSv1_2_method'
};
```

### **ë°ì´í„° ì•”í˜¸í™”**
```typescript
// ë¯¼ê°í•œ ë°ì´í„° ì•”í˜¸í™”
import crypto from 'crypto';

export function encryptData(data: string): string {
  const cipher = crypto.createCipher('aes-256-cbc', process.env.ENCRYPTION_KEY!);
  let encrypted = cipher.update(data, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  return encrypted;
}

export function decryptData(encryptedData: string): string {
  const decipher = crypto.createDecipher('aes-256-cbc', process.env.ENCRYPTION_KEY!);
  let decrypted = decipher.update(encryptedData, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  return decrypted;
}
```

---

## ğŸ“Š ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…

### **ë¡œê¹… ì‹œìŠ¤í…œ**
```typescript
import winston from 'winston';

// ë¡œê±° ì„¤ì •
const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
    new winston.transports.Console({
      format: winston.format.simple()
    })
  ]
});

// êµ¬ì¡°í™”ëœ ë¡œê¹…
export function logSensorData(sensorData: SensorDataMessage) {
  logger.info('ì„¼ì„œ ë°ì´í„° ìˆ˜ì‹ ', {
    farmId: sensorData.payload.farm_id,
    bedId: sensorData.payload.bed_id,
    sensorType: sensorData.payload.sensor_type,
    value: sensorData.payload.value,
    quality: sensorData.payload.quality,
    timestamp: sensorData.payload.timestamp
  });
}

export function logControlCommand(command: ControlCommandMessage) {
  logger.info('ì œì–´ ëª…ë ¹ ë°œì†¡', {
    farmId: command.payload.farm_id,
    bedId: command.payload.bed_id,
    switchId: command.payload.switch_id,
    command: command.payload.command,
    userId: command.payload.user_id,
    timestamp: command.payload.timestamp
  });
}
```

### **ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§**
```typescript
// ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
interface SystemMetrics {
  timestamp: Date;
  mqttConnections: number;
  activeSensors: number;
  activeSwitches: number;
  messageThroughput: {
    received: number;
    sent: number;
  };
  responseTime: {
    average: number;
    p95: number;
    p99: number;
  };
  errorRate: number;
}

// í—¬ìŠ¤ ì²´í¬ ì—”ë“œí¬ì¸íŠ¸
app.get('/health', async (req, res) => {
  const health = {
    status: 'healthy',
    timestamp: new Date().toISOString(),
    services: {
      database: await checkDatabaseHealth(),
      mqtt: await checkMqttHealth(),
      redis: await checkRedisHealth()
    },
    metrics: await getSystemMetrics()
  };
  
  res.json(health);
});
```

---

## ğŸš€ ë°°í¬ ë° í™•ì¥ì„±

### **ì»¨í…Œì´ë„ˆí™” (Docker)**
```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3000

CMD ["npm", "start"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  web-admin:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - MQTT_BROKER_URL=${MQTT_BROKER_URL}
    depends_on:
      - redis
      - mqtt-broker

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  mqtt-broker:
    image: eclipse-mosquitto:2.0
    ports:
      - "1883:1883"
      - "8883:8883"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
```

### **í™•ì¥ì„± ê³ ë ¤ì‚¬í•­**
```typescript
// ìˆ˜í‰ í™•ì¥ì„ ìœ„í•œ ë¡œë“œ ë°¸ëŸ°ì‹±
const cluster = require('cluster');
const numCPUs = require('os').cpus().length;

if (cluster.isMaster) {
  console.log(`ë§ˆìŠ¤í„° í”„ë¡œì„¸ìŠ¤ ${process.pid} ì‹¤í–‰ ì¤‘`);
  
  // ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ ìƒì„±
  for (let i = 0; i < numCPUs; i++) {
    cluster.fork();
  }
  
  cluster.on('exit', (worker, code, signal) => {
    console.log(`ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ ${worker.process.pid} ì¢…ë£Œë¨`);
    cluster.fork(); // ìƒˆë¡œìš´ ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ ìƒì„±
  });
} else {
  // ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
  require('./app');
  console.log(`ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ ${process.pid} ì‹¤í–‰ ì¤‘`);
}

// Redisë¥¼ ì´ìš©í•œ ì„¸ì…˜ ê³µìœ 
const session = require('express-session');
const RedisStore = require('connect-redis')(session);

app.use(session({
  store: new RedisStore({
    host: 'localhost',
    port: 6379,
    db: 0
  }),
  secret: process.env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false
}));
```

### **í™˜ê²½ë³„ ì„¤ì •**
```typescript
// config/index.ts
interface Config {
  database: {
    url: string;
    ssl: boolean;
  };
  mqtt: {
    brokerUrl: string;
    port: number;
    username?: string;
    password?: string;
  };
  redis: {
    url: string;
  };
  auth: {
    jwtSecret: string;
    sessionSecret: string;
  };
}

const configs: { [key: string]: Config } = {
  development: {
    database: {
      url: process.env.DATABASE_URL || 'postgresql://localhost:5432/smartfarm_dev',
      ssl: false
    },
    mqtt: {
      brokerUrl: process.env.MQTT_BROKER_URL || 'mqtt://localhost',
      port: parseInt(process.env.MQTT_PORT || '1883')
    },
    redis: {
      url: process.env.REDIS_URL || 'redis://localhost:6379'
    },
    auth: {
      jwtSecret: process.env.JWT_SECRET || 'dev-secret',
      sessionSecret: process.env.SESSION_SECRET || 'dev-session-secret'
    }
  },
  
  production: {
    database: {
      url: process.env.DATABASE_URL!,
      ssl: true
    },
    mqtt: {
      brokerUrl: process.env.MQTT_BROKER_URL!,
      port: parseInt(process.env.MQTT_PORT || '8883'),
      username: process.env.MQTT_USERNAME,
      password: process.env.MQTT_PASSWORD
    },
    redis: {
      url: process.env.REDIS_URL!
    },
    auth: {
      jwtSecret: process.env.JWT_SECRET!,
      sessionSecret: process.env.SESSION_SECRET!
    }
  }
};

export default configs[process.env.NODE_ENV || 'development'];
```

---

## ğŸ“ ê²°ë¡ 

ì´ ê¸°ìˆ  ì•„í‚¤í…ì²˜ëŠ” ë‹¤ìŒê³¼ ê°™ì€ íŠ¹ì§•ì„ ê°€ì§‘ë‹ˆë‹¤:

### **ì¥ì **
- **ëª¨ë“ˆí™”ëœ ì„¤ê³„**: ê° ì»´í¬ë„ŒíŠ¸ê°€ ë…ë¦½ì ìœ¼ë¡œ ë™ì‘
- **í™•ì¥ ê°€ëŠ¥**: ë†ì¥ ìˆ˜ ì¦ê°€ì— ëŒ€ì‘ ê°€ëŠ¥
- **ì‹¤ì‹œê°„ í†µì‹ **: MQTTë¥¼ í†µí•œ ì¦‰ì‹œ ë°˜ì‘
- **ë³´ì•ˆ**: ë‹¤ì¸µ ë³´ì•ˆ ì‹œìŠ¤í…œ
- **ëª¨ë‹ˆí„°ë§**: ì™„ì „í•œ ì‹œìŠ¤í…œ ê°€ì‹œì„±

### **í™•ì¥ ê³„íš**
1. **AI ê¸°ë°˜ ìë™í™”**: ì„¼ì„œ ë°ì´í„° ê¸°ë°˜ ìë™ ì œì–´
2. **ëª¨ë°”ì¼ ì•±**: React Native ê¸°ë°˜ ëª¨ë°”ì¼ ì•±
3. **ë°ì´í„° ë¶„ì„**: ì‹œê³„ì—´ ë°ì´í„° ë¶„ì„ ë° ì˜ˆì¸¡
4. **ë‹¤êµ­ì–´ ì§€ì›**: êµ­ì œí™” (i18n) ì§€ì›
5. **API ê²Œì´íŠ¸ì›¨ì´**: ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ë¡œ ì „í™˜

ì´ ë¬¸ì„œëŠ” ìŠ¤ë§ˆíŠ¸íŒœ ì‹œìŠ¤í…œì˜ ê¸°ìˆ ì  êµ¬í˜„ì„ ìœ„í•œ ê°€ì´ë“œì…ë‹ˆë‹¤. ì¶”ê°€ ì§ˆë¬¸ì´ë‚˜ ê°œì„  ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ê°œë°œíŒ€ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”.
