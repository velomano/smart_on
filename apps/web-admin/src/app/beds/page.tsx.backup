'use client';

import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { getCurrentUser, AuthUser, getUserSettings, updateUserSettings } from '../../lib/auth';
import { getFarms, getDevices, getSensors, getSensorReadings, Farm, Device, Sensor, SensorReading } from '../../lib/supabase';
import AppHeader from '../../components/AppHeader';

export default function BedsManagementPage() {
  const [farms, setFarms] = useState<Farm[]>([]);
  const [devices, setDevices] = useState<Device[]>([]);
  const [sensors, setSensors] = useState<Sensor[]>([]);
  const [sensorReadings, setSensorReadings] = useState<SensorReading[]>([]);
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState<AuthUser | null>(null);
  const [authLoading, setAuthLoading] = useState(true);
  const [selectedBed, setSelectedBed] = useState<string>('');
  const [bedFilter, setBedFilter] = useState<'all' | 'active' | 'inactive' | 'dashboard' | 'no-dashboard'>('all');
  const [editingDevice, setEditingDevice] = useState<string | null>(null);
  const [editFormData, setEditFormData] = useState({
    name: '',
    location: '',
    status: true
  });
  const [userSettings, setUserSettings] = useState({
    showTeamBedsOnDashboard: true,
    showAllBedsInBedManagement: false
  });
  const [bedDashboardSettings, setBedDashboardSettings] = useState<Record<string, boolean>>({});
  const [bedControls, setBedControls] = useState<Record<string, {
    lamp1: boolean;
    lamp2: boolean;
    pump: boolean;
    fan: boolean;
    schedule: {
      enabled: boolean;
      onTime: string;
      offTime: string;
    };
    dualTime: {
      enabled: boolean;
      onMinutes: number;
      offMinutes: number;
    };
  }>>({});
  const [showAddBedModal, setShowAddBedModal] = useState(false);
  const [newBedData, setNewBedData] = useState({
    name: '',
    cropName: '',
    growingMethod: 'ë‹´ì•¡ì‹' as 'ë‹´ì•¡ì‹' | 'NFTì‹' | 'ë¶„ë¬´ì‹' | 'ì ì ì‹' | 'ê¸°íƒ€'
  });
  const [selectedFarmTab, setSelectedFarmTab] = useState<string>('all');
  const [showAddFarmModal, setShowAddFarmModal] = useState(false);
  const [newFarmData, setNewFarmData] = useState({
    name: '',
    description: '',
    location: ''
  });
  const router = useRouter();

  useEffect(() => {
    const checkAuth = async () => {
      const currentUser = await getCurrentUser();
      if (!currentUser || !currentUser.is_approved || !currentUser.is_active) {
        router.push('/login');
        return;
      }
      setUser(currentUser);
      
      // ì‚¬ìš©ì ì„¤ì • ë¡œë“œ
      const settings = getUserSettings(currentUser.id);
      setUserSettings(settings);
      
      // ë² ë“œ ëŒ€ì‹œë³´ë“œ ì„¤ì • ë¡œë“œ
      if (typeof window !== 'undefined') {
        const savedBedSettings = localStorage.getItem('bed_dashboard_settings');
        if (savedBedSettings) {
          const parsedSettings = JSON.parse(savedBedSettings);
          setBedDashboardSettings(parsedSettings);
          console.log('ë² ë“œ ê´€ë¦¬ì—ì„œ ì„¤ì • ë¡œë“œë¨:', parsedSettings);
        }
        
        // ë² ë“œ ì»¨íŠ¸ë¡¤ ì„¤ì • ë¡œë“œ
        const savedBedControls = localStorage.getItem('bed_controls');
        if (savedBedControls) {
          const parsedControls = JSON.parse(savedBedControls);
          setBedControls(parsedControls);
          console.log('ë² ë“œ ì»¨íŠ¸ë¡¤ ì„¤ì • ë¡œë“œë¨:', parsedControls);
        }
      }
      
      setAuthLoading(false);
    };
    checkAuth();
  }, [router]);

  useEffect(() => {
    if (!user) return;

    const loadData = async () => {
      try {
      const [farmsData, devicesData, sensorsData, sensorReadingsData] = await Promise.all([
        getFarms(),
        getDevices(),
        getSensors(),
        getSensorReadings()
      ]);
      
      setFarms(farmsData);
      setDevices(devicesData);
      setSensors(sensorsData);
      setSensorReadings(sensorReadingsData);
      } catch (error) {
        console.error('Error loading data:', error);
      } finally {
        setLoading(false);
      }
    };
    loadData();
  }, [user]);

  const handleEditDevice = (device: Device) => {
    setEditingDevice(device.id);
    setEditFormData({
      name: device.meta?.location || '',
      location: device.meta?.location || '',
      status: device.status?.online || false
    });
  };

  const handleSaveEdit = (deviceId: string) => {
    // ì‹¤ì œë¡œëŠ” API í˜¸ì¶œë¡œ ë””ë°”ì´ìŠ¤ ì •ë³´ ì—…ë°ì´íŠ¸
    setDevices(prev => prev.map(device => 
      device.id === deviceId 
        ? {
            ...device,
            meta: { ...device.meta, location: editFormData.location },
            status: { ...device.status, online: editFormData.status }
          }
        : device
    ));
    setEditingDevice(null);
  };

  const handleCancelEdit = () => {
    setEditingDevice(null);
    setEditFormData({ name: '', location: '', status: true });
  };

  const handleSettingChange = (key: string, value: boolean) => {
    if (!user) return;
    
    const newSettings = { ...userSettings, [key]: value };
    setUserSettings(newSettings);
    updateUserSettings(user.id, newSettings);
  };

  const handleBedDashboardToggle = (deviceId: string, showOnDashboard: boolean) => {
    const newSettings = {
      ...bedDashboardSettings,
      [deviceId]: showOnDashboard
    };
    setBedDashboardSettings(newSettings);
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    if (typeof window !== 'undefined') {
      localStorage.setItem('bed_dashboard_settings', JSON.stringify(newSettings));
      console.log('ë² ë“œ ëŒ€ì‹œë³´ë“œ ì„¤ì • ì €ì¥ë¨:', newSettings);
    }
  };

  // ë² ë“œ ì»¨íŠ¸ë¡¤ í•¸ë“¤ëŸ¬ë“¤
  const handleDeviceToggle = (deviceId: string, deviceType: 'lamp1' | 'lamp2' | 'pump' | 'fan', value: boolean) => {
    const currentControls = bedControls[deviceId] || {
      lamp1: false,
      lamp2: false,
      pump: false,
      fan: false,
      schedule: { enabled: false, onTime: '08:00', offTime: '18:00' },
      dualTime: { enabled: false, onMinutes: 30, offMinutes: 30 }
    };
    
    const newControls = {
      ...bedControls,
      [deviceId]: {
        ...currentControls,
        [deviceType]: value
      }
    };
    
    setBedControls(newControls);
    
    if (typeof window !== 'undefined') {
      localStorage.setItem('bed_controls', JSON.stringify(newControls));
      console.log(`${deviceType} ${value ? 'ì¼œì§' : 'êº¼ì§'}:`, deviceId);
    }
  };

  const handleScheduleChange = (deviceId: string, field: 'enabled' | 'onTime' | 'offTime', value: boolean | string) => {
    const currentControls = bedControls[deviceId] || {
      lamp1: false,
      lamp2: false,
      pump: false,
      fan: false,
      schedule: { enabled: false, onTime: '08:00', offTime: '18:00' },
      dualTime: { enabled: false, onMinutes: 30, offMinutes: 30 }
    };
    
    const newControls = {
      ...bedControls,
      [deviceId]: {
        ...currentControls,
        schedule: {
          ...currentControls.schedule,
          [field]: value
        }
      }
    };
    
    setBedControls(newControls);
    
    if (typeof window !== 'undefined') {
      localStorage.setItem('bed_controls', JSON.stringify(newControls));
      console.log('ìŠ¤ì¼€ì¤„ ì„¤ì • ë³€ê²½:', deviceId, field, value);
    }
  };

  const handleDualTimeChange = (deviceId: string, field: 'enabled' | 'onMinutes' | 'offMinutes', value: boolean | number) => {
    const currentControls = bedControls[deviceId] || {
      lamp1: false,
      lamp2: false,
      pump: false,
      fan: false,
      schedule: { enabled: false, onTime: '08:00', offTime: '18:00' },
      dualTime: { enabled: false, onMinutes: 30, offMinutes: 30 }
    };
    
    const newControls = {
      ...bedControls,
      [deviceId]: {
        ...currentControls,
        dualTime: {
          ...currentControls.dualTime,
          [field]: value
        }
      }
    };
    
    setBedControls(newControls);
    
    if (typeof window !== 'undefined') {
      localStorage.setItem('bed_controls', JSON.stringify(newControls));
      console.log('ë“€ì–¼ íƒ€ì„ ì„¤ì • ë³€ê²½:', deviceId, field, value);
    }
  };

  // ë² ë“œ í•„í„°ë§ ë¡œì§
  const handleAddBed = () => {
    if (!newBedData.name.trim() || !newBedData.cropName.trim()) {
      alert('ë°°ë“œ ì´ë¦„ê³¼ ì‘ë¬¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    // ì„ íƒëœ ë†ì¥ ID ê²°ì • (ë†ì¥ë³„ íƒ­ì—ì„œ ì„ íƒëœ ë†ì¥ ìš°ì„ , ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ë†ì¥)
    const targetFarmId = selectedFarmTab !== 'all' ? selectedFarmTab : (farms[0]?.id || '1');
    const targetFarm = farms.find(f => f.id === targetFarmId);

    // ìƒˆ ë°°ë“œ ìƒì„± (ì‹¤ì œë¡œëŠ” API í˜¸ì¶œ)
    const newBed: Device = {
      id: `bed-${Date.now()}`,
      farm_id: targetFarmId,
      type: 'sensor_gateway',
      name: newBedData.name,
      status: { online: true },
      meta: {
        location: `${targetFarm?.name || 'ë†ì¥'}-${newBedData.name}`,
        crop_name: newBedData.cropName,
        growing_method: newBedData.growingMethod
      },
      created_at: new Date().toISOString()
    };

    setDevices(prev => [...prev, newBed]);
    
    // ìƒˆ ë°°ë“œë¥¼ ëŒ€ì‹œë³´ë“œì— í‘œì‹œí•˜ë„ë¡ ì„¤ì •
    setBedDashboardSettings(prev => ({
      ...prev,
      [newBed.id]: true
    }));
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ë„ ì €ì¥
    if (typeof window !== 'undefined') {
      const updatedSettings = { ...bedDashboardSettings, [newBed.id]: true };
      localStorage.setItem('bed_dashboard_settings', JSON.stringify(updatedSettings));
    }
    
    // í¼ ì´ˆê¸°í™”
    setNewBedData({
      name: '',
      cropName: '',
      growingMethod: 'ë‹´ì•¡ì‹'
    });
    
    // ëª¨ë‹¬ ë‹«ê¸°
    setShowAddBedModal(false);
    
    alert(`ìƒˆ ë°°ë“œê°€ ${targetFarm?.name || 'ë†ì¥'}ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
  };

  // ìƒˆ ë†ì¥ ì¶”ê°€ í•¨ìˆ˜
  const handleAddFarm = () => {
    if (!newFarmData.name.trim()) {
      alert('ë†ì¥ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    // ìƒˆ ë†ì¥ ìƒì„± (ì‹¤ì œë¡œëŠ” API í˜¸ì¶œ)
    const newFarm: Farm = {
      id: `farm-${Date.now()}`,
      name: newFarmData.name,
      description: newFarmData.description,
      location: newFarmData.location,
      team_id: user?.team_id || '1', // í˜„ì¬ ì‚¬ìš©ìì˜ íŒ€ì— ì†í•˜ë„ë¡ ì„¤ì •
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };

    setFarms(prev => [...prev, newFarm]);
    
    // ìƒˆ ë†ì¥ íƒ­ìœ¼ë¡œ ìë™ ì „í™˜
    setSelectedFarmTab(newFarm.id);
    
    // í¼ ì´ˆê¸°í™”
    setNewFarmData({
      name: '',
      description: '',
      location: ''
    });
    
    // ëª¨ë‹¬ ë‹«ê¸°
    setShowAddFarmModal(false);
    
    alert(`ìƒˆ ë†ì¥ "${newFarm.name}"ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
  };

  const getFilteredDevices = () => {
    let filtered = devices.filter(d => d.type === 'sensor_gateway');
    
    // ì‚¬ìš©ìê°€ íŒ€ì›ì¸ ê²½ìš°, ìì‹ ì˜ ë†ì¥ì— ì†í•œ ë² ë“œë§Œ í‘œì‹œ
    if (user && (user.role === 'team_leader' || user.role === 'team_member') && !userSettings.showAllBedsInBedManagement) {
      // ë†ì¥ì— ì†í•œ ë†ì¥ì˜ ë² ë“œë§Œ í•„í„°ë§ (í˜„ì¬ëŠ” ëª¨ë“  ë² ë“œë¥¼ í‘œì‹œí•˜ì§€ë§Œ, ì‹¤ì œë¡œëŠ” ë†ì¥ë³„ ë†ì¥ ë§¤í•‘ì´ í•„ìš”)
      // ì„ì‹œë¡œ ëª¨ë“  ë² ë“œë¥¼ í‘œì‹œ (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ë†ì¥ë³„ ë†ì¥ ë§¤í•‘ í…Œì´ë¸”ì´ í•„ìš”)
      filtered = devices.filter(d => d.type === 'sensor_gateway');
    }
    
    // ë†ì¥ë³„ í•„í„° ì ìš©
    if (selectedFarmTab !== 'all') {
      filtered = filtered.filter(d => d.farm_id === selectedFarmTab);
    }
    
    // ë² ë“œ í•„í„° ì ìš©
    switch (bedFilter) {
      case 'active':
        filtered = filtered.filter(d => d.status === true);
        break;
      case 'inactive':
        filtered = filtered.filter(d => d.status === false);
        break;
      case 'dashboard':
        filtered = filtered.filter(d => bedDashboardSettings[d.id] !== false);
        break;
      case 'no-dashboard':
        filtered = filtered.filter(d => bedDashboardSettings[d.id] === false);
        break;
      case 'all':
      default:
        // ëª¨ë“  ë² ë“œ í‘œì‹œ
        break;
    }
    
    // íŠ¹ì • ë² ë“œ ì„ íƒ í•„í„°
    if (selectedBed) {
      filtered = filtered.filter(d => d.id === selectedBed);
    }
    
    return filtered;
  };

  const filteredDevices = getFilteredDevices();

  if (authLoading || loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">ë¡œë”© ì¤‘...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">
      {/* Header */}
      {user && (
        <AppHeader
          user={user}
          title="ë†ì¥ ê´€ë¦¬"
          subtitle="ë†ì¥ë³„ ë² ë“œì™€ ì„¼ì„œ ê²Œì´íŠ¸ì›¨ì´ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤"
        />
      )}

      {/* User Info Card */}
      {user && (
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
          <div className="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 p-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-4">
                <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg">
                  <span className="text-2xl">
                    {user.role === 'system_admin' ? 'ğŸ‘‘' : 
                     user.role === 'team_leader' ? 'ğŸ‘¨â€ğŸ’¼' : 'ğŸ‘¤'}
                  </span>
                </div>
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">{user.name}</h2>
                  <p className="text-gray-600 font-medium">{user.email}</p>
                  <div className="flex items-center space-x-4 mt-2">
                    <span className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                      {user.role === 'system_admin' ? 'ì‹œìŠ¤í…œ ê´€ë¦¬ì' :
                       user.role === 'team_leader' ? 'ë†ì¥ì¥' : 'íŒ€ì›'}
                    </span>
                    {user.team_name && (
                      <span className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                        {user.team_name}
                      </span>
                    )}
                  </div>
                </div>
              </div>
              <div className="text-right">
                <p className="text-sm text-gray-500">ë§ˆì§€ë§‰ ë¡œê·¸ì¸</p>
                <p className="text-lg font-semibold text-gray-900">
                  {new Date().toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  })}
                </p>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Stats Overview */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div className="bg-white/70 backdrop-blur-sm overflow-hidden shadow-2xl rounded-2xl border border-white/20">
            <div className="p-6">
              <div className="flex items-center">
                <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                  <span className="text-3xl">ğŸ </span>
                </div>
                <div className="ml-4">
                  <dt className="text-sm font-semibold text-gray-600 uppercase tracking-wide">
                    ì´ ë†ì¥ ìˆ˜
                  </dt>
                  <dd className="text-3xl font-black text-gray-900">{farms.length}</dd>
                </div>
              </div>
            </div>
          </div>

          <div className="bg-white/70 backdrop-blur-sm overflow-hidden shadow-2xl rounded-2xl border border-white/20">
            <div className="p-6">
              <div className="flex items-center">
                <div className="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center shadow-lg">
                  <span className="text-3xl">ğŸŒ±</span>
                </div>
                <div className="ml-4">
                  <dt className="text-sm font-semibold text-gray-600 uppercase tracking-wide">
                    ì´ ë² ë“œ ìˆ˜
                  </dt>
                  <dd className="text-3xl font-black text-gray-900">{devices.filter(d => d.type === 'sensor_gateway').length}</dd>
                </div>
              </div>
            </div>
          </div>

          <div className="bg-white/70 backdrop-blur-sm overflow-hidden shadow-2xl rounded-2xl border border-white/20">
            <div className="p-6">
              <div className="flex items-center">
                <div className="w-16 h-16 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg">
                  <span className="text-3xl">ğŸ“Š</span>
                </div>
                <div className="ml-4">
                  <dt className="text-sm font-semibold text-gray-600 uppercase tracking-wide">
                    ì´ ì„¼ì„œ ìˆ˜
                  </dt>
                  <dd className="text-3xl font-black text-gray-900">{sensors.length}</dd>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Bed Filter & Settings */}
        <div className="bg-white/70 backdrop-blur-sm shadow-2xl rounded-2xl border border-white/20 p-6 mb-8">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-xl font-bold text-gray-900">ë² ë“œ í•„í„°</h3>
            <div className="flex items-center space-x-4">
              {/* ì„¤ì • í† ê¸€ */}
              {user && (user.role === 'team_leader' || user.role === 'team_member') && (
                <div className="flex items-center space-x-2">
                  <label className="text-sm font-medium text-gray-700">
                    ëª¨ë“  ë² ë“œ ë³´ê¸°
                  </label>
                  <button
                    onClick={() => handleSettingChange('showAllBedsInBedManagement', !userSettings.showAllBedsInBedManagement)}
                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ${
                      userSettings.showAllBedsInBedManagement ? 'bg-blue-600' : 'bg-gray-200'
                    }`}
                  >
                    <span
                      className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 ${
                        userSettings.showAllBedsInBedManagement ? 'translate-x-6' : 'translate-x-1'
                      }`}
                    />
                  </button>
                </div>
              )}
              {/* ê´€ë¦¬ììš© ì„¤ì • */}
              {user && (user.role === 'system_admin' || user.email === 'sky3rain7@gmail.com') && (
                <div className="flex items-center space-x-4">
                  <div className="flex items-center space-x-2">
                    <label className="text-sm font-medium text-gray-700">
                      ëŒ€ì‹œë³´ë“œ ë…¸ì¶œ ê´€ë¦¬
                    </label>
                    <span className="text-xs text-gray-500">(ê° ë² ë“œë³„ ì„¤ì •)</span>
                  </div>
                </div>
              )}
              <button
                onClick={() => setSelectedBed('')}
                className={`px-4 py-2 rounded-xl font-semibold transition-all duration-200 ${
                  selectedBed === ''
                    ? 'bg-blue-500 text-white shadow-lg'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                ì „ì²´ ë³´ê¸°
              </button>
            </div>
          </div>
          
          {/* Farm Tabs */}
          <div className="mb-6">
            <div className="flex items-center justify-between mb-4">
              <h4 className="text-lg font-semibold text-gray-700">ë†ì¥ë³„ ë³´ê¸°</h4>
              {user && (user.role === 'system_admin' || user.email === 'sky3rain7@gmail.com') && (
                <button
                  onClick={() => setShowAddFarmModal(true)}
                  className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-all duration-200 flex items-center space-x-2"
                >
                  <span>+</span>
                  <span>ìƒˆ ë†ì¥ ì¶”ê°€</span>
                </button>
              )}
            </div>
            <div className="flex flex-wrap gap-2">
              <button
                onClick={() => setSelectedFarmTab('all')}
                className={`px-4 py-2 rounded-lg font-semibold transition-all duration-200 ${
                  selectedFarmTab === 'all'
                    ? 'bg-blue-500 text-white shadow-lg'
                    : 'bg-white/80 text-gray-700 hover:bg-blue-50'
                }`}
              >
                ì „ì²´ ë†ì¥ ({farms.length}ê°œ)
              </button>
              {farms.map(farm => (
                <button
                  key={farm.id}
                  onClick={() => setSelectedFarmTab(farm.id)}
                  className={`px-4 py-2 rounded-lg font-semibold transition-all duration-200 ${
                    selectedFarmTab === farm.id
                      ? 'bg-green-500 text-white shadow-lg'
                      : 'bg-white/80 text-gray-700 hover:bg-green-50'
                  }`}
                >
                  {farm.name} ({devices.filter(d => d.farm_id === farm.id && d.type === 'sensor_gateway').length}ê°œ)
                </button>
              ))}
            </div>
          </div>

          {/* Bed Filter Options */}
          <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <button
              onClick={() => setBedFilter('all')}
              className={`p-4 rounded-xl text-center transition-all duration-200 ${
                bedFilter === 'all'
                  ? 'bg-blue-500 text-white shadow-lg transform scale-105'
                  : 'bg-white/80 hover:bg-blue-50 hover:shadow-lg'
              }`}
            >
              <div className="flex flex-col items-center space-y-2">
                <span className="text-2xl">ğŸŒ±</span>
                <span className="font-bold">ì „ì²´</span>
                <span className="text-xs opacity-80">
                  {devices.filter(d => d.type === 'sensor_gateway').length}ê°œ
                </span>
              </div>
            </button>
            
            <button
              onClick={() => setBedFilter('active')}
              className={`p-4 rounded-xl text-center transition-all duration-200 ${
                bedFilter === 'active'
                  ? 'bg-green-500 text-white shadow-lg transform scale-105'
                  : 'bg-white/80 hover:bg-green-50 hover:shadow-lg'
              }`}
            >
              <div className="flex flex-col items-center space-y-2">
                <span className="text-2xl">âœ…</span>
                <span className="font-bold">í™œì„±</span>
                <span className="text-xs opacity-80">
                  {devices.filter(d => d.type === 'sensor_gateway' && d.status === true).length}ê°œ
                </span>
              </div>
            </button>
            
            <button
              onClick={() => setBedFilter('inactive')}
              className={`p-4 rounded-xl text-center transition-all duration-200 ${
                bedFilter === 'inactive'
                  ? 'bg-red-500 text-white shadow-lg transform scale-105'
                  : 'bg-white/80 hover:bg-red-50 hover:shadow-lg'
              }`}
            >
              <div className="flex flex-col items-center space-y-2">
                <span className="text-2xl">âŒ</span>
                <span className="font-bold">ë¹„í™œì„±</span>
                <span className="text-xs opacity-80">
                  {devices.filter(d => d.type === 'sensor_gateway' && d.status === false).length}ê°œ
                </span>
              </div>
            </button>
            
            <button
              onClick={() => setBedFilter('dashboard')}
              className={`p-4 rounded-xl text-center transition-all duration-200 ${
                bedFilter === 'dashboard'
                  ? 'bg-purple-500 text-white shadow-lg transform scale-105'
                  : 'bg-white/80 hover:bg-purple-50 hover:shadow-lg'
              }`}
            >
              <div className="flex flex-col items-center space-y-2">
                <span className="text-2xl">ğŸ“Š</span>
                <span className="font-bold">ëŒ€ì‹œë³´ë“œ</span>
                <span className="text-xs opacity-80">
                  {devices.filter(d => d.type === 'sensor_gateway' && bedDashboardSettings[d.id] !== false).length}ê°œ
                </span>
              </div>
            </button>
            
            <button
              onClick={() => setBedFilter('no-dashboard')}
              className={`p-4 rounded-xl text-center transition-all duration-200 ${
                bedFilter === 'no-dashboard'
                  ? 'bg-orange-500 text-white shadow-lg transform scale-105'
                  : 'bg-white/80 hover:bg-orange-50 hover:shadow-lg'
              }`}
            >
              <div className="flex flex-col items-center space-y-2">
                <span className="text-2xl">ğŸš«</span>
                <span className="font-bold">ìˆ¨ê¹€</span>
                <span className="text-xs opacity-80">
                  {devices.filter(d => d.type === 'sensor_gateway' && bedDashboardSettings[d.id] === false).length}ê°œ
                </span>
              </div>
            </button>
          </div>
          
          {/* Specific Bed Selection */}
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              íŠ¹ì • ë² ë“œ ì„ íƒ
            </label>
            <select
              value={selectedBed}
              onChange={(e) => setSelectedBed(e.target.value)}
              className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">ì „ì²´ ë² ë“œ</option>
              {devices
                .filter(d => d.type === 'sensor_gateway')
                .map((device) => (
                  <option key={device.id} value={device.id}>
                    {device.name} ({farms.find(f => f.id === device.farm_id)?.name || 'ì•Œ ìˆ˜ ì—†ëŠ” ë†ì¥'})
                  </option>
                ))}
            </select>
          </div>
        </div>

        {/* Farms List */}
        <div className="bg-white/70 backdrop-blur-sm shadow-2xl rounded-2xl border border-white/20 overflow-hidden">
          <div className="px-8 py-8">
            <div className="flex items-center justify-between mb-8">
              <div>
                <h3 className="text-2xl font-black text-gray-900 mb-2">
                  ğŸŒ± ë†ì¥ë³„ ë² ë“œ ê´€ë¦¬
                </h3>
                <p className="text-gray-600">
                  {selectedFarmTab === 'all' ? 'ì „ì²´ ë†ì¥ì˜ ë² ë“œ í˜„í™©' : `${farms.find(f => f.id === selectedFarmTab)?.name}ì˜ ë² ë“œ í˜„í™©`}
                </p>
              </div>
              <div className="flex items-center space-x-4">
                <div className="text-sm text-gray-600">
                  ì´ {farms.length}ê°œ ë†ì¥, {filteredDevices.length}ê°œ ë² ë“œ
                </div>
                {selectedFarmTab !== 'all' && (
                  <button 
                    onClick={() => {
                      console.log('ìƒë‹¨ ìƒˆ ë°°ë“œ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ë¨');
                      setShowAddBedModal(true);
                    }}
                    className="bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5"
                  >
                    + ìƒˆ ë² ë“œ ì¶”ê°€
                  </button>
                )}
              </div>
            </div>

            <div className="space-y-6">
              {(() => {
                // ë†ì¥ë³„ë¡œ ê·¸ë£¹í™”
                const farmGroups = farms.map(farm => {
                  const farmDevices = filteredDevices.filter(device => device.farm_id === farm.id);
                  return { farm, devices: farmDevices };
                }).filter(group => group.devices.length > 0);

                return farmGroups.map(({ farm, devices }) => (
                  <div key={farm.id} className="bg-gradient-to-r from-white/80 to-white/60 backdrop-blur-sm border border-white/30 rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-300">
                    {/* ë†ì¥ í—¤ë” */}
                    <div className="flex items-center justify-between mb-6">
                      <div className="flex items-center space-x-4">
                        <div className="w-16 h-16 bg-gradient-to-br from-green-400 to-blue-500 rounded-2xl flex items-center justify-center shadow-lg">
                          <span className="text-3xl">ğŸ </span>
                        </div>
                        <div>
                          <h4 className="text-2xl font-bold text-gray-900">{farm.name}</h4>
                          <p className="text-gray-600 font-medium text-lg">ğŸ“ {farm.location || 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ'}</p>
                          <div className="mt-2 flex items-center space-x-4">
                            <span className="text-sm text-blue-600 font-semibold">
                              ğŸ“Š ì´ {devices.length}ê°œ ë² ë“œ
                            </span>
                            <div className="flex items-center space-x-1">
                              <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                              <span className="text-xs text-gray-500">í™œì„±</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <span className="text-sm px-4 py-2 bg-green-100 text-green-700 rounded-full font-bold border border-green-200">
                        ğŸŸ¢ ì˜¨ë¼ì¸
                      </span>
                    </div>

                    {/* ë†ì¥ì— ì†í•œ ë² ë“œë“¤ */}
                    <div className="space-y-4">
                      <h5 className="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                        <span className="text-xl mr-2">ğŸŒ±</span>
                        {farm.name}ì˜ ë² ë“œ ëª©ë¡
                      </h5>

                      <div className="space-y-4">
                        {devices.map((device) => {
                          const deviceSensors = sensors.filter(s => s.device_id === device.id);
                
                          return (
                            <div key={device.id} className="bg-gray-50 rounded-lg p-4 border-l-4 border-l-green-400 hover:shadow-md transition-all duration-200">
                              <div className="flex items-center justify-between mb-3">
                                <div className="flex items-center space-x-3">
                                  <div className="w-8 h-8 bg-gradient-to-br from-blue-400 to-purple-500 rounded-lg flex items-center justify-center">
                                    <span className="text-sm">ğŸ“¡</span>
                                  </div>
                                  <div>
                                    <span className="font-bold text-gray-900 text-sm">
                                      {(device.meta?.location || 'ì„¼ì„œ ê²Œì´íŠ¸ì›¨ì´').replace(/^ë†ì¥\d+-/, '')}
                                    </span>
                                    <div className="text-xs text-gray-500">ğŸ“Š ì„¼ì„œ {deviceSensors.length}ê°œ</div>
                                  </div>
                                </div>
                                <span
                                  className={`text-xs px-2 py-1 rounded-full font-bold ${
                                    device.status?.online
                                      ? 'bg-green-100 text-green-700'
                                      : 'bg-red-100 text-red-700'
                                  }`}
                                >
                                  {device.status?.online ? 'ğŸŸ¢' : 'ğŸ”´'}
                                </span>
                              </div>
                              
                              <div className="flex items-center space-x-3">
                                {/* ê´€ë¦¬ììš© ëŒ€ì‹œë³´ë“œ ë…¸ì¶œ í† ê¸€ */}
                                {user && (user.role === 'system_admin' || user.email === 'sky3rain7@gmail.com') && (
                                  <div className="flex items-center space-x-2">
                                    <label className="text-sm font-medium text-gray-700">
                                      ëŒ€ì‹œë³´ë“œ ë…¸ì¶œ
                                    </label>
                                    <button
                                      onClick={() => handleBedDashboardToggle(device.id, !bedDashboardSettings[device.id])}
                                      className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ${
                                        bedDashboardSettings[device.id] !== false ? 'bg-green-600' : 'bg-gray-200'
                                      }`}
                                    >
                                      <span
                                        className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 ${
                                          bedDashboardSettings[device.id] !== false ? 'translate-x-6' : 'translate-x-1'
                                        }`}
                                      />
                                    </button>
                                  </div>
                                )}
                                <button
                                  onClick={() => handleEditDevice(device)}
                                  className="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5"
                                >
                                  {editingDevice === device.id ? 'ì €ì¥' : 'í¸ì§‘'}
                                </button>
                                {editingDevice === device.id && (
                                  <button
                                    onClick={handleCancelEdit}
                                    className="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-4 py-2 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5"
                                  >
                                    ì·¨ì†Œ
                                  </button>
                                )}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                ));
              })()}

              {/* ë¹ˆ ìƒíƒœ ì²˜ë¦¬ */}
              {(() => {
                const farmGroups = farms.map(farm => {
                  const farmDevices = filteredDevices.filter(device => device.farm_id === farm.id);
                  return { farm, devices: farmDevices };
                }).filter(group => group.devices.length > 0);

                if (farmGroups.length === 0) {
                  return (
                    <div className="text-center py-16">
                      <div className="w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl flex items-center justify-center mx-auto mb-6">
                        <span className="text-4xl">ğŸŒ±</span>
                      </div>
                      <h3 className="text-xl font-bold text-gray-900 mb-2">
                        {selectedFarmTab !== 'all' ? 
                          `${farms.find(f => f.id === selectedFarmTab)?.name}ì— ë“±ë¡ëœ ë² ë“œê°€ ì—†ìŠµë‹ˆë‹¤` :
                          'ë“±ë¡ëœ ë†ì¥ì´ ì—†ìŠµë‹ˆë‹¤'
                        }
                      </h3>
                      <p className="text-gray-600 mb-6">
                        {selectedFarmTab !== 'all' ? 
                          'ì´ ë†ì¥ì— ìƒˆë¡œìš´ ë² ë“œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”.' :
                          'ìƒˆë¡œìš´ ë†ì¥ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.'
                        }
                      </p>
                      {selectedFarmTab !== 'all' && (
                        <button 
                          onClick={() => setShowAddBedModal(true)}
                          className="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all duration-200"
                        >
                          + ìƒˆ ë² ë“œ ì¶”ê°€
                        </button>
                      )}
                    </div>
                  );
                }
                return null;
              })()}
            </div>
          </div>
        </div>

        {/* ìƒˆ ë°°ë“œ ì¶”ê°€ ë²„íŠ¼ - í•­ìƒ í‘œì‹œ */}
        {selectedFarmTab !== 'all' && (
          <div className="flex justify-center mt-8">
            <button 
              onClick={() => {
                console.log('ìƒˆ ë°°ë“œ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ë¨');
                setShowAddBedModal(true);
              }}
              className="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all duration-200"
            >
              + ìƒˆ ë² ë“œ ì¶”ê°€
            </button>
          </div>
        )}

        {/* ìƒˆ ë°°ë“œ ì¶”ê°€ ëª¨ë‹¬ */}
        {showAddBedModal && (
                      <div className="mt-6 border-t border-gray-200 pt-6">
                        <h5 className="text-lg font-bold text-gray-900 mb-4 flex items-center">
                          <span className="text-2xl mr-2">ğŸ›ï¸</span>
                          ìŠ¤ë§ˆíŠ¸ ìŠ¤ìœ„ì¹˜ ì œì–´
                        </h5>
                        
                        {/* Device Controls */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                          {/* ë¨í”„1 */}
                          <div className="bg-white/80 backdrop-blur-sm border border-white/40 rounded-xl p-4">
                            <div className="flex items-center justify-between mb-3">
                              <div className="flex items-center space-x-2">
                                <span className="text-2xl">ğŸ’¡</span>
                                <span className="font-semibold text-gray-900">ë¨í”„1</span>
                              </div>
                              <button
                                onClick={() => handleDeviceToggle(device.id, 'lamp1', !bedControls[device.id]?.lamp1)}
                                className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ${
                                  bedControls[device.id]?.lamp1 ? 'bg-green-600' : 'bg-gray-200'
                                }`}
                              >
                                <span
                                  className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 ${
                                    bedControls[device.id]?.lamp1 ? 'translate-x-6' : 'translate-x-1'
                                  }`}
                                />
                              </button>
                            </div>
                            <div className="text-xs text-gray-600">
                              {bedControls[device.id]?.lamp1 ? 'ì¼œì§' : 'êº¼ì§'}
                            </div>
                          </div>

                          {/* ë¨í”„2 */}
                          <div className="bg-white/80 backdrop-blur-sm border border-white/40 rounded-xl p-4">
                            <div className="flex items-center justify-between mb-3">
                              <div className="flex items-center space-x-2">
                                <span className="text-2xl">ğŸ’¡</span>
                                <span className="font-semibold text-gray-900">ë¨í”„2</span>
                              </div>
                              <button
                                onClick={() => handleDeviceToggle(device.id, 'lamp2', !bedControls[device.id]?.lamp2)}
                                className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ${
                                  bedControls[device.id]?.lamp2 ? 'bg-green-600' : 'bg-gray-200'
                                }`}
                              >
                                <span
                                  className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 ${
                                    bedControls[device.id]?.lamp2 ? 'translate-x-6' : 'translate-x-1'
                                  }`}
                                />
                              </button>
                            </div>
                            <div className="text-xs text-gray-600">
                              {bedControls[device.id]?.lamp2 ? 'ì¼œì§' : 'êº¼ì§'}
                            </div>
                          </div>

                          {/* íŒí”„ */}
                          <div className="bg-white/80 backdrop-blur-sm border border-white/40 rounded-xl p-4">
                            <div className="flex items-center justify-between mb-3">
                              <div className="flex items-center space-x-2">
                                <span className="text-2xl">ğŸ’§</span>
                                <span className="font-semibold text-gray-900">íŒí”„</span>
                              </div>
                              <button
                                onClick={() => handleDeviceToggle(device.id, 'pump', !bedControls[device.id]?.pump)}
                                className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ${
                                  bedControls[device.id]?.pump ? 'bg-green-600' : 'bg-gray-200'
                                }`}
                              >
                                <span
                                  className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 ${
                                    bedControls[device.id]?.pump ? 'translate-x-6' : 'translate-x-1'
                                  }`}
                                />
                              </button>
                            </div>
                            <div className="text-xs text-gray-600">
                              {bedControls[device.id]?.pump ? 'ì¼œì§' : 'êº¼ì§'}
                            </div>
                          </div>

                          {/* íŒ¬ */}
                          <div className="bg-white/80 backdrop-blur-sm border border-white/40 rounded-xl p-4">
                            <div className="flex items-center justify-between mb-3">
                              <div className="flex items-center space-x-2">
                                <span className="text-2xl">ğŸŒ€</span>
                                <span className="font-semibold text-gray-900">íŒ¬</span>
                              </div>
                              <button
                                onClick={() => handleDeviceToggle(device.id, 'fan', !bedControls[device.id]?.fan)}
                                className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ${
                                  bedControls[device.id]?.fan ? 'bg-green-600' : 'bg-gray-200'
                                }`}
                              >
                                <span
                                  className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 ${
                                    bedControls[device.id]?.fan ? 'translate-x-6' : 'translate-x-1'
                                  }`}
                                />
                              </button>
                            </div>
                            <div className="text-xs text-gray-600">
                              {bedControls[device.id]?.fan ? 'ì¼œì§' : 'êº¼ì§'}
                            </div>
                          </div>
                        </div>

                        {/* Schedule Control */}
                        <div className="bg-white/80 backdrop-blur-sm border border-white/40 rounded-xl p-4 mb-4">
                          <div className="flex items-center justify-between mb-4">
                            <h6 className="font-semibold text-gray-900 flex items-center">
                              <span className="text-xl mr-2">â°</span>
                              ìŠ¤ì¼€ì¤„ ê´€ë¦¬
                            </h6>
                            <button
                              onClick={() => handleScheduleChange(device.id, 'enabled', !bedControls[device.id]?.schedule?.enabled)}
                              className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ${
                                bedControls[device.id]?.schedule?.enabled ? 'bg-blue-600' : 'bg-gray-200'
                              }`}
                            >
                              <span
                                className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 ${
                                  bedControls[device.id]?.schedule?.enabled ? 'translate-x-6' : 'translate-x-1'
                                }`}
                              />
                            </button>
                          </div>
                          
                          {bedControls[device.id]?.schedule?.enabled && (
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">ì¼œëŠ” ì‹œê°„</label>
                                <input
                                  type="time"
                                  value={bedControls[device.id]?.schedule?.onTime || '08:00'}
                                  onChange={(e) => handleScheduleChange(device.id, 'onTime', e.target.value)}
                                  className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">ë„ëŠ” ì‹œê°„</label>
                                <input
                                  type="time"
                                  value={bedControls[device.id]?.schedule?.offTime || '18:00'}
                                  onChange={(e) => handleScheduleChange(device.id, 'offTime', e.target.value)}
                                  className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                              </div>
                            </div>
                          )}
                        </div>

                        {/* Dual Time Control */}
                        <div className="bg-white/80 backdrop-blur-sm border border-white/40 rounded-xl p-4">
                          <div className="flex items-center justify-between mb-4">
                            <h6 className="font-semibold text-gray-900 flex items-center">
                              <span className="text-xl mr-2">ğŸ”„</span>
                              ë“€ì–¼ íƒ€ì„ (ì¼œê¸°/ë„ê¸° ë°˜ë³µ)
                            </h6>
                            <button
                              onClick={() => handleDualTimeChange(device.id, 'enabled', !bedControls[device.id]?.dualTime?.enabled)}
                              className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ${
                                bedControls[device.id]?.dualTime?.enabled ? 'bg-purple-600' : 'bg-gray-200'
                              }`}
                            >
                              <span
                                className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 ${
                                  bedControls[device.id]?.dualTime?.enabled ? 'translate-x-6' : 'translate-x-1'
                                }`}
                              />
                            </button>
                          </div>
                          
                          {bedControls[device.id]?.dualTime?.enabled && (
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">ì¼œëŠ” ì‹œê°„ (ë¶„)</label>
                                <input
                                  type="number"
                                  min="1"
                                  max="1440"
                                  value={bedControls[device.id]?.dualTime?.onMinutes || 30}
                                  onChange={(e) => handleDualTimeChange(device.id, 'onMinutes', parseInt(e.target.value))}
                                  className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">ë„ëŠ” ì‹œê°„ (ë¶„)</label>
                                <input
                                  type="number"
                                  min="1"
                                  max="1440"
                                  value={bedControls[device.id]?.dualTime?.offMinutes || 30}
                                  onChange={(e) => handleDualTimeChange(device.id, 'offMinutes', parseInt(e.target.value))}
                                  className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                />
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Bed Status & Sensor Data */}
                    <div className="mt-6 border-t border-gray-200 pt-6">
                      <h5 className="text-lg font-bold text-gray-900 mb-4 flex items-center">
                        <span className="text-2xl mr-2">ğŸ“Š</span>
                        ë² ë“œ ìƒíƒœ ë° ì„¼ì„œ ë°ì´í„°
                      </h5>
                      
                      {/* Control Status */}
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div className="bg-gradient-to-r from-yellow-50 to-yellow-100 border border-yellow-200 rounded-xl p-4">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                              <span className="text-2xl">ğŸ’¡</span>
                              <div>
                                <div className="text-sm font-medium text-gray-700">ë¨í”„</div>
                                <div className="text-xs text-gray-500">ì¡°ëª… ìƒíƒœ</div>
                              </div>
                            </div>
                            <div className="text-right">
                              <div className={`text-lg font-bold ${(bedControls[device.id]?.lamp1 || bedControls[device.id]?.lamp2) ? 'text-green-600' : 'text-gray-400'}`}>
                                {(bedControls[device.id]?.lamp1 || bedControls[device.id]?.lamp2) ? 'ON' : 'OFF'}
                              </div>
                              <div className="text-xs text-gray-500">
                                {bedControls[device.id]?.lamp1 ? 'ë¨í”„1' : ''} {bedControls[device.id]?.lamp2 ? 'ë¨í”„2' : ''}
                              </div>
                            </div>
                          </div>
                        </div>

                        <div className="bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-4">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                              <span className="text-2xl">ğŸ’§</span>
                              <div>
                                <div className="text-sm font-medium text-gray-700">íŒí”„</div>
                                <div className="text-xs text-gray-500">ê¸‰ìˆ˜ ìƒíƒœ</div>
                              </div>
                            </div>
                            <div className="text-right">
                              <div className={`text-lg font-bold ${bedControls[device.id]?.pump ? 'text-blue-600' : 'text-gray-400'}`}>
                                {bedControls[device.id]?.pump ? 'ON' : 'OFF'}
                              </div>
                              <div className="text-xs text-gray-500">ê¸‰ìˆ˜</div>
                            </div>
                          </div>
                        </div>

                        <div className="bg-gradient-to-r from-green-50 to-green-100 border border-green-200 rounded-xl p-4">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                              <span className="text-2xl">ğŸŒ€</span>
                              <div>
                                <div className="text-sm font-medium text-gray-700">íŒ¬</div>
                                <div className="text-xs text-gray-500">í™˜ê¸° ìƒíƒœ</div>
                              </div>
                            </div>
                            <div className="text-right">
                              <div className={`text-lg font-bold ${bedControls[device.id]?.fan ? 'text-green-600' : 'text-gray-400'}`}>
                                {bedControls[device.id]?.fan ? 'ON' : 'OFF'}
                              </div>
                              <div className="text-xs text-gray-500">í™˜ê¸°</div>
                            </div>
                          </div>
                        </div>

                        <div className="bg-gradient-to-r from-purple-50 to-purple-100 border border-purple-200 rounded-xl p-4">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                              <span className="text-2xl">â°</span>
                              <div>
                                <div className="text-sm font-medium text-gray-700">ìŠ¤ì¼€ì¤„</div>
                                <div className="text-xs text-gray-500">ìë™ ì œì–´</div>
                              </div>
                            </div>
                            <div className="text-right">
                              <div className={`text-lg font-bold ${bedControls[device.id]?.schedule?.enabled ? 'text-purple-600' : 'text-gray-400'}`}>
                                {bedControls[device.id]?.schedule?.enabled ? 'ON' : 'OFF'}
                              </div>
                              <div className="text-xs text-gray-500">
                                {bedControls[device.id]?.schedule?.enabled ? 
                                  `${bedControls[device.id]?.schedule?.onTime}~${bedControls[device.id]?.schedule?.offTime}` : 
                                  'ìˆ˜ë™'
                                }
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Sensor Data */}
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        {/* Temperature */}
                        <div className="bg-gradient-to-r from-red-50 to-red-100 border border-red-200 rounded-xl p-4">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                              <span className="text-2xl">ğŸŒ¡ï¸</span>
                              <div>
                                <div className="text-sm font-medium text-gray-700">ì˜¨ë„</div>
                                <div className="text-xs text-gray-500">Temperature</div>
                              </div>
                            </div>
                            <div className="text-right">
                              <div className="text-2xl font-bold text-red-600">
                                {(() => {
                                  const tempSensor = deviceSensors.find(s => s.type === 'temperature');
                                  if (tempSensor) {
                                    const reading = sensorReadings.find(r => r.sensor_id === tempSensor.id);
                                    return reading ? `${reading.value}Â°C` : '--Â°C';
                                  }
                                  return '--Â°C';
                                })()}
                              </div>
                              <div className="text-xs text-gray-500">ì ì •: 20-25Â°C</div>
                            </div>
                          </div>
                        </div>

                        {/* Humidity */}
                        <div className="bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-4">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                              <span className="text-2xl">ğŸ’§</span>
                              <div>
                                <div className="text-sm font-medium text-gray-700">ìŠµë„</div>
                                <div className="text-xs text-gray-500">Humidity</div>
                              </div>
                            </div>
                            <div className="text-right">
                              <div className="text-2xl font-bold text-blue-600">
                                {(() => {
                                  const humiditySensor = deviceSensors.find(s => s.type === 'humidity');
                                  if (humiditySensor) {
                                    const reading = sensorReadings.find(r => r.sensor_id === humiditySensor.id);
                                    return reading ? `${reading.value}%` : '--%';
                                  }
                                  return '--%';
                                })()}
                              </div>
                              <div className="text-xs text-gray-500">ì ì •: 60-80%</div>
                            </div>
                          </div>
                        </div>

                        {/* EC Value */}
                        <div className="bg-gradient-to-r from-green-50 to-green-100 border border-green-200 rounded-xl p-4">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                              <span className="text-2xl">âš¡</span>
                              <div>
                                <div className="text-sm font-medium text-gray-700">EC</div>
                                <div className="text-xs text-gray-500">ì „ê¸°ì „ë„ë„</div>
                              </div>
                            </div>
                            <div className="text-right">
                              <div className="text-2xl font-bold text-green-600">
                                {(() => {
                                  const ecSensor = deviceSensors.find(s => s.type === 'ec');
                                  if (ecSensor) {
                                    const reading = sensorReadings.find(r => r.sensor_id === ecSensor.id);
                                    return reading ? `${reading.value} mS/cm` : '-- mS/cm';
                                  }
                                  return '-- mS/cm';
                                })()}
                              </div>
                              <div className="text-xs text-gray-500">ì ì •: 1.2-2.0</div>
                            </div>
                          </div>
                        </div>

                        {/* pH Value */}
                        <div className="bg-gradient-to-r from-purple-50 to-purple-100 border border-purple-200 rounded-xl p-4">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                              <span className="text-2xl">ğŸ§ª</span>
                              <div>
                                <div className="text-sm font-medium text-gray-700">pH</div>
                                <div className="text-xs text-gray-500">ì‚°ì„±ë„</div>
                              </div>
                            </div>
                            <div className="text-right">
                              <div className="text-2xl font-bold text-purple-600">
                                {(() => {
                                  const phSensor = deviceSensors.find(s => s.type === 'ph');
                                  if (phSensor) {
                                    const reading = sensorReadings.find(r => r.sensor_id === phSensor.id);
                                    return reading ? reading.value : '--';
                                  }
                                  return '--';
                                })()}
                              </div>
                              <div className="text-xs text-gray-500">ì ì •: 6.0-7.0</div>
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Additional Sensors */}
                      {deviceSensors.length > 0 && (
                        <div className="bg-white/80 backdrop-blur-sm border border-white/40 rounded-xl p-4">
                          <h6 className="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <span className="text-lg mr-2">ğŸ“¡</span>
                            ì—°ê²°ëœ ì„¼ì„œë“¤
                          </h6>
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            {deviceSensors.map((sensor) => {
                              const reading = sensorReadings.find(r => r.sensor_id === sensor.id);
                              return (
                                <div key={sensor.id} className="bg-white/80 backdrop-blur-sm border border-white/40 rounded-lg p-3">
                                  <div className="flex items-center justify-between">
                                    <div className="flex items-center space-x-3">
                                      <div className="w-8 h-8 bg-gradient-to-br from-green-400 to-blue-500 rounded-lg flex items-center justify-center">
                                        <span className="text-sm">ğŸ“Š</span>
                                      </div>
                                      <div>
                                        <div className="font-semibold text-gray-900 text-sm">
                                          {sensor.type}
                                        </div>
                                        <div className="text-xs text-gray-600">
                                          {sensor.unit}
                                        </div>
                                      </div>
                                    </div>
                                    <div className="text-right">
                                      <div className="text-lg font-bold text-gray-900">
                                        {reading ? reading.value : '--'}
                                      </div>
                                      <div className="text-xs text-gray-500">
                                        {reading ? new Date(reading.ts).toLocaleTimeString('ko-KR', { 
                                          hour: '2-digit', 
                                          minute: '2-digit' 
                                        }) : 'N/A'}
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}

              {filteredDevices.length === 0 && (
                <div className="text-center py-16">
                  <div className="w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl flex items-center justify-center mx-auto mb-6">
                    <span className="text-4xl">ğŸŒ±</span>
                  </div>
                  <h3 className="text-xl font-bold text-gray-900 mb-2">
                    {bedFilter === 'active' && 'í™œì„±í™”ëœ ë² ë“œê°€ ì—†ìŠµë‹ˆë‹¤'}
                    {bedFilter === 'inactive' && 'ë¹„í™œì„±í™”ëœ ë² ë“œê°€ ì—†ìŠµë‹ˆë‹¤'}
                    {bedFilter === 'dashboard' && 'ëŒ€ì‹œë³´ë“œì— í‘œì‹œë˜ëŠ” ë² ë“œê°€ ì—†ìŠµë‹ˆë‹¤'}
                    {bedFilter === 'no-dashboard' && 'ëŒ€ì‹œë³´ë“œì—ì„œ ìˆ¨ê²¨ì§„ ë² ë“œê°€ ì—†ìŠµë‹ˆë‹¤'}
                    {selectedBed && 'ì„ íƒí•œ ë² ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'}
                    {bedFilter === 'all' && !selectedBed && 'ë“±ë¡ëœ ë² ë“œê°€ ì—†ìŠµë‹ˆë‹¤'}
                  </h3>
                  <p className="text-gray-600 mb-6">
                    {bedFilter === 'active' && 'í™œì„±í™”ëœ ë² ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í•„í„°ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.'}
                    {bedFilter === 'inactive' && 'ë¹„í™œì„±í™”ëœ ë² ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ë² ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.'}
                    {bedFilter === 'dashboard' && 'ëŒ€ì‹œë³´ë“œì— í‘œì‹œë˜ëŠ” ë² ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë² ë“œ ì„¤ì •ì„ í™•ì¸í•´ë³´ì„¸ìš”.'}
                    {bedFilter === 'no-dashboard' && 'ëŒ€ì‹œë³´ë“œì—ì„œ ìˆ¨ê²¨ì§„ ë² ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ë² ë“œê°€ ëŒ€ì‹œë³´ë“œì— í‘œì‹œë©ë‹ˆë‹¤.'}
                    {selectedBed && 'ì„ íƒí•œ ë² ë“œê°€ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'}
                    {bedFilter === 'all' && !selectedBed && 'ì²« ë²ˆì§¸ ë² ë“œë¥¼ ë“±ë¡í•´ë³´ì„¸ìš”.'}
                  </p>
                  <div className="flex justify-center space-x-4">
                    {user && (user.role === 'team_leader' || user.role === 'team_member') && !userSettings.showAllBedsInBedManagement && (
                      <button
                        onClick={() => handleSettingChange('showAllBedsInBedManagement', true)}
                        className="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all duration-200"
                      >
                        ëª¨ë“  ë² ë“œ ë³´ê¸°
                      </button>
                    )}
                  </div>
                </div>
              )}

              {/* ìƒˆ ë°°ë“œ ì¶”ê°€ ë²„íŠ¼ - í•­ìƒ í‘œì‹œ */}
              <div className="flex justify-center mt-8">
                <button 
                  onClick={() => {
                    console.log('ìƒˆ ë°°ë“œ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ë¨');
                    setShowAddBedModal(true);
                  }}
                  className="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all duration-200"
                >
                  + ìƒˆ ë°°ë“œ ì¶”ê°€
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>

      {/* ìƒˆ ë°°ë“œ ì¶”ê°€ ëª¨ë‹¬ */}
      {showAddBedModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-2xl p-8 w-full max-w-md mx-4 shadow-2xl">
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-2xl font-bold text-gray-900">ìƒˆ ë°°ë“œ ì¶”ê°€</h3>
              <button
                onClick={() => setShowAddBedModal(false)}
                className="text-gray-400 hover:text-gray-600 text-2xl"
              >
                Ã—
              </button>
            </div>

            <div className="space-y-6">
              {/* ë°°ë“œ ì´ë¦„ */}
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  ë°°ë“œ ì´ë¦„ *
                </label>
                <input
                  type="text"
                  value={newBedData.name}
                  onChange={(e) => setNewBedData(prev => ({ ...prev, name: e.target.value }))}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="ì˜ˆ: A-1, ë² ë“œ1, í† ë§ˆí† ë² ë“œ"
                />
              </div>

              {/* ì‘ë¬¼ ì´ë¦„ */}
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  ì‘ë¬¼ ì´ë¦„ *
                </label>
                <input
                  type="text"
                  value={newBedData.cropName}
                  onChange={(e) => setNewBedData(prev => ({ ...prev, cropName: e.target.value }))}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="ì˜ˆ: í† ë§ˆí† , ìƒì¶”, ë”¸ê¸°"
                />
              </div>

              {/* ë°°ë“œ ë°©ì‹ */}
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  ë°°ë“œ ë°©ì‹
                </label>
                <select
                  value={newBedData.growingMethod}
                  onChange={(e) => setNewBedData(prev => ({ ...prev, growingMethod: e.target.value as any }))}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="ë‹´ì•¡ì‹">ë‹´ì•¡ì‹</option>
                  <option value="NFTì‹">NFTì‹</option>
                  <option value="ë¶„ë¬´ì‹">ë¶„ë¬´ì‹</option>
                  <option value="ì ì ì‹">ì ì ì‹</option>
                  <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
              </div>

              {/* ë²„íŠ¼ë“¤ */}
              <div className="flex space-x-4 pt-4">
                <button
                  onClick={() => setShowAddBedModal(false)}
                  className="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                >
                  ì·¨ì†Œ
                </button>
                <button
                  onClick={handleAddBed}
                  className="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-lg hover:from-green-600 hover:to-blue-600 transition-all duration-200 font-semibold"
                >
                  ë°°ë“œ ì¶”ê°€
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* ìƒˆ ë†ì¥ ì¶”ê°€ ëª¨ë‹¬ */}
      {showAddFarmModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-2xl p-8 w-full max-w-md mx-4 shadow-2xl">
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-2xl font-bold text-gray-900">ìƒˆ ë†ì¥ ì¶”ê°€</h3>
              <button
                onClick={() => setShowAddFarmModal(false)}
                className="text-gray-400 hover:text-gray-600 text-2xl"
              >
                Ã—
              </button>
            </div>

            <div className="space-y-6">
              {/* ë†ì¥ ì´ë¦„ */}
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  ë†ì¥ ì´ë¦„ *
                </label>
                <input
                  type="text"
                  value={newFarmData.name}
                  onChange={(e) => setNewFarmData(prev => ({ ...prev, name: e.target.value }))}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  placeholder="ì˜ˆ: ìŠ¤ë§ˆíŠ¸íŒœ A, í† ë§ˆí†  ë†ì¥"
                />
              </div>

              {/* ë†ì¥ ì„¤ëª… */}
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  ë†ì¥ ì„¤ëª…
                </label>
                <textarea
                  value={newFarmData.description}
                  onChange={(e) => setNewFarmData(prev => ({ ...prev, description: e.target.value }))}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  rows={3}
                  placeholder="ë†ì¥ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                />
              </div>

              {/* ë†ì¥ ìœ„ì¹˜ */}
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  ë†ì¥ ìœ„ì¹˜
                </label>
                <input
                  type="text"
                  value={newFarmData.location}
                  onChange={(e) => setNewFarmData(prev => ({ ...prev, location: e.target.value }))}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  placeholder="ì˜ˆ: ê²½ê¸°ë„ ìˆ˜ì›ì‹œ, ì„œìš¸ì‹œ ê°•ë‚¨êµ¬"
                />
              </div>

              {/* ë²„íŠ¼ë“¤ */}
              <div className="flex space-x-4 pt-4">
                <button
                  onClick={() => setShowAddFarmModal(false)}
                  className="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                >
                  ì·¨ì†Œ
                </button>
                <button
                  onClick={handleAddFarm}
                  className="flex-1 px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all duration-200 font-semibold"
                >
                  ë†ì¥ ì¶”ê°€
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
