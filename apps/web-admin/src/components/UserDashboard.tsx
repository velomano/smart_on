'use client';

import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { AuthUser, getApprovedUsers, getUserSettings, updateUserSettings } from '../lib/auth';
import { Device, Sensor, SensorReading } from '../lib/supabase';
import AppHeader from './AppHeader';
import NotificationButton from './NotificationButton';
import { dashboardAlertManager, DashboardAlert } from '../lib/dashboardAlerts';

const ALERTS_DISABLED_MESSAGE = 'üîí ALERTS COMPLETELY DISABLED';

// ÏôÑÏ†Ñ ÎπÑÌôúÏÑ±Ïö© ÎçîÎØ∏
async function checkSensorDataAndNotify(sensorData: any) {
  console.log(
    'üîí PERMANENT DISABLED - checkSensorDataAndNotify stub called:',
    sensorData.type,
    sensorData.location
  );
  return;
}

interface UserDashboardProps {
  user: AuthUser;
  farms: any[];
  devices: any[];
  sensors: any[];
  sensorReadings: any[];
}

export default function UserDashboard({
  user,
  farms,
  devices,
  sensors,
  sensorReadings,
}: UserDashboardProps) {
  const router = useRouter();

  // ÏÉâÏÉÅ/Í∑∏ÎùºÎç∞Ïù¥ÏÖò Ïú†Ìã∏
  const getFarmColor = (farmId: string) => {
    const colors = [
      'text-blue-600',
      'text-green-600',
      'text-purple-600',
      'text-red-600',
      'text-orange-600',
      'text-indigo-600',
      'text-pink-600',
      'text-teal-600',
      'text-cyan-600',
      'text-emerald-600',
      'text-violet-600',
      'text-rose-600',
    ];
    const hash = farmId.split('').reduce((a, b) => {
      a = (a << 5) - a + b.charCodeAt(0);
      return a & a;
    }, 0);
    return colors[Math.abs(hash) % colors.length];
  };

  const getFarmGradient = (farmId: string) => {
    const gradients = [
      'from-blue-500 to-blue-600',
      'from-green-500 to-green-600',
      'from-purple-500 to-purple-600',
      'from-red-500 to-red-600',
      'from-orange-500 to-orange-600',
      'from-indigo-500 to-indigo-600',
      'from-pink-500 to-pink-600',
      'from-teal-500 to-teal-600',
      'from-cyan-500 to-cyan-600',
      'from-emerald-500 to-emerald-600',
      'from-violet-500 to-violet-600',
      'from-rose-500 to-rose-600',
    ];
    const hash = farmId.split('').reduce((a, b) => {
      a = (a << 5) - a + b.charCodeAt(0);
      return a & a;
    }, 0);
    return gradients[Math.abs(hash) % gradients.length];
  };

  // ÏÉÅÎã® Ïπ¥ÎìúÏö© ÏÉÅÌÉú
  const [recipeStats, setRecipeStats] = useState({ total: 0, today: 0 });
  const [weatherData, setWeatherData] = useState({
    temperature: 0,
    humidity: 0,
    precipitation: 0,
    weatherStatus: 'ÎßëÏùå',
    region: 'ÏÑúÏö∏',
  });

  // Î≤†Îìú ÏûëÎ¨º Ï†ïÎ≥¥ Ï†ÄÏû• (deviceId -> tier -> cropInfo)
  const [bedCropData, setBedCropData] = useState<Record<string, Record<number, any>>>({});

  // Î≤†Îìú ÏûëÎ¨º Ï†ïÎ≥¥ Î°úÎìú
  const loadCropData = async (deviceId: string) => {
    try {
      const response = await fetch(`/api/bed-crop-data?deviceId=${deviceId}`);
      const result = await response.json();
      if (result.ok && result.data) {
        const map: Record<number, any> = {};
        result.data.forEach((item: any) => {
          map[item.tier_number] = {
            cropName: item.crop_name,
            growingMethod: item.growing_method,
            plantType: item.plant_type,
            startDate: item.start_date,
            savedAt: item.created_at,
          };
        });
        setBedCropData((prev) => ({ ...prev, [deviceId]: map }));
      }
    } catch (e) {
      console.error('ÏûëÎ¨º Ï†ïÎ≥¥ Î°úÎìú Ïò§Î•ò:', e);
    }
  };

  // ÌÜµÍ≥Ñ
  useEffect(() => {
    const fetchRecipeStats = async () => {
      try {
        // Ï†ÑÏ≤¥ Î†àÏãúÌîº Ïàò Ï°∞Ìöå
        const totalResponse = await fetch('/api/nutrients/browse?limit=1');
        const totalResult = await totalResponse.json();
        
        // Î™®Îì† Î†àÏãúÌîºÎ•º Í∞ÄÏ†∏ÏôÄÏÑú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú Ïò§Îäò ÎÇ†Ïßú ÌïÑÌÑ∞ÎßÅ
        const allResponse = await fetch('/api/nutrients/browse?limit=1000');
        const allResult = await allResponse.json();
        
        // Ïò§Îäò ÎÇ†Ïßú Í≥ÑÏÇ∞
        const today = new Date().toISOString().split('T')[0];
        
        // Ïò§Îäò ÏÉùÏÑ±Îêú Î†àÏãúÌîº Í∞úÏàò Í≥ÑÏÇ∞
        const todayCount = allResult.recipes?.filter((recipe: any) => {
          if (!recipe.created_at) return false;
          const recipeDate = new Date(recipe.created_at).toISOString().split('T')[0];
          return recipeDate === today;
        }).length || 0;
        
        setRecipeStats({
          total: totalResult.pagination?.total || 0,
          today: todayCount,
        });
      } catch (e) {
        console.error('Î†àÏãúÌîº ÌÜµÍ≥Ñ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', e);
        setRecipeStats({ total: 0, today: 0 });
      }
    };
    fetchRecipeStats();
  }, []);

  // ÎÇ†Ïî®
  useEffect(() => {
    const fetchWeatherData = async () => {
      try {
        const region = user.weather_region || 'ÏÑúÏö∏';
        const response = await fetch(`/api/weather?region=${encodeURIComponent(region)}`);
        if (!response.ok) return;
        const result = await response.json();
        if (result.ok) setWeatherData(result.data);
      } catch (e) {
        console.error('ÎÇ†Ïî® API Ìò∏Ï∂ú Ïã§Ìå®:', e);
      }
    };
    fetchWeatherData();
    const interval = setInterval(fetchWeatherData, 10 * 60 * 1000);
    return () => clearInterval(interval);
  }, [user.weather_region]);

  // Î≤†Îìú ÏûëÎ¨º Ï†ïÎ≥¥ Î°úÎìú
  useEffect(() => {
    if (devices && devices.length > 0) {
      devices.forEach((d: any) => loadCropData(d.id));
    }
  }, [devices]);

  // Î≤†Îìú Ï†ïÎ†¨
  const sortBeds = (beds: Device[]) => {
    return beds.sort((a, b) => {
      const getBedNumber = (device: Device) => {
        const location = String(device.meta?.location || '');
        const bedMatch = location.match(/Î≤†Îìú-?(\d+)/);
        if (bedMatch) return parseInt(bedMatch[1], 10);
        const joMatch = location.match(/Ï°∞\d+-Î≤†Îìú(\d+)/);
        if (joMatch) return parseInt(joMatch[1], 10);
        const farmMatch = location.match(/ÎÜçÏû•\d+-Î≤†Îìú(\d+)/);
        if (farmMatch) return parseInt(farmMatch[1], 10);
        return new Date(device.created_at || '').getTime();
      };
      const aNum = getBedNumber(a);
      const bNum = getBedNumber(b);
      if (aNum !== bNum) return aNum - bNum;
      return new Date(a.created_at || '').getTime() - new Date(b.created_at || '').getTime();
    });
  };

  // ÏÇ¨Ïö©Ïûê/ÌåÄ/ÏÑ§Ï†ï
  const [teams, setTeams] = useState<any[]>([]);
  const [approvedUsers, setApprovedUsers] = useState<AuthUser[]>([]);
  const [teamsLoading, setTeamsLoading] = useState(true);
  const [userSettings, setUserSettings] = useState({
    showOnlyMyFarm: false,
    showAllBedsInBedManagement: false,
  });
  const [bedDashboardSettings, setBedDashboardSettings] = useState<Record<string, boolean>>({});

  useEffect(() => {
    const initialize = async () => {
      setTeamsLoading(true);
      try {
        setTeams(farms || []);
        const usersResult = await getApprovedUsers();
        setApprovedUsers(usersResult as AuthUser[]);
        const settings = getUserSettings(user.id);
        setUserSettings(settings);
        if (typeof window !== 'undefined') {
          const saved = localStorage.getItem('bed_dashboard_settings');
          if (saved) setBedDashboardSettings(JSON.parse(saved));
        }
      } catch (e) {
        console.error('Error initializing dashboard:', e);
      } finally {
        setTeamsLoading(false);
      }
    };
    initialize();
  }, [user.id, farms, devices]);

  // Ïï°Ï∂îÏóêÏù¥ÌÑ∞/ÏïåÎ¶º
  const [localActuatorStates, setLocalActuatorStates] = useState<Record<string, boolean>>({});
  const [bedAlerts, setBedAlerts] = useState<Record<string, DashboardAlert[]>>({});

  useEffect(() => {
    const unsubscribe = dashboardAlertManager.subscribe((alerts) => {
      const byDevice: Record<string, DashboardAlert[]> = {};
      alerts.forEach((a) => {
        if (!a.deviceId) return;
        if (!byDevice[a.deviceId]) byDevice[a.deviceId] = [];
        byDevice[a.deviceId].push(a);
      });
      setBedAlerts(byDevice);
    });
    return () => {
      unsubscribe();
    };
  }, []);

  const getBedAlertsFn = (deviceId: string): DashboardAlert[] => {
    const all = dashboardAlertManager.getAlerts();
    const alias = (id: string) => {
      if (id === 'device-1') return 'bed_001';
      if (id === 'device-2') return 'bed_002';
      if (id === 'device-3') return 'bed_003';
      if (id === 'device-4') return 'bed_004';
      if (id === 'device-5') return 'bed_005';
      if (id === 'device-6') return 'bed_006';
      return id;
    };
    const f = alias(deviceId);
    return all.filter((a) => (a.deviceId === deviceId || a.deviceId === f) && !a.isRead);
  };

  const getRecentAlertForBed = (deviceId: string): DashboardAlert | null => {
    const alerts = getBedAlertsFn(deviceId);
    return alerts.length > 0 ? alerts[0] : null;
  };

  const getBedStatusIcon = (deviceId: string) => {
    const a = getRecentAlertForBed(deviceId);
    if (!a) return 'üìä';
    switch (a.level) {
      case 'critical':
        return 'üõë';
      case 'high':
        return '‚ö†Ô∏è';
      case 'medium':
        return 'üî∂';
      case 'low':
        return 'üí°';
      default:
        return 'üìä';
    }
  };

  const getBedStatusColor = (deviceId: string) => {
    const a = getRecentAlertForBed(deviceId);
    if (!a) return 'bg-gray-100 text-gray-600 border-gray-300';
    switch (a.level) {
      case 'critical':
        return 'bg-red-500 text-white border-red-600 shadow-lg shadow-red-300 ring-2 ring-red-400';
      case 'high':
        return 'bg-orange-500 text-white border-orange-600 shadow-lg shadow-orange-300 ring-2 ring-orange-400';
      case 'medium':
        return 'bg-yellow-500 text-yellow-900 border-yellow-600 shadow-md shadow-yellow-300 ring-1 ring-yellow-400';
      case 'low':
        return 'bg-blue-500 text-white border-blue-600 shadow-md shadow-blue-300 ring-1 ring-blue-400';
      default:
        return 'bg-gray-100 text-gray-600 border-gray-300';
    }
  };

  const getFarmAlerts = (farmId: string): DashboardAlert[] => {
    const all = dashboardAlertManager.getAlerts();
    const farmDevices = (devices || []).filter((d) => d.farm_id === farmId && d.type === 'sensor_gateway');
    return all.filter((a) => {
      if (a.deviceId === farmId) return !a.isRead; // ÌÖåÏä§Ìä∏ ÏïåÎ¶º ÌóàÏö©
      return farmDevices.some((d) => d.id === a.deviceId) && !a.isRead;
    });
  };

  const hasFarmAlerts = (farmId: string) => getFarmAlerts(farmId).length > 0;

  // ÏÉÅÎã® ÏßÄÌëú
  const totalFarms = farms?.length || 0;
  const totalBeds = devices?.filter((d) => d.type === 'sensor_gateway').length || 0;
  const activeBeds =
    devices?.filter((d) => {
      if (d.type !== 'sensor_gateway') return false;
      if (typeof d.status === 'object' && d.status !== null) return d.status.online === true;
      return true;
    }).length || 0;
  const bedActivationRate = totalBeds > 0 ? Math.round((activeBeds / totalBeds) * 100) : 0;

  const activeMembers =
    approvedUsers?.filter(
      (u) =>
        u.is_active && u.is_approved && (u.role === 'team_leader' || u.role === 'team_member')
    ).length || 0;

  // Í∂åÌïú
  const canManageUsers =
    user.role === 'system_admin' || user.role === 'super_admin' || user.email === 'sky3rain7@gmail.com';
  const canManageTeamMembers =
    user.role === 'system_admin' ||
    user.role === 'super_admin' ||
    user.role === 'team_leader' ||
    user.role === 'team_member';
  const canManageFarms =
    user.role === 'system_admin' ||
    user.role === 'super_admin' ||
    user.role === 'team_leader' ||
    user.email === 'sky3rain7@gmail.com';

  // ‚¨áÔ∏è Î¨∏Ï†úÎêòÎçò Ï¶âÏãúÏã§Ìñâ JSX Î∏îÎ°ùÏùÑ Ìï®ÏàòÎ°ú Î∂ÑÎ¶¨
  const renderFarmOverview = (): React.ReactNode => {
    const filteredFarms = (farms || [])
      .filter((farm) => {
        if (
          user.role === 'system_admin' ||
          user.role === 'super_admin' ||
          user.email === 'sky3rain7@gmail.com'
        ) {
          return true;
        }
        if (farm.is_hidden) return false;
        if (user.role === 'team_leader' || user.role === 'team_member') {
          if (userSettings.showOnlyMyFarm) return farm.id === user.team_id;
        }
        return true;
      })
      .map((farm) => {
        const farmDevices = (devices || []).filter(
          (d) => d.farm_id === farm.id && d.type === 'sensor_gateway'
        );
        const visible = farmDevices.filter((device) => bedDashboardSettings[device.id] !== false);
        const sortedVisibleDevices = sortBeds([...visible]);
        return { ...farm, visibleDevices: sortedVisibleDevices };
      });

    if (filteredFarms.length === 0) {
      return (
        <div className="text-center py-16">
          <h3 className="text-xl font-bold text-gray-600 mb-2">
            {userSettings.showOnlyMyFarm ? 'ÏûêÍ∏∞ ÎÜçÏû•Ïóê Î≤†ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§' : 'ÌëúÏãúÌï† Î≤†ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§'}
          </h3>
          <p className="text-gray-600 mb-6">
            {user.role === 'team_leader' || user.role === 'team_member'
              ? userSettings.showOnlyMyFarm
                ? 'ÏûêÍ∏∞ ÎÜçÏû•Ïóê Î≤†ÎìúÎ•º Ï∂îÍ∞ÄÌïòÍ±∞ÎÇò "ÏûêÍ∏∞ ÎÜçÏû•Îßå Î≥¥Í∏∞"Î•º ÎÅÑÎ©¥ Î™®Îì† ÎÜçÏû•ÏùÑ Î≥º Ïàò ÏûàÏäµÎãàÎã§'
                : 'ÎÜçÏû• Í¥ÄÎ¶¨ÏóêÏÑú Î≤†ÎìúÎ•º ÌôúÏÑ±ÌôîÌïòÍ±∞ÎÇò ÏÉà Î≤†ÎìúÎ•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî'
              : 'ÎÜçÏû• Í¥ÄÎ¶¨ÏóêÏÑú Î≤†ÎìúÎ•º ÌôúÏÑ±ÌôîÌïòÍ±∞ÎÇò ÏÉà Î≤†ÎìúÎ•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî'}
          </p>
        </div>
      );
    }

    return (
      <>
        {filteredFarms.map((farm) => {
          const farmHasAlerts = hasFarmAlerts(farm.id);
          const farmAlerts = getFarmAlerts(farm.id);
          const criticalAlerts = farmAlerts.filter((a) => a.level === 'critical').length;
          const highAlerts = farmAlerts.filter((a) => a.level === 'high').length;

          return (
            <div
              key={farm.id}
              className={`bg-gradient-to-r from-white/80 to-white/60 backdrop-blur-sm border rounded-2xl p-2 sm:p-3 lg:p-6 shadow-xl hover:shadow-2xl transition-all duration-300 ${
                farmHasAlerts
                  ? 'border-red-400 ring-2 ring-red-300 animate-pulse shadow-red-200'
                  : 'border-gray-200'
              }`}
            >
              {/* ÎÜçÏû• Ìó§Îçî */}
              <div className={`bg-gradient-to-r ${getFarmGradient(farm.id)} rounded-xl p-4 mb-4`}>
                <div className="flex items-center justify-between">
                  <div className="flex items-center justify-between w-full">
                    <div className="flex items-center space-x-6">
                      <h4 className="text-2xl lg:text-3xl font-bold text-white whitespace-nowrap">
                        {farm.name}
                      </h4>
                      <div className="flex items-center space-x-4">
                        <p className="text-white/90 font-medium text-sm">
                          üìç {farm.location || 'ÏúÑÏπò Ï†ïÎ≥¥ ÏóÜÏùå'}
                        </p>
                        <span className="text-sm text-white/90 font-semibold">
                          üìä Ï¥ù {farm.visibleDevices.length}Í∞ú Î≤†Îìú
                        </span>
                        {farmHasAlerts ? (
                          <div className="flex items-center space-x-2">
                            <div className="flex items-center space-x-1 px-2 py-1 bg-red-500/30 border border-red-300 rounded-full backdrop-blur-sm">
                              <div className="w-2 h-2 bg-red-300 rounded-full animate-pulse"></div>
                              <span className="text-xs text-white font-bold">
                                ‚ö†Ô∏è {farmAlerts.length}Í∞ú ÏïåÎ¶º
                                {criticalAlerts > 0 && ` (Í∏¥Í∏â ${criticalAlerts}Í∞ú)`}
                                {highAlerts > 0 && ` (ÎÜíÏùå ${highAlerts}Í∞ú)`}
                              </span>
                            </div>
                          </div>
                        ) : (
                          <div className="flex items-center space-x-1">
                            <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                            <span className="text-xs text-white/80">ÌôúÏÑ±</span>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* ÎÜçÏû• Í¥ÄÎ¶¨ Î≤ÑÌäº */}
                    <div className="flex items-center space-x-2">
                      {canManageFarms && (
                        <button
                          onClick={() => router.push(`/beds?farm=${farm.id}`)}
                          className="bg-white/20 backdrop-blur-sm text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-white/30 transition-all duration-200 whitespace-nowrap border border-white/30"
                        >
                          ÎÜçÏû• Í¥ÄÎ¶¨
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              </div>

              {/* Î≤†Îìú Ïπ¥ÎìúÎì§ */}
              <div className="space-y-2 sm:space-y-3">
                <h5 className="text-xl lg:text-2xl font-semibold text-gray-600 mb-2 sm:mb-3 lg:mb-4 flex items-center">
                  {farm.name}Ïùò Î≤†Îìú ÌòÑÌô©
                </h5>

                <div className="grid grid-cols-1 gap-1 sm:gap-2 lg:gap-3">
                  {farm.visibleDevices.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      <p>ÌòÑÏû¨ ÌëúÏãúÌï† Î≤†ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
                    </div>
                  ) : (
                    farm.visibleDevices.map((device: Device, deviceIndex: number) => {
                      const deviceSensors = (sensors || []).filter((s) => s.device_id === device.id);

                      const label = (() => {
                        const location = String(device.meta?.location ?? 'ÏÑºÏÑú Í≤åÏù¥Ìä∏Ïõ®Ïù¥');
                        const jo = location.match(/^Ï°∞(\d+)-Î≤†Îìú(\d+)/);
                        if (jo) return `Î≤†Îìú-${jo[2]}`;
                        const fm = location.match(/^ÎÜçÏû•(\d+)-Î≤†Îìú(\d+)/);
                        if (fm) return `Î≤†Îìú-${fm[2]}`;
                        const bedDash = location.match(/^Î≤†Îìú-(\d+)/);
                        if (bedDash) return `Î≤†Îìú-${bedDash[1]}`;
                        const bedOnly = location.match(/^Î≤†Îìú(\d+)/);
                        if (bedOnly) return `Î≤†Îìú-${bedOnly[1]}`;
                        return `Î≤†Îìú-${device.id.slice(-4)}`;
                      })();

                      const recentAlert = getRecentAlertForBed(device.id);
                      const tempSensor = deviceSensors.find((s) => s.type === 'temperature');
                      const humSensor = deviceSensors.find((s) => s.type === 'humidity');
                      const ecSensor = deviceSensors.find((s) => s.type === 'ec');
                      const phSensor = deviceSensors.find((s) => s.type === 'ph');

                      const tempReading =
                        tempSensor && sensorReadings.find((r) => r.sensor_id === tempSensor.id);
                      const humReading =
                        humSensor && sensorReadings.find((r) => r.sensor_id === humSensor.id);
                      const ecReading =
                        ecSensor && sensorReadings.find((r) => r.sensor_id === ecSensor.id);
                      const phReading =
                        phSensor && sensorReadings.find((r) => r.sensor_id === phSensor.id);

                      const cropData = bedCropData[device.id];
                      const firstTier =
                        cropData && Object.keys(cropData).sort((a, b) => +a - +b)[0];
                      const cropName = firstTier ? cropData[+firstTier]?.cropName : 'ÎØ∏ÏÑ§Ï†ï';
                      const growingMethod = firstTier
                        ? cropData[+firstTier]?.growingMethod
                        : 'ÎØ∏ÏÑ§Ï†ï';

                      return (
                        <div
                          key={device.id}
                          className="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-200"
                          data-device-id={device.id}
                          data-device-index={deviceIndex}
                        >
                          <div className="p-3 sm:p-4 lg:p-6">
                            <div className="flex items-center justify-between mb-3 sm:mb-4">
                              <div className="flex items-center space-x-4">
                                <div>
                                  <span className="font-bold text-gray-600 text-lg lg:text-xl">
                                    {label}
                                  </span>
                                  <div className="text-sm text-gray-500">üìä ÏÑºÏÑú {deviceSensors.length}Í∞ú</div>
                                  <div className="mt-2 flex items-center space-x-3">
                                    <span className="text-sm text-green-600 font-medium">üå± {cropName}</span>
                                    <span className="text-sm text-blue-600 font-medium">üîß {growingMethod}</span>
                                  </div>
                                </div>
                              </div>

                              <div className="flex items-center space-x-2">
                                {recentAlert && (
                                  <div
                                    className={`flex items-center space-x-1 px-3 py-2 rounded-full text-xs font-bold ${getBedStatusColor(
                                      device.id
                                    )} animate-bounce shadow-lg`}
                                  >
                                    <span className="animate-pulse">{getBedStatusIcon(device.id)}</span>
                                    <span className="truncate max-w-[120px]">{recentAlert.title}</span>
                                  </div>
                                )}
                              </div>
                            </div>

                            {/* Ï†úÏñ¥ ÏÉÅÌÉú */}
                            <div className="mb-3 sm:mb-4">
                              <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3 text-sm">
                                <div className="flex items-center space-x-2 bg-white/50 rounded-lg p-2 sm:p-3 ring-1 ring-gray-300">
                                  <span className="text-lg">üí°</span>
                                  <span className="text-gray-600 font-medium">Îû®ÌîÑ1</span>
                                  <span
                                    className={`font-bold text-right ${
                                      localActuatorStates['lamp1'] ? 'text-green-600' : 'text-gray-400'
                                    }`}
                                  >
                                    {localActuatorStates['lamp1'] ? 'ON' : 'OFF'}
                                  </span>
                                </div>
                                <div className="flex items-center space-x-2 bg-white/50 rounded-lg p-2 sm:p-3 ring-1 ring-gray-300">
                                  <span className="text-lg">üí°</span>
                                  <span className="text-gray-600 font-medium">Îû®ÌîÑ2</span>
                                  <span
                                    className={`font-bold text-right ${
                                      localActuatorStates['lamp2'] ? 'text-green-600' : 'text-gray-400'
                                    }`}
                                  >
                                    {localActuatorStates['lamp2'] ? 'ON' : 'OFF'}
                                  </span>
                                </div>
                                <div className="flex items-center space-x-2 bg-white/50 rounded-lg p-2 sm:p-3 ring-1 ring-gray-300">
                                  <span className="text-lg">üíß</span>
                                  <span className="text-gray-600 font-medium">ÌéåÌîÑ</span>
                                  <span
                                    className={`font-bold text-right ${
                                      localActuatorStates['pump'] ? 'text-green-600' : 'text-gray-400'
                                    }`}
                                  >
                                    {localActuatorStates['pump'] ? 'ON' : 'OFF'}
                                  </span>
                                </div>
                                <div className="flex items-center space-x-2 bg-white/50 rounded-lg p-2 sm:p-3 ring-1 ring-gray-300">
                                  <span className="text-lg">üåÄ</span>
                                  <span className="text-gray-600 font-medium">Ìå¨</span>
                                  <span
                                    className={`font-bold text-right ${
                                      localActuatorStates['fan'] ? 'text-green-600' : 'text-gray-400'
                                    }`}
                                  >
                                    {localActuatorStates['fan'] ? 'ON' : 'OFF'}
                                  </span>
                                </div>
                              </div>
                            </div>

                            {/* ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ */}
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2 sm:gap-3 lg:gap-4 mt-2 sm:mt-3 lg:mt-4">
                              <div className="flex items-center justify-between bg-red-50 rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border border-red-300">
                                <div className="flex items-center space-x-3">
                                  <span className="text-3xl">üå°Ô∏è</span>
                                  <span className="text-lg lg:text-xl text-gray-600 font-bold">Ïò®ÎèÑ</span>
                                </div>
                                <span className="text-3xl lg:text-4xl font-black text-red-600">
                                  {tempReading ? `${parseFloat(tempReading.value).toFixed(2)}¬∞C` : '--¬∞C'}
                                </span>
                              </div>

                              <div className="flex items-center justify-between bg-blue-50 rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border border-blue-300">
                                <div className="flex items-center space-x-3">
                                  <span className="text-3xl">üíß</span>
                                  <span className="text-lg lg:text-xl text-gray-600 font-bold">ÏäµÎèÑ</span>
                                </div>
                                <span className="text-3xl lg:text-4xl font-black text-blue-600">
                                  {humReading ? `${parseFloat(humReading.value).toFixed(2)}%` : '--%'}
                                </span>
                              </div>

                              <div className="flex items-center justify-between bg-green-50 rounded-lg p-3 sm:p-4 lg:p-5 shadow-md border border-green-300">
                                <div className="flex items-center space-x-3">
                                  <span className="text-3xl">‚ö°</span>
                                  <span className="text-lg lg:text-xl text-gray-600 font-bold">EC</span>
                                </div>
                                <span className="text-3xl lg:text-4xl font-black text-green-600">
                                  {ecReading ? `${parseFloat(ecReading.value).toFixed(2)}` : '--'}
                                </span>
                              </div>

                              <div className="flex items-center justify-between bg-purple-50 rounded-lg p-3 sm:p-4 shadow-md border border-purple-300">
                                <div className="flex items-center space-x-3">
                                  <span className="text-3xl">üß™</span>
                                  <span className="text-lg text-gray-600 font-bold">pH</span>
                                </div>
                                <span className="text-3xl font-black text-purple-600">
                                  {phReading ? `${parseFloat(phReading.value).toFixed(2)}` : '--'}
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    })
                  )}
                </div>
              </div>
            </div>
          );
        })}
      </>
    );
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100">
      {/* Header */}
      <AppHeader
        user={user}
        title="Tera Hub"
        subtitle={
          user.role === 'system_admin'
            ? user.email === 'sky3rain7@gmail.com'
              ? 'Ïù∏ÎèÑÏñ¥ Ïä§ÎßàÌä∏Ìåú ALL-IN-ONE BOARD'
              : 'ÏãúÏä§ÌÖú Í¥ÄÎ¶¨Ïûê ÎåÄÏãúÎ≥¥Îìú'
            : user.role === 'team_leader'
            ? `${user.team_name} Ï°∞Ïû• ÎåÄÏãúÎ≥¥Îìú`
            : `${user.team_name} ÌåÄÏõê ÎåÄÏãúÎ≥¥Îìú`
        }
        isDashboard={true}
        onDashboardRefresh={() => window.location.reload()}
      />

      {/* Main */}
      <main className="max-w-7xl mx-auto pt-4 pb-8 sm:px-6 lg:px-8 relative z-10">
        {/* Stats */}
        <div className="mb-4 sm:mb-6">
          <div className="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-2 sm:gap-3">
            <div className="bg-white/80 backdrop-blur-sm overflow-hidden shadow-2xl rounded-2xl border border-gray-200 hover:shadow-3xl transition-all duration-300 transform hover:-translate-y-1 hover:border-blue-300">
              <div className="p-2 sm:p-4 flex items-center justify-between">
                <div className="flex items-center">
                  <div className="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg flex items-center justify-center shadow-lg">
                    <span className="text-lg">üè†</span>
                  </div>
                  <div className="ml-4">
                    <dt className="text-xs sm:text-sm font-semibold text-gray-600 uppercase tracking-wide mb-1">
                      ÎÜçÏû• Ïàò
                    </dt>
                    <dd className="text-lg sm:text-2xl font-black text-gray-600">{totalFarms}</dd>
                  </div>
                </div>
                <div className="text-right">
                  <div className="text-2xl font-bold text-blue-600">
                    {teamsLoading ? '...' : activeMembers}
                  </div>
                  <div className="text-sm text-gray-600 font-medium">ÌôúÏÑ± ÌåÄÏõê</div>
                </div>
              </div>
            </div>

            <div className="bg-white/80 backdrop-blur-sm overflow-hidden shadow-2xl rounded-2xl border border-gray-200 hover:shadow-3xl transition-all duration-300 transform hover:-translate-y-1 hover:border-green-300">
              <div className="p-2 sm:p-4 flex items-center justify-between">
                <div className="flex items-center">
                  <div className="ml-4">
                    <dt className="text-xs sm:text-sm font-semibold text-gray-600 uppercase tracking-wide mb-1">
                      Î≤†Îìú ÌôúÏÑ±Î•†
                    </dt>
                    <dd className="text-lg sm:text-2xl font-black text-gray-600">{bedActivationRate}%</dd>
                  </div>
                </div>
                <div className="text-right">
                  <div className="text-2xl font-bold text-green-600">
                    {activeBeds}/{totalBeds}
                  </div>
                  <div className="text-sm text-gray-600 font-medium">ÌôúÏÑ±/Ï†ÑÏ≤¥</div>
                </div>
              </div>
            </div>

            <div className="bg-white/80 backdrop-blur-sm overflow-hidden shadow-2xl rounded-2xl border border-gray-200 hover:shadow-3xl transition-all duration-300 transform hover:-translate-y-1 hover:border-purple-300">
              <div className="p-2 sm:p-4 flex items-center justify-between">
                <div className="flex items-center">
                  <div className="ml-4">
                    <dt className="text-xs sm:text-sm font-semibold text-gray-600 uppercase tracking-wide mb-1">
                      Î∞∞ÏñëÏï° Î†àÏãúÌîº
                    </dt>
                    <dd className="text-lg sm:text-2xl font-black text-gray-600">{recipeStats.total}</dd>
                  </div>
                </div>
                <div className="text-right">
                  <div className="text-lg sm:text-2xl font-bold text-purple-600">{recipeStats.today}</div>
                  <div className="text-xs sm:text-sm text-gray-600 font-medium">Ïò§Îäò Ï∂îÍ∞Ä</div>
                </div>
              </div>
            </div>

            <div className="bg-white/80 backdrop-blur-sm overflow-hidden shadow-2xl rounded-2xl border border-gray-200 hover:shadow-3xl transition-all duration-300 transform hover:-translate-y-1 hover:border-blue-300">
              <div className="p-2 sm:p-4 flex items-center justify-between">
                <div className="flex items-center">
                  <div className="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg flex items-center justify-center shadow-lg">
                    <span className="text-lg">üå§Ô∏è</span>
                  </div>
                  <div className="ml-4">
                    <dt className="text-xs sm:text-sm font-semibold text-gray-600 uppercase tracking-wide mb-1">
                      ÌòÑÏû¨ ÎÇ†Ïî®
                    </dt>
                    <dd className="text-lg sm:text-2xl font-black text-gray-600">
                      {weatherData.temperature}¬∞C
                    </dd>
                  </div>
                </div>
                <div className="text-right">
                  <div className="text-sm sm:text-lg font-bold text-blue-600">{weatherData.weatherStatus}</div>
                  <div className="text-xs sm:text-sm text-gray-600 font-medium">{weatherData.region}</div>
                  <div className="text-xs text-gray-500 font-medium">Í∞ïÏàòÌôïÎ•† {weatherData.precipitation}%</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Farm Overview Section */}
        <div className="bg-white/80 backdrop-blur-sm shadow-2xl rounded-2xl border border-gray-300 overflow-hidden mb-4 sm:mb-6">
          <div className="bg-gradient-to-r from-green-500 to-green-600 px-3 sm:px-4 py-3 sm:py-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center">
                <div>
                  <h1 className="text-2xl sm:text-3xl lg:text-4xl font-bold text-white mb-1 sm:mb-2 lg:mb-3">
                    ÎÜçÏû• ÌòÑÌô©
                  </h1>
                  <p className="text-white/90 text-sm sm:text-base lg:text-lg">
                    ÎÜçÏû•Í¥ÄÎ¶¨ÏóêÏÑú ÎåÄÏãúÎ≥¥Îìú ÎÖ∏Ï∂úÏùÑ ÌóàÏö©Ìïú ÎÜçÏû•Îßå ÌëúÏãú Îê©ÎãàÎã§.
                  </p>
                </div>
              </div>

              {(user.role === 'team_leader' || user.role === 'team_member') && (
                <div className="flex items-center bg-white/20 rounded-xl px-4 py-2">
                  <label className="text-sm font-medium text-white">ÏûêÍ∏∞ ÎÜçÏû•Îßå Î≥¥Í∏∞</label>
                  <button
                    onClick={() => {
                      const next = { ...userSettings, showOnlyMyFarm: !userSettings.showOnlyMyFarm };
                      setUserSettings(next);
                      updateUserSettings(user.id, next);
                    }}
                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ml-3 ${
                      userSettings.showOnlyMyFarm ? 'bg-blue-500' : 'bg-gray-400'
                    }`}
                  >
                    <span
                      className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 ${
                        userSettings.showOnlyMyFarm ? 'translate-x-6' : 'translate-x-1'
                      }`}
                    />
                  </button>
                </div>
              )}
            </div>
          </div>

          <div className="px-2 sm:px-3 py-2 sm:py-3">
            <div className="space-y-4 sm:space-y-6 lg:space-y-8">{renderFarmOverview()}</div>
          </div>
        </div>

        {/* Recent Activity */}
        <div className="mt-8 bg-white/70 backdrop-blur-sm shadow-2xl rounded-2xl border border-gray-300 overflow-hidden">
          <div className="px-8 py-8">
            <div className="flex items-center justify-between mb-8">
              <div>
                <h3 className="text-2xl font-black text-gray-600 mb-2">üìà ÏµúÍ∑º ÌôúÎèô</h3>
                <p className="text-gray-600">Ïã§ÏãúÍ∞Ñ ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ÏôÄ ÏãúÏä§ÌÖú ÌôúÎèôÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî</p>
              </div>
              <div className="flex items-center space-x-4">
                <div className="flex items-center space-x-2">
                  <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                  <span className="text-sm text-gray-600 font-medium">Ïã§ÏãúÍ∞Ñ</span>
                </div>
                <button className="text-blue-600 hover:text-blue-800 font-semibold">Ï†ÑÏ≤¥Î≥¥Í∏∞ ‚Üí</button>
              </div>
            </div>

            <div className="space-y-4">
              {(sensorReadings || []).slice(0, 5).map((reading) => {
                const sensor = (sensors || []).find((s) => s.id === reading.sensor_id);
                const device = (devices || []).find((d) => d.id === sensor?.device_id);
                const farm = (farms || []).find((f) => f.id === device?.farm_id);

                return (
                  <div
                    key={reading.id}
                    className="bg-white/80 backdrop-blur-sm border border-gray-200 rounded-xl p-4 hover:shadow-lg transition-all duration-200 transform hover:-translate-y-0.5"
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center space-x-4">
                        <div className="w-12 h-12 bg-gradient-to-br from-blue-400 to-purple-500 rounded-xl flex items-center justify-center shadow-lg">
                          <span className="text-xl">üìä</span>
                        </div>
                        <div>
                          <div className="font-bold text-gray-600">
                            {farm?.name} - {String(device?.meta?.location || '')}
                          </div>
                          <div className="text-sm text-gray-600">{sensor?.type} ÏÑºÏÑú Ï∏°Ï†ï</div>
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="text-2xl font-black text-gray-600">
                          {reading.value}
                          {reading.unit}
                        </div>
                        <div className="text-xs text-gray-500 font-medium">
                          {new Date(reading.ts).toLocaleString('ko-KR')}
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}

              {(sensorReadings || []).length === 0 && (
                <div className="text-center py-16">
                  <div className="w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl flex items-center justify-center mx-auto mb-6">
                    <span className="text-4xl">üìä</span>
                  </div>
                  <h3 className="text-xl font-bold text-gray-600 mb-2">ÏµúÍ∑º ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
                  <p className="text-gray-600 mb-6">ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏàòÏßëÎêòÎ©¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§</p>
                  {canManageFarms && (
                    <button className="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all duration-200">
                      ÏÑºÏÑú ÏÑ§Ï†ïÌïòÍ∏∞
                    </button>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      </main>
    </div>
  );
}
